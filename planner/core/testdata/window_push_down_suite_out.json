[
  {
    "Name": "TestWindowPushDownPlans",
    "Cases": [
      {
        "SQL": "set @@tidb_enforce_mpp=1",
        "Plan": null,
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over () FROM employee -- 1. empty partition",
        "Plan": [
          "TableReader_22 10000.00 root  data:ExchangeSender_21",
          "└─ExchangeSender_21 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_19 10000.00 cop[tiflash]  row_number()->Column#6 over(rows between current row and current row)",
          "    └─ExchangeReceiver_12 10000.00 cop[tiflash]  ",
          "      └─ExchangeSender_11 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "        └─TableFullScan_10 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over (order by salary) FROM employee -- 1.1 empty partition with sort",
        "Plan": [
          "TableReader_24 10000.00 root  data:ExchangeSender_23",
          "└─ExchangeSender_23 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_21 10000.00 cop[tiflash]  row_number()->Column#6 over(order by test.employee.salary rows between current row and current row)",
          "    └─Sort_13 10000.00 cop[tiflash]  test.employee.salary",
          "      └─ExchangeReceiver_12 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_11 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "          └─TableFullScan_10 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over (partition by deptid) FROM employee -- 2. column partition key",
        "Plan": [
          "TableReader_15 10000.00 root  data:ExchangeSender_14",
          "└─ExchangeSender_14 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_8 10000.00 cop[tiflash]  row_number()->Column#6 over(partition by test.employee.deptid rows between current row and current row)",
          "    └─Sort_13 10000.00 cop[tiflash]  test.employee.deptid",
          "      └─ExchangeReceiver_12 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_11 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "          └─TableFullScan_10 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over (partition by deptid+1) FROM employee -- 3. expression partition key",
        "Plan": [
          "Projection_6 10000.00 root  test.employee.empid, test.employee.deptid, test.employee.salary, Column#7",
          "└─TableReader_16 10000.00 root  data:ExchangeSender_15",
          "  └─ExchangeSender_15 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "    └─Window_8 10000.00 cop[tiflash]  row_number()->Column#7 over(partition by Column#6 rows between current row and current row)",
          "      └─Sort_14 10000.00 cop[tiflash]  Column#6",
          "        └─ExchangeReceiver_13 10000.00 cop[tiflash]  ",
          "          └─ExchangeSender_12 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: Column#6, collate: N/A]",
          "            └─Projection_10 10000.00 cop[tiflash]  test.employee.empid, test.employee.deptid, test.employee.salary, plus(test.employee.deptid, 1)->Column#6",
          "              └─TableFullScan_11 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over (partition by deptid ORDER BY salary desc) FROM employee -- 3.1 with sort key",
        "Plan": [
          "TableReader_15 10000.00 root  data:ExchangeSender_14",
          "└─ExchangeSender_14 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_8 10000.00 cop[tiflash]  row_number()->Column#6 over(partition by test.employee.deptid order by test.employee.salary desc rows between current row and current row)",
          "    └─Sort_13 10000.00 cop[tiflash]  test.employee.deptid, test.employee.salary:desc",
          "      └─ExchangeReceiver_12 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_11 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "          └─TableFullScan_10 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, min(deptid) over w, max(deptid) over w from employee window w as (partition by deptid) -- 4. same kinds, multi function, same window",
        "Plan": [
          "TableReader_15 10000.00 root  data:ExchangeSender_14",
          "└─ExchangeSender_14 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_8 10000.00 cop[tiflash]  min(test.employee.deptid)->Column#7, max(test.employee.deptid)->Column#8 over(partition by test.employee.deptid)",
          "    └─Sort_13 10000.00 cop[tiflash]  test.employee.deptid",
          "      └─ExchangeReceiver_12 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_11 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "          └─TableFullScan_10 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, row_number() over w, max(deptid) over w from employee window w as (partition by deptid) -- 5. different kinds, multi functions, same window",
        "Plan": [
          "TableReader_40 10000.00 root  data:ExchangeSender_39",
          "└─ExchangeSender_39 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Projection_9 10000.00 cop[tiflash]  test.employee.empid, test.employee.deptid, test.employee.salary, Column#8, Column#7",
          "    └─Window_36 10000.00 cop[tiflash]  row_number()->Column#8 over(partition by test.employee.deptid rows between current row and current row)",
          "      └─Window_12 10000.00 cop[tiflash]  max(test.employee.deptid)->Column#7 over(partition by test.employee.deptid)",
          "        └─Sort_19 10000.00 cop[tiflash]  test.employee.deptid",
          "          └─ExchangeReceiver_18 10000.00 cop[tiflash]  ",
          "            └─ExchangeSender_17 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "              └─TableFullScan_16 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, sum(a) over () FROM  (select *, row_number() over () a from employee) tmp -- 6. multi window from sub query",
        "Plan": [
          "TableReader_38 10000.00 root  data:ExchangeSender_37",
          "└─ExchangeSender_37 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_35 10000.00 cop[tiflash]  sum(cast(Column#6, decimal(20,0) BINARY))->Column#8 over()",
          "    └─Window_14 10000.00 cop[tiflash]  row_number()->Column#6 over(rows between current row and current row)",
          "      └─ExchangeReceiver_20 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_19 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "          └─TableFullScan_18 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, sum(a) over (partition by deptid) FROM  (select *, row_number() over () a from employee) tmp -- 6.1 multi window from sub query",
        "Plan": [
          "TableReader_27 10000.00 root  data:ExchangeSender_26",
          "└─ExchangeSender_26 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Window_12 10000.00 cop[tiflash]  sum(cast(Column#6, decimal(20,0) BINARY))->Column#8 over(partition by test.employee.deptid)",
          "    └─Sort_21 10000.00 cop[tiflash]  test.employee.deptid",
          "      └─ExchangeReceiver_20 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_19 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "          └─Window_14 10000.00 cop[tiflash]  row_number()->Column#6 over(rows between current row and current row)",
          "            └─ExchangeReceiver_18 10000.00 cop[tiflash]  ",
          "              └─ExchangeSender_17 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "                └─TableFullScan_16 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *,  max(salary) over (), max(salary) over (partition by deptid order by salary), row_number() over (partition by deptid order by salary), max(salary) over (partition by deptid order by empid), row_number() over (partition by deptid order by empid), count(empid) over (partition by salary order by deptid) from employee; -- 7. complex",
        "Plan": [
          "TableReader_96 10000.00 root  data:ExchangeSender_95",
          "└─ExchangeSender_95 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "  └─Projection_17 10000.00 cop[tiflash]  test.employee.empid, test.employee.deptid, test.employee.salary, Column#16, Column#13, Column#12, Column#15, Column#14, Column#11",
          "    └─Window_91 10000.00 cop[tiflash]  max(test.employee.salary)->Column#16 over()",
          "      └─ExchangeReceiver_94 10000.00 cop[tiflash]  ",
          "        └─ExchangeSender_93 10000.00 cop[tiflash]  ExchangeType: PassThrough",
          "          └─Window_20 10000.00 cop[tiflash]  max(test.employee.salary)->Column#15 over(partition by test.employee.deptid order by test.employee.empid range between unbounded preceding and current row)",
          "            └─Window_24 10000.00 cop[tiflash]  row_number()->Column#14 over(partition by test.employee.deptid order by test.employee.empid rows between current row and current row)",
          "              └─Sort_55 10000.00 cop[tiflash]  test.employee.deptid, test.employee.empid",
          "                └─Window_28 10000.00 cop[tiflash]  max(test.employee.salary)->Column#13 over(partition by test.employee.deptid order by test.employee.salary range between unbounded preceding and current row)",
          "                  └─Window_30 10000.00 cop[tiflash]  row_number()->Column#12 over(partition by test.employee.deptid order by test.employee.salary rows between current row and current row)",
          "                    └─Sort_42 10000.00 cop[tiflash]  test.employee.deptid, test.employee.salary",
          "                      └─ExchangeReceiver_41 10000.00 cop[tiflash]  ",
          "                        └─ExchangeSender_40 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.deptid, collate: N/A]",
          "                          └─Window_34 10000.00 cop[tiflash]  count(test.employee.empid)->Column#11 over(partition by test.employee.salary order by test.employee.deptid range between unbounded preceding and current row)",
          "                            └─Sort_39 10000.00 cop[tiflash]  test.employee.salary, test.employee.deptid",
          "                              └─ExchangeReceiver_38 10000.00 cop[tiflash]  ",
          "                                └─ExchangeSender_37 10000.00 cop[tiflash]  ExchangeType: HashPartition, Hash Cols: [name: test.employee.salary, collate: N/A]",
          "                                  └─TableFullScan_36 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": null
      },
      {
        "SQL": "explain select *, sum(a) over (partition by deptid) FROM  (select *, row_number() over (order by md5(deptid)) a from employee) tmp; -- 8. some scalar function not supported.",
        "Plan": [
          "Projection_10 10000.00 root  test.employee.empid, test.employee.deptid, test.employee.salary, Column#7, Column#9",
          "└─Shuffle_29 10000.00 root  execution info: concurrency:5, data sources:[Window_27]",
          "  └─Window_13 10000.00 root  sum(cast(Column#7, decimal(20,0) BINARY))->Column#9 over(partition by test.employee.deptid)",
          "    └─Sort_28 10000.00 root  test.employee.deptid",
          "      └─Window_27 10000.00 root  row_number()->Column#7 over(order by Column#6 rows between current row and current row)",
          "        └─Sort_25 10000.00 root  Column#6",
          "          └─Projection_20 10000.00 root  test.employee.empid, test.employee.deptid, test.employee.salary, md5(cast(test.employee.deptid, var_string(20)))->Column#6",
          "            └─TableReader_24 10000.00 root  data:TableFullScan_23",
          "              └─TableFullScan_23 10000.00 cop[tiflash] table:employee keep order:false, stats:pseudo"
        ],
        "Warn": [
          "Scalar function 'md5'(signature: MD5, return type: var_string(32)) is not supported to push down to tiflash now.",
          "Scalar function 'md5'(signature: MD5, return type: var_string(32)) is not supported to push down to tiflash now."
        ]
      }
    ]
  }
]
