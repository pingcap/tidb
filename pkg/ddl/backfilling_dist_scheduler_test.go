// Copyright 2023 PingCAP, Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//	http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package ddl_test

import (
	"context"
	"encoding/hex"
	"encoding/json"
	"fmt"
	"testing"
	"time"

	"github.com/ngaut/pools"
	"github.com/pingcap/failpoint"
	"github.com/pingcap/tidb/pkg/ddl"
	"github.com/pingcap/tidb/pkg/disttask/framework/proto"
	"github.com/pingcap/tidb/pkg/disttask/framework/scheduler"
	"github.com/pingcap/tidb/pkg/disttask/framework/storage"
	"github.com/pingcap/tidb/pkg/domain"
	"github.com/pingcap/tidb/pkg/lightning/backend/external"
	"github.com/pingcap/tidb/pkg/meta"
	"github.com/pingcap/tidb/pkg/meta/model"
	"github.com/pingcap/tidb/pkg/parser/ast"
	"github.com/pingcap/tidb/pkg/parser/mysql"
	"github.com/pingcap/tidb/pkg/testkit"
	"github.com/stretchr/testify/require"
	"github.com/tikv/client-go/v2/util"
)

func Test(t *testing.T) {
	hexString := "7B22706879736963616C5F7461626C655F6964223A302C22726F775F7374617274223A2264494141414141414141427558334B4141414141414350614E413D3D222C22726F775F656E64223A2264494141414141414141427558334B41414141414144584A6877413D222C227473223A3435363232363137303033303236303232372C226D6574615F67726F757073223A5B7B2273746172742D6B6579223A2264494141414141414141442F626C3970674141414141442F41414154415441774D44442F4D545A684E2F38744F546E2F5A4459744E47502F4E324C2F4C57466C4E6A41742F7A4C2F4E474D775A6A6B795A502F2F4F57557A5A454A525357582F2F32396A54476C32566C502F63503979556B526E6145582F63457A2F4F4778515133662F616E52422F324E615A30622F546B6850577639346131582F6356426B576D6E2F6354442F5355686E54546B322F32622F54475269596C6F3556662F2F536E70786246524E56576A2F2F314635546D78344E54542F6450395451316C344D6C6A2F5A6A442F625842724E32502F4D304E432F31427A62572F2F4D3078485266396B4D55622F576D4658637A502F4E552F2F6230317057454A532F336E2F5A56566D56336C5652502F2F54566C3663446C4253576E2F2F32464456566C575A484C2F512F394A565768764E57502F546A442F4D5563314E6E6A2F576D73302F3164515A7A4C2F5545703654503947637A662F4E306C46636C6A2F53556A2F61554D325A315A442F33662F623039455246567661502F2F53326859565845314D6D2F2F2F7A68685A3170706347332F5266396B5347314E59576E2F51576E2F626C464B5432482F636A457A2F324635527A662F4D6E5531546638794D45722F6333464A556E482F4D584C2F616D684755324E592F33662F526C64574E6D5A4661762F2F536C52325A6B785052457A2F2F323577574768725648582F552F39425746493265572F2F6430502F57464534656A4C2F597A64732F3268325530622F543056565666394F5257662F52336C4A6130372F52452F2F55554A68556D394C2F307A2F636C523351336778552F2F2F6330354A625552585930482F2F31563256464E764E31542F65663972624868765A7A482F5446442F646E646F5458722F5A55394B2F335A555245722F55557876537638774F47762F64544E4F5232542F5A54662F6457316A646D64492F7A6E2F6346704E4E6E466A65762F2F64444E45516C644B4D58482F2F3235364F464A72576D6E2F65663834635764736344622F637A502F5532466A556D582F59576C4D2F7A4677526A482F52304E72565039575633542F555442425744582F5454502F4D573130545738342F7A4C2F537A45775446553257502F2F4D545577596D387A4D30482F2F315251595856516455582F577639574E565A445A6D6E2F6145582F593352505655622F524770532F30687A5758542F595468356166396F5455542F5A474A5255466E2F576B6E2F57564678644556512F322F2F54545A5951574A4A4D762F2F626A6B335A6D5A4761557A2F2F304E7264584661597A582F4D663978547A68434E45622F65446E2F4E56465456552F2F613074332F7A4A73646E6A2F516A64615A2F396957446E2F614656736433662F61552F2F5A486C465A3364452F7A482F615452596232467954502F2F52484A5756566C495448582F2F3252744D476C715557582F5366396F617A55304E6B372F5358722F635468445757662F6558684B2F335A48516A6A2F52486C6B4F503877526D582F59334E525655582F616A662F4F585A58526D68342F7A502F5555706F596E56574150372F414141414141414141414433674141414141416C7471304143413D3D222C22656E642D6B6579223A2264494141414141414141442F626C3970674141414141442F4141415441575A6D5A6D622F5A6D566A4F663874596A662F595459744E47622F4E574C2F4C574A6D5A4445742F7A6A2F4F5467344D5463794E2F2F2F4D4759354F476C49646A622F2F324633574864465658442F55763930554852744E6E6A2F5457502F527A6872546E6E2F4F465A6C2F326451576A482F4F5564475550387A4E33722F4D32567257474C2F636E6A2F626D49306255316D2F31442F55465A755247314256662F2F4F453932616D51324E6C482F2F3156485630746F6345762F5976387852474A58636D542F4E55482F646B395864576E2F54444A4A2F335A516556502F6555644251663932566B582F6157567761307A2F5958502F6345566851324E742F30542F575570765331597956502F2F546E5A304D3268366255502F2F33424D654774555154662F5676394B5633704F5356662F4E6D6E2F546D6470536C622F5A5670512F306848636D662F61584A615A5038335A6B4C2F524774476457332F656D502F516E4A70566D5A732F33502F566C4E355255467153502F2F656A5578533164346330502F2F7A6C46556D78725A56482F57763944633252324E58442F6545762F4F45354264484C2F54554A472F334E4A52576E2F57585668562F396D526D482F516A42306555582F6155502F65546C49593046342F324C2F64557843636B317A62762F2F57475635576E56755A7A582F2F7A6877516B6C6D4F48662F5176397A646A6C334D6B332F6233502F5A6D744E636C442F563170682F33593452456A2F53326778645039785A464C2F4E455A756347482F5A57762F5A555979593170582F31542F5648686E5631703163502F2F5A584A56636D56365232622F2F7A6434525774575346542F5A503955626D63305454662F5545622F4E5756585458662F5431704C2F31527964457A2F624641775A2F39684141442F4141414141414434414144396741414141414173484C30414341413D222C22746F74616C2D6B762D73697A65223A313537363239363832382C22746F74616C2D6B762D636E74223A313137353338302C226D756C7469706C652D66696C65732D7374617473223A5B7B226D696E2D6B6579223A2264494141414141414141442F626C3970674141414141442F41414154415441774D44442F4D545A684E2F38744F546E2F5A4459744E47502F4E324C2F4C57466C4E6A41742F7A4C2F4E474D775A6A6B795A502F2F4F57557A5A454A525357582F2F32396A54476C32566C502F63503979556B526E6145582F63457A2F4F4778515133662F616E52422F324E615A30622F546B6850577639346131582F6356426B576D6E2F6354442F5355686E54546B322F32622F54475269596C6F3556662F2F536E70786246524E56576A2F2F314635546D78344E54542F6450395451316C344D6C6A2F5A6A442F625842724E32502F4D304E432F31427A62572F2F4D3078485266396B4D55622F576D4658637A502F4E552F2F6230317057454A532F336E2F5A56566D56336C5652502F2F54566C3663446C4253576E2F2F32464456566C575A484C2F512F394A565768764E57502F546A442F4D5563314E6E6A2F576D73302F3164515A7A4C2F5545703654503947637A662F4E306C46636C6A2F53556A2F61554D325A315A442F33662F623039455246567661502F2F53326859565845314D6D2F2F2F7A68685A3170706347332F5266396B5347314E59576E2F51576E2F626C464B5432482F636A457A2F324635527A662F4D6E5531546638794D45722F6333464A556E482F4D584C2F616D684755324E592F33662F526C64574E6D5A4661762F2F536C52325A6B785052457A2F2F323577574768725648582F552F39425746493265572F2F6430502F57464534656A4C2F597A64732F3268325530622F543056565666394F5257662F52336C4A6130372F52452F2F55554A68556D394C2F307A2F636C523351336778552F2F2F6330354A625552585930482F2F31563256464E764E31542F65663972624868765A7A482F5446442F646E646F5458722F5A55394B2F335A555245722F55557876537638774F47762F64544E4F5232542F5A54662F6457316A646D64492F7A6E2F6346704E4E6E466A65762F2F64444E45516C644B4D58482F2F3235364F464A72576D6E2F65663834635764736344622F637A502F5532466A556D582F59576C4D2F7A4677526A482F52304E72565039575633542F555442425744582F5454502F4D573130545738342F7A4C2F537A45775446553257502F2F4D545577596D387A4D30482F2F315251595856516455582F577639574E565A445A6D6E2F6145582F593352505655622F524770532F30687A5758542F595468356166396F5455542F5A474A5255466E2F576B6E2F57564678644556512F322F2F54545A5951574A4A4D762F2F626A6B335A6D5A4761557A2F2F304E7264584661597A582F4D663978547A68434E45622F65446E2F4E56465456552F2F613074332F7A4A73646E6A2F516A64615A2F396957446E2F614656736433662F61552F2F5A486C465A3364452F7A482F615452596232467954502F2F52484A5756566C495448582F2F3252744D476C715557582F5366396F617A55304E6B372F5358722F635468445757662F6558684B2F335A48516A6A2F52486C6B4F503877526D582F59334E525655582F616A662F4F585A58526D68342F7A502F5555706F596E56574150372F414141414141414141414433674141414141416C7471304143413D3D222C226D61782D6B6579223A2264494141414141414141442F626C3970674141414141442F4141415441575A6D5A6D622F4D545134592F38744D7A6E2F4D444D744E44502F5957582F4C5745794F4449742F7A482F5A544A6B5A544E6D4E662F2F4E3255344D4752754E56502F2F334675614539536444482F516639545347746C596A6A2F4D58482F5A6E4A7556466A2F534649312F314E356232722F4D6D63794D6639585158582F61574E4D5247332F6546722F5A6A465A654564432F32502F55456C6F647A637A54502F2F576C705062584A595345722F2F306851643356465230332F632F395862484E484F464C2F5357482F515446755355582F4F545A4F2F7A5658627A6A2F6248684A542F394A5A302F2F4D6B315762557A2F4F55622F546C4A6E4F566C432F316E2F516A466A4E546C3551662F2F556B553359556C5952464C2F2F33647556546C5851576A2F512F3932646C4A7951336A2F5A6A4C2F546C4233626A502F576C63792F336378616B662F4E326C6E64663971516C502F546A4A72516B4C2F526A582F5247524B4F586F7A2F7A482F65474A4C4D6A5A6C4D662F2F55446478596C59324F556E2F2F3078336444597A4E6A482F576639355A553577536D6A2F5456722F5130686B62456E2F516D46482F30525264322F2F526C5273532F38306244542F4E4667785756582F6147582F646C5A454D4656792F32502F615574516430395363502F2F556B744565454632646D7A2F2F7A5931566C4E4552326A2F635039525A445247616B332F626D662F596C5658626C502F556C4E472F334E4A5A31722F646E56334F5039585655762F4F5441795447372F55572F2F5233687861316F312F30622F634746744E30313152762F2F65476730645864454D552F2F2F32685A62577478626D722F617638795557397362476E2F526A502F61544E585446582F4E6D4E582F33684B516D6A2F4F564E305550383162557A2F555735545633582F4D6D6E2F536E644652454A722F31542F5447395259555A3152662F2F636D55355644563057477A2F2F316C6C636E526C54326E2F6266394A5A6C52754F47582F53576E2F614539365654442F4D31684F2F3278615254442F545646475A76396F566B332F646B52595745762F546E502F567A64514D6B78482F30542F533352505247703555662F2F54585A594E327869576E722F2F3155315A5668754E6C622F5350387862556C475447502F616A662F635670724E32372F4D7A59352F3078695330542F53566C4C542F3959526D372F4D6D6C6E597A582F636A542F4D577445636C5A4B2F32372F566B777A5A446B7859662F2F54577857636B744A57576A2F2F323135516A644A4E33502F62763958596B3559547A482F6254622F654531795255762F4E3052442F31683463306E2F4E564E756550393165444C2F4F444A30636D7A2F556B722F5932314E4E3346522F30372F624645304E586B334E662F2F57464A535A315A61546C722F2F7A56425331644A5432722F616639564D486B344E44502F64466A2F63324E46516D7A2F536E42562F3235785656502F575842424E503978546C442F643052565254582F626D622F646D74754F5564582F30582F63555A785A305259642F2F2F64484A5454474A47526D6E2F2F335A4E4D55397462444C2F632F39735657647054307A2F4D7A6E2F4F584A4B626A442F5A3274482F30706D55307A2F536B35335776383459306E2F516D784C646A502F4F47582F623078525A586C512F32582F566D31684D6B74315A502F2F63546C36527A526F556D542F2F335A6A544552306544542F4E66396D6155314353456A2F6244662F516C526F6147662F613064342F31553554466E2F6131637A5A76393253326A2F52556C545248722F4D6D762F556C553465474A6D2F327A2F56444A795930566E57762F2F4E46704A4E6C52306130622F2F315A46636B78736230722F5266396C595642774D456E2F536C722F5A55394B5130542F64546C492F33564D51584C2F5A46644A4E7638796356482F6455704D5A6B502F6348542F62446C34556A42352F30502F57576C4B535751354E662F2F516B3034634559335533542F2F7A6C54626E593059314C2F6350396F556E566A5A586A2F556E722F523142685258542F616B4D342F7A4E6E646A6A2F4E487074656639695454582F55314E544F55622F4F48482F4E6B4A77533152722F316E2F54454A79546D526F4E2F2F2F54464A47634756705357372F2F3370596545567A4D44442F642F39724E3231494E546A2F5446622F566C59334F577A2F614446352F3168765432482F64564671617639706447482F4F574A705547762F5A7A6A2F5545497A576C466A2F324C2F59336C735345787863762F2F5445684B6547394B4D6A482F2F30457764566777576B542F6476394C4E7A4E465655662F5533502F65476F7A646C542F62304E302F3274754F56502F4E57307A532F39724D55332F536D52754E56502F6357372F61453953644446422F31502F5347746C596A677863662F2F5A6E4A7556466849556A582F2F314E3562326F795A7A4C2F4D6639585158567059307A2F5247332F6546706D4D566E2F654564432F324E5153576A2F647A637A54503961576B2F2F62584A595345722F5346442F643356465230317A2F31662F62484E484F464A4A59662F2F51544675535555354E6B372F2F7A5658627A687365456E2F542F394A5A3038795456622F62557A2F4F555A4F556D662F4F566C432F316C434D57502F4E546C35516639535254662F59556C5952464C2F6432372F56546C58515768442F33622F646C4A795133686D4D762F2F546C4233626A4E61567A4C2F2F336378616B63336157662F64663971516C4E4F4D6D762F516B4C2F526A56455A45722F4F586F7A2F7A4634596B762F4D6A5A6C4D6639514E33482F596C59324F556E2F5448662F6444597A4E6A465A2F336E2F5A553577536D684E57762F2F5130686B62456C435955662F2F3052526432394756477A2F532F3830624451305744482F5756582F61475632566B542F4D4656792F324E705331442F64303953635039535330542F65454632646D7A2F4E6A582F566C4E45523268772F31482F5A445247616B31755A2F2F2F596C5658626C4E535530622F2F334E4A5A3170326458662F4F503958565573354D444C2F5447372F555739486548482F61316F312F305A775957332F4E303131527639346144542F645864454D552F2F61466E2F62577478626D70712F7A4C2F5557397362476C474D2F2F2F61544E58544655325931662F2F33684B516D67355533542F5550383162557852626C502F5633582F4D6D6C4B6430582F52454A722F31524D6231482F59555A31526639795A546E2F5644563057477A2F5757582F636E526C54326C742F306E2F5A6C52754F47564A61662F2F614539365654417A5745372F2F3278615254424E5555622F5A76396F566B313252466A2F5745762F546E4E584E31442F4D6B78482F30524C64452F2F524770355566394E646C6A2F4E327869576E722F5654582F5A5668754E6C5A492F7A482F62556C4754474E714E2F2F2F635670724E32347A4E6A6E2F2F3078695330524A5755762F542F3959526D34796157662F597A582F636A51786130542F636C5A4B2F3235575444502F5A446B785966394E4141442F4141414141414434414144396741414141414171564B414143413D3D222C2266696C656E616D6573223A5B5B223133322F3330303030332F32363633653737312D376265342D346430622D386237622D3563633939623334383162662F30222C223133322F3330303030332F32363633653737312D376265342D346430622D386237622D3563633939623334383162665F737461742F30225D5D2C226D61782D6F7665726C617070696E672D6E756D223A317D2C7B226D696E2D6B6579223A2264494141414141414141442F626C3970674141414141442F41414154415441774D44442F4E444131597638745954482F4F574D744E44442F4D6A542F4C5745334E474D742F32502F4E5745344E6A646B4E662F2F4D6D49325A456C6B4E30482F2F7A4A4C4D55356C5754622F54763833614556425757542F64584C2F575664344F44662F55544D322F7A56536545622F6247566B622F397352476A2F5A7A52476257482F526A542F5245467A647A4E452F7A482F5544524B646D39424D662F2F61334E5561446B354E6D502F2F336C43525852764F55372F565038354E5552425258442F4D31502F59314A72616E6A2F527A646C2F7A68434F55622F5655383551663977566B482F536D35524E7A662F656A4C2F59315A6B5A6B4E452F7A542F5A555277566E4E47612F2F2F5757317751574E33556D722F2F3256715A4545345557332F5A76396F62444A695A30482F546D622F5A4756476356502F623070432F334657576D4C2F516C64616450396F4D47722F546B4A6C526D7A2F626A582F4E315272596B68552F32722F6457314455586C5956662F2F5A6B3948517A5A53566D762F2F316444574774734D336E2F646639685A4539566148722F6230542F59584A325556622F4E6C52492F314A694D6E622F627A4279562F393051556A2F4E3064555A33442F636C442F655768595655396C2F322F2F6147466F656C565864662F2F566D316A4D3278684E6C582F2F3046314E544E735430332F5176396C636B673561586A2F64334C2F596E4D325631542F647A426B2F7A52325A452F2F57475657542F396951552F2F54484E435346442F6232502F536C4261545556452F31542F526E424E576D307751662F2F624778304F48704B5544482F2F7A6C6F5A45527862557A2F6250383155326B326557622F4D6D6A2F63445A726146482F5A3370522F3056785746582F615564314D5039356430482F4D46527857486A2F576A6E2F4E316F32645764302F7A582F54466C50576C524C59662F2F4E5531775957396F61456E2F2F303435516D3133616E722F536639684D464E445656662F5257662F627A45345155762F656C42752F316852656A582F4E3059345A2F395162454C2F516B6C325A30372F62456A2F4F58524B4E564A482F32762F616A5A71635574485A762F2F536B7035526C5A505A44622F2F323533533074735455332F5350397755334A4C4F46502F4D6D762F4E6B30314D6D2F2F4F5746762F33427552304C2F6156424F592F38784E326E2F52324E54566E482F4E572F2F64315649613230782F7A442F6231647156456C4D63662F2F4E6B4E4D535868476332482F2F315A4A63544A455433542F557639364D453947546B582F4F55482F55574A31616C6E2F534735302F7A42494F454C2F63586442536639735444442F6357527A5431622F4F55332F4D324E68636C42782F32582F4D4568346547646161662F2F6432565A4E6A6C51567A542F2F304530597A52595932762F57663957636D39556157372F5A32582F6145526B6545582F617A6C692F30316D6454442F61545A754D763936636C502F546B52564E44542F4F46482F65545934596A56532F31662F6454524755566831592F2F2F5456565063304A715A31502F2F7A5273656D4E6A537A502F5776396B536C646D566E502F64576E2F615642544E574C2F4E6D78702F3049305A324C2F54466F32516639774D58582F643074705531722F6447722F596B56324F476C732F7A622F4F564D335546466163502F2F576E4E57596B6C555230622F2F3274324D5855346431502F522F3970646D31616332662F59576E2F624870716355482F4D5456312F7A4E6B5931582F52316F356150395661466A2F516C4A616345622F5758442F5548564D4E5455772F30622F525867354E58526C532F2F2F5332564F4F4870795931502F2F7A42724F575A4F616A502F4E2F3933516D55316445622F6156722F56456C565254482F62484E5A2F334648516C622F5A6E4E345A2F394F6545722F5A6D74574F55372F566C442F625738345A4546722F30482F6147745765445535622F2F2F4E554A4863574E535430722F2F7A46314E566C52596C542F55763833646B30325756622F4E457A2F62577872576C6A2F4D3168482F3073316456722F4E473547636639596245662F543074686457372F5532502F626D46335A585A4F2F33622F4E6B7832536B4D324E762F2F4D4770775632786A656D622F2F31703252485A525A33582F616639475A335632526C442F646B482F5A3355335630332F596C4E772F3070595546542F655852794E5039505447482F52334A316358442F51584C2F4F575647543068332F306A2F5757704B596B67355A662F2F55464646535652764F57582F2F3268484F4864346545332F4F6639355A314A69566E722F5377442B4141414141414436674141414141417A4C554D4143413D3D222C226D61782D6B6579223A2264494141414141414141442F626C3970674141414141442F4141415441575A6D5A6D622F5A6D466A4D76387459574C2F596A55744E44442F5A446A2F4C546B315A6D4D742F7A582F5954646C4E575A6A4E662F2F5A6A49314D46424752546A2F2F334E584E45394C64566E2F552F394F546C4245626C442F5A6A6E2F4E5652535430622F5A3068592F7A453162456E2F655546574F50394E646B7A2F4E6A4A6A5448722F5955582F625642524D3149782F30332F575751785655394D4F502F2F5A6D6C6A615456706230372F2F7A687953574E31567A542F6250397753304E43546B6E2F4D44582F595468485532582F516C68502F314E3463456E2F626D467A61503975537A542F57585A445932762F546C442F654668695A5568702F32502F63445A6A5932357957762F2F576C4E6A527A42795155582F2F326F34625752695457372F53663831517A4A596432482F6432372F4F464E546430542F52304A362F30526C6356442F566B646C53763948566D722F6245746D636A6E2F62466E2F656B467A656B6B782F306A2F63314669516B526B63502F2F4E32784E6347783264544C2F2F31564452585A726248502F555039365A453835536E442F4F48582F636D684B656E6E2F656D6B312F32744756316E2F65484A55567638785445762F56484D324D6C482F597A542F65546853625756342F33502F533246596433645465502F2F4D32383264465669516C4C2F2F31465953455A6B6156662F547639785558684B636E502F5954542F5748566B5657332F53336C342F334A365645582F63303978527638324E476E2F4F4441785258482F537A662F617A684B616D46332F32582F526A6C424D6D7847622F2F2F567A42745245637A6257582F2F30705A4E474E5A647A542F647639485A6D6C51626D722F4E6E6A2F534456704E554C2F633152582F7A6C524E336E2F555449774E663951516B662F563052335957482F62552F2F4E47684853324E452F31442F554646725457356B52762F2F4E54526A57574A4755334C2F2F32747A61464A4763564C2F622F396C6345646F55464C2F5A46442F5A484A535130332F5A32387A2F334E55556A482F54564A69532F39716248482F557A4E4C61476E2F5748722F596B4535595646342F31502F636D31436158644E4D662F2F55465A5355474647536D332F2F334E55536A49305357502F6450394853554A365246442F6133482F56455A744F466A2F593078552F304E6E516D582F53564533557639445531442F55454A365456582F4D334C2F596C6C44556D39682F33542F54466459596E5A58552F2F2F4D6A6C4B53445653557A6E2F2F314E4D56445A535356502F542F3970557A644864552F2F5357372F52577052566C582F564451792F7A6C465331622F4D574E6854663877636D542F52464E42646C542F53304C2F4D5864355A6E4E792F30502F545642725633493153762F2F56566854564770506558502F2F30394C4D5578325457722F5676394455464E30546C582F51334C2F4E5552465230542F553039612F304E4D6354582F59337077656639535331582F4D6E6C7153572F2F63316A2F596E564E4E5549322F316E2F6357465552465A5357762F2F5A31646F4D5846735533662F2F7A68735646464D5A6D7A2F5250395463465577576A442F52572F2F546B78315133442F576E6B322F3164475630722F55454A766266394864314C2F536D68515547502F547A4C2F5932354C544664422F314C2F656B56575A574A6F4F502F2F5A553149546D74365230582F2F306857543268505357622F612F3951537A41784D6E442F6548622F59336B30646D372F64584D352F307430576B482F636B3169566639355248542F54465A4B6446482F5A30542F5254564752554A452F33502F593031685A45783557662F2F4F4856474E584276616A582F2F7A566A4E4842435554542F53663877656B6B35526B2F2F55326A2F4D484A335A556E2F4E44565A2F7A63795348482F516E4253612F3877556D542F5155684F64444C2F5A466E2F54474A4C515668542F7A542F53334A6A517A6C455A502F2F5A334672655731524F48502F2F304E58626B6876576B662F6150394F55575A30526B2F2F536D2F2F5248707A65456E2F54306C742F30744A5233582F553168335966394E53314C2F6348706F6345582F656A6E2F5A576C35517A4A4E2F33542F4E573946546E5A6D51662F2F62557873553070435355622F2F7A6C4964324A56556B762F6250396E554756356246482F5A7A582F515564335630502F59564A492F304A464D57722F4E45316D5750394F556E6E2F557A5A795655542F6130542F5A556F77567A597A2F33482F6554426B51546C3057762F2F4D6C59784D48424B5558622F2F30786F56314A515255502F5650395961444A5861457A2F516D582F596D68456156502F4D566C702F3341786447482F52565A6F5A2F397653452F2F5356424752546A2F6331662F4E45394C64566C542F30372F546C4245626C426D4F662F2F4E56525354305A6E53466A2F2F7A453162456C355156622F4F50394E646B77324D6D502F5448722F595556745546482F4D3149782F30315A5A44482F5655394D4F50396D6157502F615456706230372F4F484C2F53574E31567A52732F33442F53304E43546B6B774E662F2F595468485532564357452F2F2F314E3463456C755958502F61503975537A525A646B502F5932762F546C423457474C2F5A5568702F324E774E6D502F59323579577639615532502F527A42795155582F616A6A2F625752695457354A2F7A582F517A4A596432463362762F2F4F464E5464305248516E722F2F30526C635642575232582F53763948566D70735332622F636A6E2F62466C365158502F656B6B782F30687A55574C2F516B526B635038336245332F6347783264544C2F5655502F52585A7262484E512F33722F5A453835536E413464662F2F636D684B656E6C366154582F2F32744756316C34636C542F5676387854457455637A622F4D6C482F597A52354F464C2F625756342F334E4C59566A2F643364546550387A627A622F64465669516C4C2F55566A2F53455A6B6156644F2F33482F5558684B636E4E684E502F2F5748566B5657314C65586A2F2F334A365645567A5433482F527638324E476B344D44482F5258482F537A64724F45722F616D46332F3256474F55482F4D6D7847622F39584D47332F5245637A6257582F536C6E2F4E474E5A647A52322F30662F5A6D6C51626D6F3265502F2F534456704E554A7A5646662F2F7A6C524E336C524D6A442F4E663951516B64585248662F5957482F625538306145662F53324E452F3142515557762F5457356B527638314E47502F57574A4755334C2F6133502F61464A4763564A762F32582F6345646F55464A6B55502F2F5A484A535130316E627A502F2F334E55556A464E556D4C2F532F3971624846544D30762F61476E2F5748706951546E2F595646342F314E7962554C2F6158644E4D663951566C4C2F55474647536D332F6331542F536A493053574E302F30662F53554A365241414141507A2F41414141414141414141443367414141414141797358454143413D3D222C2266696C656E616D6573223A5B5B223133322F3330303030332F66393838346166332D656230342D343262342D623637332D3062643431353762646637652F30222C223133322F3330303030332F66393838346166332D656230342D343262342D623637332D3062643431353762646637655F737461742F30225D5D2C226D61782D6F7665726C617070696E672D6E756D223A317D2C7B226D696E2D6B6579223A2264494141414141414141442F626C3970674141414141442F41414154415441774D44442F4D3259354E7638744D44662F4E7A41744E44442F4E7A582F4C546C695A6A49742F7A442F5A57453159574A6B4E502F2F4E4749784D474E4F4E55662F2F30395A593363336248502F52763957566A64696433722F646D4C2F4D335A6155324C2F61565A4B2F315246536A622F5531646152503979636B332F5233644D516D6A2F616C6E2F646D4E6D4D3252612F30502F626D684A5358687851662F2F5757746F64586830576C442F2F324E305A3230314D574C2F4D76396952445A73636B7A2F5457332F53325670547A502F513264342F3352345A6D722F593149345A503961636A502F536B35355757502F556A662F4E6E4E6151306C492F33502F595577315130396A61662F2F5232565A63474D7A5A7A482F2F324A46616D6C784D46582F536639365A6A46445933502F5548442F62444E68646D2F2F62474E4B2F3278365347332F55456430632F397056566E2F525731505556662F636A622F535656724E4468502F7A622F5A6D56444D7A427264762F2F63486C346445745752454C2F2F7A4D7961454A4F5744482F576638775558565055306E2F6247722F645856595544542F53465A6E2F7A5A4A5A466E2F54585A795666397354336E2F576B316D536A442F566B4C2F536B56504F5731582F7A662F5745357465544A4255662F2F4F585A4A62554E5464336A2F2F314E6F51574E776430662F622F3948626D5A4C5256622F4D30722F626C6861626E582F557A5A7A2F325A565247332F54324A42647639474F57762F5A6D77306131662F4E46502F54335135656D46742F7A622F5155646B566B5A5459762F2F527A42314D316B336255372F2F7A6733616B4A43636B542F6176395661564D795357372F56572F2F4F465A694F48622F556D56462F30394D4E30662F596C55325266395856304C2F63323135616C482F656E482F5A58644862315A6C2F304C2F546B6471557A633157502F2F624456344F4667345630722F2F3056505A6B70305A54622F616639596556683053316E2F656E622F63474E785756442F616C6F302F305579556E6E2F56565258622F39685255502F616D6C545558722F4D6E4C2F65455A5754484A302F32332F55556848576D464651662F2F55304E7755304E5353576E2F2F3356486430565363572F2F6566393655484E766430662F4E6C722F5955354D61457A2F59544D792F7A566A5232582F576C467A6250394F5A46502F5A54553555327A2F6156442F54544A32555564362F324C2F4E484E7A5358705255662F2F4E47394256486C4C4D557A2F2F3370345A6D70344E32542F4F663976566A5133546C622F6544502F6144526B54572F2F565464492F334A304F54582F634445345976397064326A2F646C49355446662F4F484C2F645756475A325A562F7A442F647A56435231683152662F2F62576C555333706B646B582F2F314E49553356596144662F6250396F624559315754662F52456E2F4D326C6B6257372F64474E532F3277345344582F555530786376394E616C442F6158527661446E2F616C662F647A5246565455352F30482F4E487073576B6C4951762F2F5A5568314E464E774D557A2F2F316459596B45315A47372F6266383061475A69516B4C2F61576A2F4E48646E6555582F6148426A2F3146446356502F613352345776397656302F2F6432463662446A2F53456E2F6230704A634564792F31482F53575245646B395153502F2F65475A5A5757686C64302F2F2F326C7761325A474E6B502F5A763948567A4E505931582F616B4C2F5230564E4F57482F4D6C67302F324E575256622F63574E4861663973537A502F516D64776354442F6154662F625846596555526C2F32372F646C6C47546D645252662F2F6248673561307074536E722F2F31553453475A496146542F522F395753306431566A582F61546A2F4D5751345A326A2F615442532F7A5A73546C442F5931706C656638325430542F656E52774D546A2F5A6D722F526D4E50576D6B782F31542F5245317451336475552F2F2F6257314F525667334F56442F2F334E35566C42795756622F542F39504E485A7A56477A2F4E7A442F625734305433622F615456482F325A345746442F57564D305A6639355255762F55576B305A33542F526C442F556C5A5A55325A772F30372F646C64495158686E532F2F2F596E644A536D565155457A2F2F30703261476C785332332F532F396B4D4545784E44502F5954582F565734344E31482F566B4D302F3235366155542F616E5A59622F3977627A582F63573954556B6A2F536E542F526A644852476B302F7A542F546D4E4A54304E4551662F2F56564258546D78514D57332F2F30786A515539445A47332F5550383159574A765455542F5354662F6248705A51577A2F53574A332F3278455A6D482F566A6C736550395964316A2F52474E4F4E55662F54316E2F5933633362484E472F31622F566A64696433703259762F2F4D335A6155324A70566B722F2F315246536A5A545631722F52503979636B314864307A2F516D6A2F616C6C325932622F4D3252612F304E7561456E2F535868785166395A61326A2F64586830576C442F5933542F5A3230314D5749792F324C2F52445A73636B784E62662F2F53325670547A4E445A336A2F2F3352345A6D706A556A6A2F5A503961636A4E4B546E6E2F5757502F556A63326331722F51306C492F334E685444582F5130396A616639485A566E2F63474D7A5A7A482F596B582F616D6C784D46564A2F33722F5A6A464459334E5163502F2F62444E68646D39735930722F2F327836534731515233542F632F397056566C4662552F2F5556662F636A5A4A5657762F4E4468502F7A5A6D5A55502F4D7A42726476397765586A2F6445745752454C2F4D7A4C2F61454A4F5744465A2F7A442F5558565055306C7361762F2F6458565955445249566D662F2F7A5A4A5A466C4E646E4C2F5666397354336C615457622F536A442F566B4A4B52552F2F4F5731582F7A6459546D332F65544A4255663835646B6E2F62554E5464336A2F55326A2F51574E77643064762F30662F626D5A4C5256597A53762F2F626C6861626E56544E6E502F2F325A5652473150596B482F647639474F57746D6244542F6131662F4E464E5064446E2F656D46742F7A5A425232542F566B5A54597639484D48582F4D316B336255372F4F44662F616B4A43636B52712F31582F61564D7953573556622F2F2F4F465A694F485A535A55582F2F30394D4E3064695654622F5266395856304A7A62586E2F616C482F656E466C6430662F62315A6C2F304A4F5232722F557A6331575039734E586A2F4F4667345630722F52552F2F5A6B70305A545A702F316A2F6556683053316C3664762F2F63474E7857564271576A542F2F305579556E6C565646662F622F396852554E716156502F5558722F4D6E4A34526C622F54484A302F3231525345662F576D4646516639545133442F55304E5353576E2F6455662F64305653635739352F33722F55484E766430633257762F2F5955354D614578684D7A4C2F2F7A566A523256615558502F6250394F5A464E6C4E546E2F55327A2F6156424E4D6E622F555564362F3249306333502F53587052556638306230482F56486C4C4D557A2F656E6A2F5A6D70344E3251352F322F2F566A5133546C5A344D2F2F2F6144526B545739564E306A2F2F334A304F5456774D546A2F5976397064326832556A6E2F5446662F4F484A315A55622F5A325A562F7A42334E554C2F52316831526639746156542F5333706B646B582F55306A2F55335659614464732F326A2F624559315754644553662F2F4D326C6B6257353059314C2F2F327734534456525454482F6376394E616C427064472F2F61446E2F616C64334E45582F565455352F304530656D7A2F576B6C495176396C5348582F4E464E774D557A2F56316A2F596B45315A4735742F7A542F61475A69516B4A7061502F2F4E48646E6555566F6347502F2F31464463564E7264486A2F57763976563039335958722F62446A2F53456C76536B6E2F634564792F31464A5A45542F646B3951535039345A6C6E2F5757686C64302F2F6158442F61325A474E6B4E6D2F30662F567A4E505931567151762F2F5230564E4F5745795744542F2F324E5752565A785930662F61663973537A4E435A33442F6354442F6154647463566A2F6555526C2F3235325755622F546D64525266397365446E2F61307074536E722F56546A2F53475A49614652482F31622F53306431566A56704F502F2F4D5751345A3268704D464C2F2F7A5A73546C426A576D582F65663832543052366448442F4D546A2F5A6D704759302F2F576D6B782F3152455457332F51336475552F39746255372F525667334F56442F63336E2F566C427957565A502F302F2F4E485A7A564777334D502F2F6257343054335A704E55662F2F325A345746425A557A542F41503441414141414141443567414141414141776550554143413D3D222C226D61782D6B6579223A2264494141414141414141442F626C3970674141414141442F4141415441575A6D5A6D622F5A6A4D355A7638744D6D4C2F596A67744E44662F4E7A542F4C574A6B4E5445742F7A502F4D4751794E4459344D662F2F4D4463315A6A684D4F47372F2F316C56636A6C585345372F5566395662314A79636D762F5344542F5A5859784E44442F616B31752F304658626D4C2F53555A50626639505358502F54465A47516A4C2F536E662F4E3145794D4531722F327A2F53484249556C644F59762F2F5547784851566C4A636C662F2F3364564D6D46465A58662F65663961525668365332482F52334C2F574778696233662F647A4E6E2F304A494F47722F5258707955503948596B7A2F626E41355232332F537A6E2F5532567761564A6A2F30622F4F446C366145646D63502F2F627A4672566B3834526C722F2F334D315645395052577A2F517639554D4749305547372F6133442F54584E546155482F53485A562F33686955336A2F64334D324F5039756347372F52544E6C6557542F596B542F65584A4F645735712F32482F555446546245527053762F2F613045776247356D526E582F2F3034775256464464307A2F4D663968635768774D54442F6357482F556A51786132332F636C42532F3278445454622F4D3246444D2F38324D466E2F646D59326230372F6256482F5157316B6456646D2F326A2F56564E505444525461662F2F6454686D556B4E4455316E2F2F7A466C4D6D7859656D762F6466396A5A454D325A6E6A2F646C542F6558466A53304C2F545868582F3031684D7A482F4E334E44647638336548582F556E644F54322F2F566D7A2F4E31525663315A7A2F307A2F535564565A546C485A762F2F6248684B575670305132482F2F306876623034355233442F617639345A575634536A6E2F5354662F544446366131502F4D6A6C592F3349775256542F576D4577577639694D56542F546D45785354622F616C502F5446463265454E332F30722F55575A4A596B527455762F2F616E5A51625846736446482F2F32703661465A776358502F4E2F38354E3352785545502F54554C2F646E4E3262584C2F5A466C362F3164495132372F576D6C765250394B55446E2F4E566C305255502F556C582F566B6C4F524646712F33622F646C4634523064334E502F2F596E64474D44633253556A2F2F7A5642596D4E475256482F4E66393353575677626B332F63556A2F54546C4F6332372F645538302F33424D646D6A2F644851774D6639356457662F654655324D7A622F52456E2F616A6C78566D63322F326A2F4D486C695532525753662F2F4E6C5231566C566E5357762F2F7A68355A326C526330332F6276397052484275546A6A2F5431622F5530464A5758502F4D586B332F325A335746502F4E7A5932645039755247332F643068305645762F5656502F5A456C6C63456C692F336E2F5357317A646C4D33622F2F2F656B453461464D31546A482F2F3074714D32563455444C2F522F3958626D52595245502F4F55542F4E5852315A546A2F646B5A532F3168725747372F523142346350396852446A2F564442775532582F54456A2F63545A446232566A2F31542F597A52544E33567755762F2F596C67795A57524A61566E2F2F305935616B46596255622F4E5039506345745161304C2F5647542F615664494E7A482F516C424A2F334A515356482F4E30566E5366396D6556482F4F564A76596A6A2F5244502F5231644D626D464E2F336E2F646B4931656D4A5954762F2F56414141414141414141442F2B4141414141414141414434674141414141416C502F344143413D3D222C2266696C656E616D6573223A5B5B223133322F3330303030332F62343562373931352D383237382D346664392D623234382D6632333237306563636431642F30222C223133322F3330303030332F62343562373931352D383237382D346664392D623234382D6632333237306563636431645F737461742F30225D5D2C226D61782D6F7665726C617070696E672D6E756D223A317D2C7B226D696E2D6B6579223A2264494141414141414141442F626C3970674141414141442F41414154415441774D44442F4D6A6B775A7638744E324C2F4F4745744E444C2F5957482F4C574A6B5A6A51742F32582F5A4451794D5456695A502F2F5A4467315A6E645259334C2F2F33466E546B4A565430372F575038346557686A53474C2F51577A2F565770574F44502F4F454E512F3368365154482F4F56686A4D503879546B332F554764685131542F6146482F4D317056536C4E612F30372F54454A75516A6C79592F2F2F5632526A52336733527A502F2F314E30563363345532622F5166395A543239486246442F5445762F596E46795330662F526B78302F7A42756158622F5247464D59663977566D6E2F566B7036566E622F566D482F56565A33566E526A2F33442F63474A76554659335A502F2F616A683553456C786146442F2F324531646A593554456A2F6466394A63545279576E502F546D582F55556C576458722F4E6B4E702F327778546C6A2F65545279542F3969626C622F5344684E516B662F616C722F4D544648596B6F782F31542F52324A4A4F45395959762F2F4E477059576C6332536D372F2F304A6C6344563263456A2F555039364E574D784D30582F55576E2F4F564E72646D372F4F55467A2F3039334F58502F637A5669577639486146722F5255686D5333722F626B762F4E3231525957704F2F32662F534770495A57393161762F2F546B74586256553461584C2F2F7A4E314D46644D5755582F5250395162545A425A33442F6331622F6544685755556A2F5A6C64732F30466B516C722F516B6874625039705432332F56306C725931662F6348542F536A4131536D68572F306E2F636B644265474644592F2F2F524539504E335A445656722F2F7A4A554F5846746154622F542F387764335A325432542F5A6E4C2F4D566C44526C6E2F524456472F33526E53336E2F55304A365566396C5A55482F4D6B70756331662F4F58622F5133593262544E502F30502F545670474F5568475A502F2F635546585248645052476E2F2F326331556B5A496430502F5266393152556330576B4C2F5A54442F624642524E55482F62574A462F3270436247542F53554670527639515744442F643074725A576A2F6155662F4D584E4355544A482F7A542F4E6B6C525A55565665502F2F5355525655485A6C4D6B622F2F3346785A7A4A6C4D32582F61663969565464684E6C622F556C582F52555A744D47542F4F47387A2F303558576A6A2F59544535596639596431482F646A6C425345722F4D55582F59315135596D6C4F2F326A2F55444269526E427861662F2F536E52466332513463576E2F2F7A5A6D556C6C496157662F537639425A566C764D44482F4F44482F63555A616230542F596D394A2F7A5A33526C662F545852585566396F54566E2F4E54463351556E2F55576A2F5531687A4E5852422F316E2F6545466F626D707565662F2F5357396A4D58465362546A2F2F31647055327451616A482F54503877634552745630622F636D4C2F4D6B706B656E582F546D35522F32784F57484C2F54486C55567639585547762F61475630616B582F516D4C2F52324E61596E64562F7A662F4F4735434F56524463502F2F5630683254564A70626A502F2F323161616B5676536D6E2F6466387A645768355655332F646D482F4D6E46305930332F4F46646E2F334A575655582F515842474E663979526B722F57566C7864546A2F59566E2F555663775A46564C2F7A542F52334A484F575A695A762F2F55314644525646574D484C2F2F327874593170514F546E2F65503959613270526457332F5258502F4E46466C4E6C662F6247644E2F33426862552F2F543231324D7639594F457A2F645574304D54662F63314C2F54446778655764612F33542F4D3342514D5570304D2F2F2F53553973576C59774D45722F2F304643614464325554502F5966394953585A565533622F4F556E2F65576C3459586A2F62306C702F7A4E6E5254502F64457074532F396E5A557A2F56475257656D7A2F546D6A2F646B64716131706B2F334C2F55455A4D5255467757662F2F5131706154475256597A6E2F2F3341335131424D4E32662F5776394A55566F79576D482F6346502F54305A364E31662F536C4A4F2F325A5659576A2F646B5932645039554D6E442F64315934576B482F5133442F566B4E6D525656512F324C2F4D5845775455466D64662F2F636B34345533524B546D542F2F334A315A6A5A336254442F6576396E63456C365A546E2F517A622F64444A715A32332F4D4864332F306852656D4C2F4F486C33656638304F57662F5A45785357466A2F5932372F55584A77626D68492F32542F4E4652796132557A622F2F2F62335A5963326B774D54622F2F336846536A6B304D454C2F625039615A6B7448656C4C2F6445542F51307836616E442F593274362F7A59786547622F62545657647639345632622F6433645259334C2F6357662F546B4A56543035592F7A6A2F6557686A53474A4262502F2F565770574F444D345131442F2F336836515445355747502F4D503879546B31515A32482F5131542F6146457A576C582F536C4E612F30354D516D372F516A6C79592F39585A47502F52336733527A502F5533542F5633633455325A422F316E2F543239486246424D532F2F2F596E4679533064475448542F2F7A427561585A4559557A2F59663977566D6C57536E722F566E622F566D4656566E662F566E526A2F334277596D2F2F554659335A5039714F486E2F53456C786146442F5954582F646A5935544568312F306E2F63545279576E4E4F5A662F2F55556C5764586F3251326E2F2F327778546C68354E484C2F542F3969626C5A494F45332F516B662F616C6F784D55662F596B6F782F315248596B6E2F4F45395959763830616C6A2F41414141414144364141443967414141414141742B77494143413D3D222C226D61782D6B6579223A2264494141414141414141442F626C3970674141414141442F4141415441575A6D5A6D622F5A6D566A4F663874596A662F595459744E47622F4E574C2F4C574A6D5A4445742F7A6A2F4F5467344D5463794E2F2F2F4D4759354F476C49646A622F2F324633574864465658442F55763930554852744E6E6A2F5457502F527A6872546E6E2F4F465A6C2F326451576A482F4F5564475550387A4E33722F4D32567257474C2F636E6A2F626D49306255316D2F31442F55465A755247314256662F2F4F453932616D51324E6C482F2F3156485630746F6345762F5976387852474A58636D542F4E55482F646B395864576E2F54444A4A2F335A516556502F6555644251663932566B582F6157567761307A2F5958502F6345566851324E742F30542F575570765331597956502F2F546E5A304D3268366255502F2F33424D654774555154662F5676394B5633704F5356662F4E6D6E2F546D6470536C622F5A5670512F306848636D662F61584A615A5038335A6B4C2F524774476457332F656D502F516E4A70566D5A732F33502F566C4E355255467153502F2F656A5578533164346330502F2F7A6C46556D78725A56482F57763944633252324E58442F6545762F4F45354264484C2F54554A472F334E4A52576E2F57585668562F396D526D482F516A42306555582F6155502F65546C49593046342F324C2F64557843636B317A62762F2F57475635576E56755A7A582F2F7A6877516B6C6D4F48662F5176397A646A6C334D6B332F6233502F5A6D744E636C442F563170682F33593452456A2F53326778645039785A464C2F4E455A756347482F5A57762F5A555979593170582F31542F5648686E5631703163502F2F5A584A56636D56365232622F2F7A6434525774575346542F5A503955626D63305454662F5545622F4E5756585458662F5431704C2F31527964457A2F624641775A2F39684141442F4141414141414434414144396741414141414173484C304143413D3D222C2266696C656E616D6573223A5B5B223133322F3330303030332F64353266323434392D353134342D343138312D383630332D6335393562376332393164622F30222C223133322F3330303030332F64353266323434392D353134342D343138312D383630332D6335393562376332393164625F737461742F30225D5D2C226D61782D6F7665726C617070696E672D6E756D223A317D5D7D5D2C22656C655F696473223A5B31395D2C2273746172742D6B6579223A6E756C6C2C22656E642D6B6579223A6E756C6C2C22746F74616C2D6B762D73697A65223A302C22746F74616C2D6B762D636E74223A302C226D756C7469706C652D66696C65732D7374617473223A6E756C6C7D"
	raw, error := hex.DecodeString(hexString)
	require.NoError(t, error)
	meta, error := ddl.DecodeBackfillSubTaskMeta4Test(raw)
	require.NoError(t, error)
	fmt.Println(meta)
}

func TestBackfillingSchedulerLocalMode(t *testing.T) {
	store, dom := testkit.CreateMockStoreAndDomain(t)
	sch, err := ddl.NewBackfillingSchedulerForTest(dom.DDL())
	require.NoError(t, err)
	tk := testkit.NewTestKit(t, store)
	tk.MustExec("use test")

	require.NoError(t, failpoint.Enable("github.com/pingcap/tidb/pkg/ddl/mockWriterMemSize", "return()"))
	defer failpoint.Disable("github.com/pingcap/tidb/pkg/ddl/mockWriterMemSize")
	/// 1. test partition table.
	tk.MustExec("create table tp1(id int primary key, v int) PARTITION BY RANGE (id) (\n    " +
		"PARTITION p0 VALUES LESS THAN (10),\n" +
		"PARTITION p1 VALUES LESS THAN (100),\n" +
		"PARTITION p2 VALUES LESS THAN (1000),\n" +
		"PARTITION p3 VALUES LESS THAN MAXVALUE\n);")
	task := createAddIndexTask(t, dom, "test", "tp1", proto.Backfill, false)
	tbl, err := dom.InfoSchema().TableByName(context.Background(), ast.NewCIStr("test"), ast.NewCIStr("tp1"))
	require.NoError(t, err)
	tblInfo := tbl.Meta()

	// 1.1 OnNextSubtasksBatch
	task.Step = sch.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.BackfillStepReadIndex, task.Step)
	execIDs := []string{":4000"}
	ctx := util.WithInternalSourceType(context.Background(), "backfill")
	metas, err := sch.OnNextSubtasksBatch(ctx, nil, task, execIDs, task.Step)
	require.NoError(t, err)
	require.Equal(t, len(tblInfo.Partition.Definitions), len(metas))
	for i, par := range tblInfo.Partition.Definitions {
		var subTask ddl.BackfillSubTaskMeta
		require.NoError(t, json.Unmarshal(metas[i], &subTask))
		require.Equal(t, par.ID, subTask.PhysicalTableID)
	}

	// 1.2 test partition table OnNextSubtasksBatch after BackfillStepReadIndex
	task.State = proto.TaskStateRunning
	task.Step = sch.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.StepDone, task.Step)
	metas, err = sch.OnNextSubtasksBatch(ctx, nil, task, execIDs, task.Step)
	require.NoError(t, err)
	require.Len(t, metas, 0)

	// 1.3 test partition table OnDone.
	err = sch.OnDone(context.Background(), nil, task)
	require.NoError(t, err)

	/// 2. test non partition table.
	// 2.1 empty table
	tk.MustExec("create table t1(id int primary key, v int)")
	task = createAddIndexTask(t, dom, "test", "t1", proto.Backfill, false)
	metas, err = sch.OnNextSubtasksBatch(ctx, nil, task, execIDs, task.Step)
	require.NoError(t, err)
	require.Equal(t, 0, len(metas))
	// 2.2 non empty table.
	tk.MustExec("create table t2(id bigint auto_random primary key)")
	tk.MustExec("insert into t2 values (), (), (), (), (), ()")
	tk.MustExec("insert into t2 values (), (), (), (), (), ()")
	tk.MustExec("insert into t2 values (), (), (), (), (), ()")
	tk.MustExec("insert into t2 values (), (), (), (), (), ()")
	task = createAddIndexTask(t, dom, "test", "t2", proto.Backfill, false)
	// 2.2.1 stepInit
	task.Step = sch.GetNextStep(&task.TaskBase)
	metas, err = sch.OnNextSubtasksBatch(ctx, nil, task, execIDs, task.Step)
	require.NoError(t, err)
	require.Equal(t, 1, len(metas))
	require.Equal(t, proto.BackfillStepReadIndex, task.Step)
	// 2.2.2 BackfillStepReadIndex
	task.State = proto.TaskStateRunning
	task.Step = sch.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.StepDone, task.Step)
	metas, err = sch.OnNextSubtasksBatch(ctx, nil, task, execIDs, task.Step)
	require.NoError(t, err)
	require.Equal(t, 0, len(metas))
}

func TestCalculateRegionBatch(t *testing.T) {
	// Test calculate in cloud storage.
	batchCnt := ddl.CalculateRegionBatch(100, 8, false)
	require.Equal(t, 13, batchCnt)
	batchCnt = ddl.CalculateRegionBatch(2, 8, false)
	require.Equal(t, 1, batchCnt)
	batchCnt = ddl.CalculateRegionBatch(8, 8, false)
	require.Equal(t, 1, batchCnt)

	// Test calculate in local storage.
	batchCnt = ddl.CalculateRegionBatch(100, 8, true)
	require.Equal(t, 13, batchCnt)
	batchCnt = ddl.CalculateRegionBatch(2, 8, true)
	require.Equal(t, 1, batchCnt)
	batchCnt = ddl.CalculateRegionBatch(24, 8, true)
	require.Equal(t, 3, batchCnt)
}

func TestBackfillingSchedulerGlobalSortMode(t *testing.T) {
	// init test env.
	store, dom := testkit.CreateMockStoreAndDomain(t)
	tk := testkit.NewTestKit(t, store)
	pool := pools.NewResourcePool(func() (pools.Resource, error) {
		return tk.Session(), nil
	}, 1, 1, time.Second)
	defer pool.Close()
	ctx := context.WithValue(context.Background(), "etcd", true)
	ctx = util.WithInternalSourceType(ctx, "handle")
	mgr := storage.NewTaskManager(pool)
	storage.SetTaskManager(mgr)
	schManager := scheduler.NewManager(util.WithInternalSourceType(ctx, "scheduler"), mgr, "host:port")

	tk.MustExec("use test")
	tk.MustExec("create table t1(id bigint auto_random primary key)")
	tk.MustExec("insert into t1 values (), (), (), (), (), ()")
	tk.MustExec("insert into t1 values (), (), (), (), (), ()")
	tk.MustExec("insert into t1 values (), (), (), (), (), ()")
	tk.MustExec("insert into t1 values (), (), (), (), (), ()")
	task := createAddIndexTask(t, dom, "test", "t1", proto.Backfill, true)

	sch := schManager.MockScheduler(task)
	ext, err := ddl.NewBackfillingSchedulerForTest(dom.DDL())
	require.NoError(t, err)
	ext.(*ddl.LitBackfillScheduler).GlobalSort = true
	sch.Extension = ext

	taskID, err := mgr.CreateTask(ctx, task.Key, proto.Backfill, 1, "", 0, task.Meta)
	require.NoError(t, err)
	task.ID = taskID
	execIDs := []string{":4000"}

	// 1. to read-index stage
	subtaskMetas, err := sch.OnNextSubtasksBatch(ctx, sch, task, execIDs, sch.GetNextStep(&task.TaskBase))
	require.NoError(t, err)
	require.Len(t, subtaskMetas, 1)
	nextStep := ext.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.BackfillStepReadIndex, nextStep)
	// update task/subtask, and finish subtask, so we can go to next stage
	subtasks := make([]*proto.Subtask, 0, len(subtaskMetas))
	for i, m := range subtaskMetas {
		subtasks = append(subtasks, proto.NewSubtask(nextStep, task.ID, task.Type, "", 1, m, i+1))
	}
	err = mgr.SwitchTaskStep(ctx, task, proto.TaskStatePending, nextStep, subtasks)
	require.NoError(t, err)
	task.Step = nextStep
	gotSubtasks, err := mgr.GetSubtasksWithHistory(ctx, taskID, proto.BackfillStepReadIndex)
	require.NoError(t, err)

	// update meta, same as import into.
	sortStepMeta := &ddl.BackfillSubTaskMeta{
		MetaGroups: []*external.SortedKVMeta{{
			StartKey:    []byte("ta"),
			EndKey:      []byte("tc"),
			TotalKVSize: 12,
			MultipleFilesStats: []external.MultipleFilesStat{
				{
					Filenames: [][2]string{
						{"gs://sort-bucket/data/1", "gs://sort-bucket/data/1.stat"},
					},
				},
			},
		}},
	}
	sortStepMetaBytes, err := json.Marshal(sortStepMeta)
	require.NoError(t, err)
	for _, s := range gotSubtasks {
		require.NoError(t, mgr.FinishSubtask(ctx, s.ExecID, s.ID, sortStepMetaBytes))
	}
	// 2. to merge-sort stage.
	require.NoError(t, failpoint.Enable("github.com/pingcap/tidb/pkg/ddl/forceMergeSort", `return()`))
	t.Cleanup(func() {
		require.NoError(t, failpoint.Disable("github.com/pingcap/tidb/pkg/ddl/forceMergeSort"))
	})
	subtaskMetas, err = ext.OnNextSubtasksBatch(ctx, sch, task, execIDs, ext.GetNextStep(&task.TaskBase))
	require.NoError(t, err)
	require.Len(t, subtaskMetas, 1)
	nextStep = ext.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.BackfillStepMergeSort, nextStep)

	// update meta, same as import into.
	subtasks = make([]*proto.Subtask, 0, len(subtaskMetas))
	for i, m := range subtaskMetas {
		subtasks = append(subtasks, proto.NewSubtask(nextStep, task.ID, task.Type, "", 1, m, i+1))
	}
	err = mgr.SwitchTaskStepInBatch(ctx, task, proto.TaskStatePending, nextStep, subtasks)
	require.NoError(t, err)
	task.Step = nextStep
	gotSubtasks, err = mgr.GetSubtasksWithHistory(ctx, taskID, task.Step)
	require.NoError(t, err)
	mergeSortStepMeta := &ddl.BackfillSubTaskMeta{
		MetaGroups: []*external.SortedKVMeta{{
			StartKey:    []byte("ta"),
			EndKey:      []byte("tc"),
			TotalKVSize: 12,
			MultipleFilesStats: []external.MultipleFilesStat{
				{
					Filenames: [][2]string{
						{"gs://sort-bucket/data/1", "gs://sort-bucket/data/1.stat"},
					},
				},
			},
		}},
	}
	mergeSortStepMetaBytes, err := json.Marshal(mergeSortStepMeta)
	require.NoError(t, err)
	for _, s := range gotSubtasks {
		require.NoError(t, mgr.FinishSubtask(ctx, s.ExecID, s.ID, mergeSortStepMetaBytes))
	}
	// 3. to write&ingest stage.
	require.NoError(t, failpoint.Enable("github.com/pingcap/tidb/pkg/ddl/mockWriteIngest", "return(true)"))
	t.Cleanup(func() {
		require.NoError(t, failpoint.Disable("github.com/pingcap/tidb/pkg/ddl/mockWriteIngest"))
	})
	subtaskMetas, err = ext.OnNextSubtasksBatch(ctx, sch, task, execIDs, ext.GetNextStep(&task.TaskBase))
	require.NoError(t, err)
	require.Len(t, subtaskMetas, 1)
	task.Step = ext.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.BackfillStepWriteAndIngest, task.Step)
	// 4. to done stage.
	subtaskMetas, err = ext.OnNextSubtasksBatch(ctx, sch, task, execIDs, ext.GetNextStep(&task.TaskBase))
	require.NoError(t, err)
	require.Len(t, subtaskMetas, 0)
	task.Step = ext.GetNextStep(&task.TaskBase)
	require.Equal(t, proto.StepDone, task.Step)
}

func TestGetNextStep(t *testing.T) {
	task := &proto.Task{
		TaskBase: proto.TaskBase{Step: proto.StepInit},
	}
	ext := &ddl.LitBackfillScheduler{}

	// 1. local mode
	for _, nextStep := range []proto.Step{proto.BackfillStepReadIndex, proto.StepDone} {
		require.Equal(t, nextStep, ext.GetNextStep(&task.TaskBase))
		task.Step = nextStep
	}
	// 2. global sort mode
	ext = &ddl.LitBackfillScheduler{GlobalSort: true}
	task.Step = proto.StepInit
	for _, nextStep := range []proto.Step{proto.BackfillStepReadIndex, proto.BackfillStepMergeSort, proto.BackfillStepWriteAndIngest} {
		require.Equal(t, nextStep, ext.GetNextStep(&task.TaskBase))
		task.Step = nextStep
	}
}

func createAddIndexTask(t *testing.T,
	dom *domain.Domain,
	dbName,
	tblName string,
	taskType proto.TaskType,
	useGlobalSort bool) *proto.Task {
	db, ok := dom.InfoSchema().SchemaByName(ast.NewCIStr(dbName))
	require.True(t, ok)
	tbl, err := dom.InfoSchema().TableByName(context.Background(), ast.NewCIStr(dbName), ast.NewCIStr(tblName))
	require.NoError(t, err)
	tblInfo := tbl.Meta()
	defaultSQLMode, err := mysql.GetSQLMode(mysql.DefaultSQLMode)
	require.NoError(t, err)

	taskMeta := &ddl.BackfillTaskMeta{
		Job: model.Job{
			ID:       time.Now().UnixNano(),
			SchemaID: db.ID,
			TableID:  tblInfo.ID,
			ReorgMeta: &model.DDLReorgMeta{
				SQLMode:     defaultSQLMode,
				Location:    &model.TimeZoneLocation{Name: time.UTC.String(), Offset: 0},
				ReorgTp:     model.ReorgTypeLitMerge,
				IsDistReorg: true,
			},
		},
		EleIDs:     []int64{10},
		EleTypeKey: meta.IndexElementKey,
	}
	if useGlobalSort {
		taskMeta.CloudStorageURI = "gs://sort-bucket"
	}

	taskMetaBytes, err := json.Marshal(taskMeta)
	require.NoError(t, err)

	task := &proto.Task{
		TaskBase: proto.TaskBase{
			ID:    time.Now().UnixMicro(),
			Type:  taskType,
			Step:  proto.StepInit,
			State: proto.TaskStatePending,
		},
		Meta:            taskMetaBytes,
		StartTime:       time.Now(),
		StateUpdateTime: time.Now(),
	}

	return task
}
