[
  {
    "Name": "TestExplainNonEvaledSubquery",
    "Cases": [
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#11)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#11",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  ScalarQueryCol#12",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#12",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  not(istrue_with_null(ScalarQueryCol#12))",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#12",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableReader 10000.00 0 root ",
          "└─TableFullScan 10000.00 0 cop[tikv] table:t1",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "Selection root  ScalarQueryCol#18",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#16",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t3 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#18",
          "└─Selection root  eq(cast(test.t2.a, double BINARY), cast(ScalarQueryCol#16, double BINARY)), eq(cast(test.t2.b, double BINARY), cast(ScalarQueryCol#16, double BINARY))",
          "  └─TableReader root  data:Selection",
          "    └─Selection cop[tikv]  eq(test.t2.b, test.t2.a)",
          "      └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t3",
          "ScalarSubQuery N/A 0 root ",
          "└─TableDual 0.00 0 root "
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#11), eq(test.t1.b, ScalarQueryCol#12)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#11, ScalarQueryCol#12",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      }
    ]
  },
  {
    "Name": "TestSubqueryInExplainAnalyze",
    "Cases": [
      {
        "SQL": "explain analyze select *,(select a from t2 limit 1) from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Projection_39 root test.t1.a, test.t1.b, test.t1.c, test.t1.d, test.t1.e, test.t1.f, test.t1.g, test.t1.h, test.t1.i, test.t1.j, test.t1.k, test.t1.l, test.t1.m, test.t1.n, test.t1.o, test.t1.p, test.t1.q, test.t1.r, test.t1.s, test.t1.t, test.t1.u, test.t1.v, test.t1.w, test.t1.x, test.t1.y, ScalarQueryCol#128(127)->Column#129",
          "└─TableReader_42 root data:Selection_41",
          "  └─Selection_41 cop[tikv] eq(test.t1.a, ScalarQueryCol#94(127))",
          "    └─TableFullScan_40 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_20 root Output: ScalarQueryCol#94",
          "└─MaxOneRow_10 root ",
          "  └─Limit_12 root offset:0, count:1",
          "    └─TableReader_17 root data:Limit_16",
          "      └─Limit_16 cop[tikv] offset:0, count:1",
          "        └─TableFullScan_15 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_38 root Output: ScalarQueryCol#128",
          "└─MaxOneRow_28 root ",
          "  └─Limit_30 root offset:0, count:1",
          "    └─TableReader_35 root data:Limit_34",
          "      └─Limit_34 cop[tikv] offset:0, count:1",
          "        └─TableFullScan_33 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select a, (select max(b) from t2 where t2.a ) as max_b, (select count(*) from t3 where t3.a) as count_t3 from t1",
        "Plan": [
          "Projection_72 root test.t1.a, ScalarQueryCol#127(32767)->Column#128, ScalarQueryCol#164(1)->Column#165",
          "└─TableReader_74 root data:TableFullScan_73",
          "  └─TableFullScan_73 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_44 root Output: ScalarQueryCol#127",
          "└─MaxOneRow_14 root ",
          "  └─StreamAgg_20 root funcs:max(test.t2.b)->Column#126",
          "    └─TopN_35 root test.t2.b:desc, offset:0, count:1",
          "      └─TableReader_43 root data:TopN_42",
          "        └─TopN_42 cop[tikv] test.t2.b:desc, offset:0, count:1",
          "          └─Selection_29 cop[tikv] not(isnull(test.t2.b)), test.t2.a",
          "            └─TableFullScan_28 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_71 root Output: ScalarQueryCol#164",
          "└─MaxOneRow_50 root ",
          "  └─StreamAgg_66 root funcs:count(Column#163)->Column#161",
          "    └─TableReader_67 root data:StreamAgg_55",
          "      └─StreamAgg_55 cop[tikv] funcs:count(1)->Column#163",
          "        └─Selection_65 cop[tikv] test.t3.a",
          "          └─TableFullScan_64 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a = (select a from t2 where b = (select b from t3 where c = (select c from t4 where a = 1)))",
        "Plan": [
          "TableDual_38 root rows:0",
          "ScalarSubQuery_20 root Output: ScalarQueryCol#131",
          "└─MaxOneRow_11 root ",
          "  └─TableReader_19 root data:Projection_13",
          "    └─Projection_13 cop[tikv] test.t4.c",
          "      └─Selection_18 cop[tikv] eq(test.t4.a, 1)",
          "        └─TableFullScan_17 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_27 root Output: ScalarQueryCol#132",
          "└─MaxOneRow_24 root ",
          "  └─TableDual_26 root rows:0",
          "ScalarSubQuery_34 root Output: ScalarQueryCol#133",
          "└─MaxOneRow_31 root ",
          "  └─TableDual_33 root rows:0"
        ]
      },
      {
        "SQL": "explain analyze with cte1 as (select a, b from t1 where c > (select avg(c) from t2)), cte2 as (select a, b from t2 where a in (select a from t3 where b > 20)) select cte1.*, cte2.* from cte1 join cte2 on cte1.a = cte2.a",
        "Plan": [
          "HashJoin_90 root inner join, equal:[eq(Column#267, test.t3.a)]",
          "├─HashAgg_126(Build) root group by:test.t3.a, funcs:firstrow(test.t3.a)->test.t3.a",
          "│ └─TableReader_127 root data:HashAgg_121",
          "│   └─HashAgg_121 cop[tikv] group by:test.t3.a, ",
          "│     └─Selection_125 cop[tikv] gt(test.t3.b, 20)",
          "│       └─TableFullScan_124 cop[tikv] keep order:false, stats:pseudo",
          "└─HashJoin_105(Probe) root inner join, equal:[eq(test.t1.a, test.t2.a)]",
          "  ├─TableReader_108(Build) root data:Selection_107",
          "  │ └─Selection_107 cop[tikv] gt(test.t1.c, ScalarQueryCol#199(8388607.0000)), not(isnull(test.t1.a))",
          "  │   └─TableFullScan_106 cop[tikv] keep order:false, stats:pseudo",
          "  └─Projection_111(Probe) root test.t2.a, test.t2.b, cast(test.t2.a, double BINARY)->Column#267",
          "    └─TableReader_114 root data:Selection_113",
          "      └─Selection_113 cop[tikv] not(isnull(test.t2.a))",
          "        └─TableFullScan_112 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_24 root Output: ScalarQueryCol#66",
          "└─MaxOneRow_7 root ",
          "  └─StreamAgg_20 root funcs:avg(Column#64, Column#65)->Column#61",
          "    └─TableReader_21 root data:StreamAgg_12",
          "      └─StreamAgg_12 cop[tikv] funcs:count(test.t2.c)->Column#64, funcs:sum(test.t2.c)->Column#65",
          "        └─TableFullScan_19 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_58 root Output: ScalarQueryCol#199",
          "└─MaxOneRow_41 root ",
          "  └─StreamAgg_54 root funcs:avg(Column#197, Column#198)->Column#194",
          "    └─TableReader_55 root data:StreamAgg_46",
          "      └─StreamAgg_46 cop[tikv] funcs:count(test.t2.c)->Column#197, funcs:sum(test.t2.c)->Column#198",
          "        └─TableFullScan_53 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a > (select count(*) from t2) and b < (select max(b) from t3) and c = (select avg(c) from t4)",
        "Plan": [
          "TableReader_90 root data:Selection_89",
          "└─Selection_89 cop[tikv] eq(cast(test.t1.c, double BINARY), ScalarQueryCol#142(456.78900146484375)), gt(test.t1.a, ScalarQueryCol#64(1)), lt(test.t1.b, ScalarQueryCol#98(790))",
          "  └─TableFullScan_88 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_24 root Output: ScalarQueryCol#64",
          "└─MaxOneRow_7 root ",
          "  └─StreamAgg_20 root funcs:count(Column#63)->Column#61",
          "    └─TableReader_21 root data:StreamAgg_12",
          "      └─StreamAgg_12 cop[tikv] funcs:count(1)->Column#63",
          "        └─TableFullScan_19 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_63 root Output: ScalarQueryCol#98",
          "└─MaxOneRow_33 root ",
          "  └─StreamAgg_39 root funcs:max(test.t3.b)->Column#97",
          "    └─TopN_54 root test.t3.b:desc, offset:0, count:1",
          "      └─TableReader_62 root data:TopN_61",
          "        └─TopN_61 cop[tikv] test.t3.b:desc, offset:0, count:1",
          "          └─Selection_48 cop[tikv] not(isnull(test.t3.b))",
          "            └─TableFullScan_47 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_85 root Output: ScalarQueryCol#142",
          "└─MaxOneRow_68 root ",
          "  └─StreamAgg_81 root funcs:avg(Column#140, Column#141)->Column#137",
          "    └─TableReader_82 root data:StreamAgg_73",
          "      └─StreamAgg_73 cop[tikv] funcs:count(test.t4.c)->Column#140, funcs:sum(test.t4.c)->Column#141",
          "        └─TableFullScan_80 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a + (select max(a) from t2) > (select avg(b) from t3)",
        "Plan": [
          "TableReader_68 root data:Selection_67",
          "└─Selection_67 cop[tikv] gt(plus(test.t1.a, ScalarQueryCol#62(127)), ScalarQueryCol#100(789))",
          "  └─TableFullScan_66 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_41 root Output: ScalarQueryCol#62",
          "└─MaxOneRow_11 root ",
          "  └─StreamAgg_17 root funcs:max(test.t2.a)->Column#61",
          "    └─TopN_32 root test.t2.a:desc, offset:0, count:1",
          "      └─TableReader_40 root data:TopN_39",
          "        └─TopN_39 cop[tikv] test.t2.a:desc, offset:0, count:1",
          "          └─Selection_26 cop[tikv] not(isnull(test.t2.a))",
          "            └─TableFullScan_25 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_63 root Output: ScalarQueryCol#100",
          "└─MaxOneRow_46 root ",
          "  └─StreamAgg_59 root funcs:avg(Column#98, Column#99)->Column#95",
          "    └─TableReader_60 root data:StreamAgg_51",
          "      └─StreamAgg_51 cop[tikv] funcs:count(test.t3.b)->Column#98, funcs:sum(test.t3.b)->Column#99",
          "        └─TableFullScan_58 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a > (select a from t2 where b = (select b from t3 where c = (select c from t4 where aa = 255))) and b < (select bb from t2 where cc = (select dd from t3 where ee = (select ff from t4 where gg = 32767)))",
        "Plan": [
          "TableDual_67 root rows:0",
          "ScalarSubQuery_20 root Output: ScalarQueryCol#131",
          "└─MaxOneRow_11 root ",
          "  └─TableReader_19 root data:Projection_13",
          "    └─Projection_13 cop[tikv] test.t4.c",
          "      └─Selection_18 cop[tikv] eq(test.t4.aa, 255)",
          "        └─TableFullScan_17 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_32 root Output: ScalarQueryCol#134",
          "└─MaxOneRow_23 root ",
          "  └─TableReader_31 root data:Projection_25",
          "    └─Projection_25 cop[tikv] test.t3.b",
          "      └─Selection_30 cop[tikv] eq(cast(test.t3.c, double BINARY), ScalarQueryCol#131(456.789))",
          "        └─TableFullScan_29 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_39 root Output: ScalarQueryCol#135",
          "└─MaxOneRow_36 root ",
          "  └─TableDual_38 root rows:0",
          "ScalarSubQuery_57 root Output: ScalarQueryCol#239",
          "└─MaxOneRow_48 root ",
          "  └─TableReader_56 root data:Projection_50",
          "    └─Projection_50 cop[tikv] test.t4.ff",
          "      └─Selection_55 cop[tikv] eq(test.t4.gg, 32767)",
          "        └─TableFullScan_54 cop[tikv] keep order:false, stats:pseudo"
        ]
      }
    ]
  }
]
