[
  {
    "Name": "TestExplainNonEvaledSubquery",
    "Cases": [
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#9)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#9",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  ScalarQueryCol#10",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#10",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  not(istrue_with_null(ScalarQueryCol#10))",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#10",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableReader 10000.00 0 root ",
          "└─TableFullScan 10000.00 0 cop[tikv] table:t1",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "Selection root  ScalarQueryCol#15",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#13",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t3 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#15",
          "└─Selection root  eq(cast(test.t2.a, double BINARY), cast(ScalarQueryCol#13, double BINARY)), eq(cast(test.t2.b, double BINARY), cast(ScalarQueryCol#13, double BINARY))",
          "  └─TableReader root  data:Selection",
          "    └─Selection cop[tikv]  eq(test.t2.b, test.t2.a)",
          "      └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t3",
          "ScalarSubQuery N/A 0 root ",
          "└─TableDual 0.00 0 root "
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#9), eq(test.t1.b, ScalarQueryCol#10)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#9, ScalarQueryCol#10",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      }
    ]
  },
  {
    "Name": "TestSubqueryInExplainAnalyze",
    "Cases": [
      {
        "SQL": "explain analyze select *,(select a from t2 limit 1) from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Projection_43 root test.t1.a, test.t1.b, test.t1.c, test.t1.d, test.t1.e, test.t1.f, test.t1.g, test.t1.h, test.t1.i, test.t1.j, test.t1.k, test.t1.l, test.t1.m, test.t1.n, test.t1.o, test.t1.p, test.t1.q, test.t1.r, test.t1.s, test.t1.t, test.t1.u, test.t1.v, test.t1.w, test.t1.x, test.t1.y, ScalarQueryCol#124(127)->Column#125",
          "└─TableReader_46 root data:Selection_45",
          "  └─Selection_45 cop[tikv] eq(test.t1.a, ScalarQueryCol#91(127))",
          "    └─TableFullScan_44 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_22 root Output: ScalarQueryCol#91",
          "└─MaxOneRow_10 root ",
          "  └─Limit_13 root offset:0, count:1",
          "    └─TableReader_19 root data:Limit_18",
          "      └─Limit_18 cop[tikv] offset:0, count:1",
          "        └─TableFullScan_17 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_42 root Output: ScalarQueryCol#124",
          "└─MaxOneRow_30 root ",
          "  └─Limit_33 root offset:0, count:1",
          "    └─TableReader_39 root data:Limit_38",
          "      └─Limit_38 cop[tikv] offset:0, count:1",
          "        └─TableFullScan_37 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select a, (select max(b) from t2 where t2.a ) as max_b, (select count(*) from t3 where t3.a) as count_t3 from t1",
        "Plan": [
          "Projection_74 root test.t1.a, ScalarQueryCol#123(32767)->Column#124, ScalarQueryCol#159(1)->Column#160",
          "└─TableReader_77 root data:TableFullScan_76",
          "  └─TableFullScan_76 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_45 root Output: ScalarQueryCol#123",
          "└─MaxOneRow_14 root ",
          "  └─StreamAgg_21 root funcs:max(test.t2.b)->Column#122",
          "    └─TopN_36 root test.t2.b:desc, offset:0, count:1",
          "      └─TableReader_44 root data:TopN_43",
          "        └─TopN_43 cop[tikv] test.t2.b:desc, offset:0, count:1",
          "          └─Selection_30 cop[tikv] not(isnull(test.t2.b)), test.t2.a",
          "            └─TableFullScan_29 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_73 root Output: ScalarQueryCol#159",
          "└─MaxOneRow_51 root ",
          "  └─StreamAgg_68 root funcs:count(Column#158)->Column#156",
          "    └─TableReader_69 root data:StreamAgg_57",
          "      └─StreamAgg_57 cop[tikv] funcs:count(1)->Column#158",
          "        └─Selection_67 cop[tikv] test.t3.a",
          "          └─TableFullScan_66 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a = (select a from t2 where b = (select b from t3 where c = (select c from t4 where a = 1)))",
        "Plan": [
          "TableDual_43 root rows:0",
          "ScalarSubQuery_21 root Output: ScalarQueryCol#127",
          "└─MaxOneRow_11 root ",
          "  └─TableReader_20 root data:Projection_14",
          "    └─Projection_14 cop[tikv] test.t4.c",
          "      └─Selection_19 cop[tikv] eq(test.t4.a, 1)",
          "        └─TableFullScan_18 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_30 root Output: ScalarQueryCol#128",
          "└─MaxOneRow_25 root ",
          "  └─TableDual_28 root rows:0",
          "ScalarSubQuery_39 root Output: ScalarQueryCol#129",
          "└─MaxOneRow_34 root ",
          "  └─TableDual_37 root rows:0"
        ]
      },
      {
        "SQL": "explain analyze with cte1 as (select a, b from t1 where c > (select avg(c) from t2)), cte2 as (select a, b from t2 where a in (select a from t3 where b > 20)) select cte1.*, cte2.* from cte1 join cte2 on cte1.a = cte2.a",
        "Plan": [
          "HashJoin_95 root inner join, equal:[eq(Column#259, test.t3.a)]",
          "├─HashAgg_134(Build) root group by:test.t3.a, funcs:firstrow(test.t3.a)->test.t3.a",
          "│ └─TableReader_135 root data:HashAgg_129",
          "│   └─HashAgg_129 cop[tikv] group by:test.t3.a, ",
          "│     └─Selection_133 cop[tikv] gt(test.t3.b, 20)",
          "│       └─TableFullScan_132 cop[tikv] keep order:false, stats:pseudo",
          "└─HashJoin_112(Probe) root inner join, equal:[eq(test.t1.a, test.t2.a)]",
          "  ├─TableReader_115(Build) root data:Selection_114",
          "  │ └─Selection_114 cop[tikv] gt(test.t1.c, ScalarQueryCol#193(8388607.0000)), not(isnull(test.t1.a))",
          "  │   └─TableFullScan_113 cop[tikv] keep order:false, stats:pseudo",
          "  └─Projection_118(Probe) root test.t2.a, test.t2.b, cast(test.t2.a, double BINARY)->Column#259",
          "    └─TableReader_122 root data:Selection_121",
          "      └─Selection_121 cop[tikv] not(isnull(test.t2.a))",
          "        └─TableFullScan_120 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_25 root Output: ScalarQueryCol#64",
          "└─MaxOneRow_7 root ",
          "  └─StreamAgg_21 root funcs:avg(Column#62, Column#63)->Column#59",
          "    └─TableReader_22 root data:StreamAgg_13",
          "      └─StreamAgg_13 cop[tikv] funcs:count(test.t2.c)->Column#62, funcs:sum(test.t2.c)->Column#63",
          "        └─TableFullScan_20 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_60 root Output: ScalarQueryCol#193",
          "└─MaxOneRow_42 root ",
          "  └─StreamAgg_56 root funcs:avg(Column#191, Column#192)->Column#188",
          "    └─TableReader_57 root data:StreamAgg_48",
          "      └─StreamAgg_48 cop[tikv] funcs:count(test.t2.c)->Column#191, funcs:sum(test.t2.c)->Column#192",
          "        └─TableFullScan_55 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a > (select count(*) from t2) and b < (select max(b) from t3) and c = (select avg(c) from t4)",
        "Plan": [
          "TableReader_93 root data:Selection_92",
          "└─Selection_92 cop[tikv] eq(cast(test.t1.c, double BINARY), ScalarQueryCol#138(456.78900146484375)), gt(test.t1.a, ScalarQueryCol#62(1)), lt(test.t1.b, ScalarQueryCol#95(790))",
          "  └─TableFullScan_91 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_25 root Output: ScalarQueryCol#62",
          "└─MaxOneRow_7 root ",
          "  └─StreamAgg_21 root funcs:count(Column#61)->Column#59",
          "    └─TableReader_22 root data:StreamAgg_13",
          "      └─StreamAgg_13 cop[tikv] funcs:count(1)->Column#61",
          "        └─TableFullScan_20 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_65 root Output: ScalarQueryCol#95",
          "└─MaxOneRow_34 root ",
          "  └─StreamAgg_41 root funcs:max(test.t3.b)->Column#94",
          "    └─TopN_56 root test.t3.b:desc, offset:0, count:1",
          "      └─TableReader_64 root data:TopN_63",
          "        └─TopN_63 cop[tikv] test.t3.b:desc, offset:0, count:1",
          "          └─Selection_50 cop[tikv] not(isnull(test.t3.b))",
          "            └─TableFullScan_49 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_88 root Output: ScalarQueryCol#138",
          "└─MaxOneRow_70 root ",
          "  └─StreamAgg_84 root funcs:avg(Column#136, Column#137)->Column#133",
          "    └─TableReader_85 root data:StreamAgg_76",
          "      └─StreamAgg_76 cop[tikv] funcs:count(test.t4.c)->Column#136, funcs:sum(test.t4.c)->Column#137",
          "        └─TableFullScan_83 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a + (select max(a) from t2) > (select avg(b) from t3)",
        "Plan": [
          "TableReader_70 root data:Selection_69",
          "└─Selection_69 cop[tikv] gt(plus(test.t1.a, ScalarQueryCol#60(127)), ScalarQueryCol#97(789))",
          "  └─TableFullScan_68 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_42 root Output: ScalarQueryCol#60",
          "└─MaxOneRow_11 root ",
          "  └─StreamAgg_18 root funcs:max(test.t2.a)->Column#59",
          "    └─TopN_33 root test.t2.a:desc, offset:0, count:1",
          "      └─TableReader_41 root data:TopN_40",
          "        └─TopN_40 cop[tikv] test.t2.a:desc, offset:0, count:1",
          "          └─Selection_27 cop[tikv] not(isnull(test.t2.a))",
          "            └─TableFullScan_26 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_65 root Output: ScalarQueryCol#97",
          "└─MaxOneRow_47 root ",
          "  └─StreamAgg_61 root funcs:avg(Column#95, Column#96)->Column#92",
          "    └─TableReader_62 root data:StreamAgg_53",
          "      └─StreamAgg_53 cop[tikv] funcs:count(test.t3.b)->Column#95, funcs:sum(test.t3.b)->Column#96",
          "        └─TableFullScan_60 cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze select * from t1 where a > (select a from t2 where b = (select b from t3 where c = (select c from t4 where aa = 255))) and b < (select bb from t2 where cc = (select dd from t3 where ee = (select ff from t4 where gg = 32767)))",
        "Plan": [
          "TableDual_72 root rows:0",
          "ScalarSubQuery_21 root Output: ScalarQueryCol#127",
          "└─MaxOneRow_11 root ",
          "  └─TableReader_20 root data:Projection_14",
          "    └─Projection_14 cop[tikv] test.t4.c",
          "      └─Selection_19 cop[tikv] eq(test.t4.aa, 255)",
          "        └─TableFullScan_18 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_34 root Output: ScalarQueryCol#128",
          "└─MaxOneRow_24 root ",
          "  └─TableReader_33 root data:Projection_27",
          "    └─Projection_27 cop[tikv] test.t3.b",
          "      └─Selection_32 cop[tikv] eq(cast(test.t3.c, double BINARY), ScalarQueryCol#127(456.789))",
          "        └─TableFullScan_31 cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery_43 root Output: ScalarQueryCol#129",
          "└─MaxOneRow_38 root ",
          "  └─TableDual_41 root rows:0",
          "ScalarSubQuery_62 root Output: ScalarQueryCol#230",
          "└─MaxOneRow_52 root ",
          "  └─TableReader_61 root data:Projection_55",
          "    └─Projection_55 cop[tikv] test.t4.ff",
          "      └─Selection_60 cop[tikv] eq(test.t4.gg, 32767)",
          "        └─TableFullScan_59 cop[tikv] keep order:false, stats:pseudo"
        ]
      }
    ]
  }
]
