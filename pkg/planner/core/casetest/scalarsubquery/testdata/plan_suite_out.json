[
  {
    "Name": "TestExplainNonEvaledSubquery",
    "Cases": [
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#11)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#11",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  ScalarQueryCol#12",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#12",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "Selection root  not(istrue_with_null(ScalarQueryCol#12))",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#12",
          "└─TableReader root  data:Selection",
          "  └─Selection cop[tikv]  eq(test.t2.a, 1)",
          "    └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where not exists(select 1 from t2 where a = 1)",
        "Plan": [
          "TableReader 10000.00 0 root ",
          "└─TableFullScan 10000.00 0 cop[tikv] table:t1",
          "ScalarSubQuery N/A 0 root ",
          "└─TableReader 10.00 0 root ",
          "  └─Selection 10.00 0 cop[tikv] ",
          "    └─TableFullScan 10000.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "Selection root  ScalarQueryCol#18",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#16",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t3 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#18",
          "└─Selection root  eq(cast(test.t2.a, double BINARY), cast(ScalarQueryCol#16, double BINARY)), eq(cast(test.t2.b, double BINARY), cast(ScalarQueryCol#16, double BINARY))",
          "  └─TableReader root  data:Selection",
          "    └─Selection cop[tikv]  eq(test.t2.b, test.t2.a)",
          "      └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where exists(select 1 from t2 where a = (select a from t3 limit 1) and b = a);",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t3",
          "ScalarSubQuery N/A 0 root ",
          "└─TableDual 0.00 0 root "
        ],
        "Error": ""
      },
      {
        "SQL": "explain format = 'plan_tree' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "Selection root  eq(test.t1.a, ScalarQueryCol#11), eq(test.t1.b, ScalarQueryCol#12)",
          "└─TableReader root  data:TableFullScan",
          "  └─TableFullScan cop[tikv] table:t1 keep order:false, stats:pseudo",
          "ScalarSubQuery root  Output: ScalarQueryCol#11, ScalarQueryCol#12",
          "└─MaxOneRow root  ",
          "  └─Limit root  offset:0, count:1",
          "    └─TableReader root  data:Limit",
          "      └─Limit cop[tikv]  offset:0, count:1",
          "        └─TableFullScan cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Error": ""
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where (a, b) = (select a, b from t2 limit 1)",
        "Plan": [
          "TableDual 0.00 0 root ",
          "ScalarSubQuery N/A 0 root ",
          "└─MaxOneRow 1.00 1 root ",
          "  └─Limit 1.00 0 root ",
          "    └─TableReader 1.00 0 root ",
          "      └─Limit 1.00 0 cop[tikv] ",
          "        └─TableFullScan 1.00 0 cop[tikv] table:t2"
        ],
        "Error": ""
      }
    ]
  },
  {
    "Name": "TestSubqueryInExplainAnalyze",
    "Cases": [
      {
        "SQL": "explain analyze format = 'brief' select *,(select a from t2 limit 1) from t1 where a = (select a from t2 limit 1)",
        "Plan": [
          "Projection root test.t1.a, test.t1.b, test.t1.c, test.t1.d, test.t1.e, test.t1.f, test.t1.g, test.t1.h, test.t1.i, test.t1.j, test.t1.k, test.t1.l, test.t1.m, test.t1.n, test.t1.o, test.t1.p, test.t1.q, test.t1.r, test.t1.s, test.t1.t, test.t1.u, test.t1.v, test.t1.w, test.t1.x, test.t1.y, ScalarQueryCol#128(127)->Column#129",
          "└─TableReader root data:Selection",
          "  └─Selection cop[tikv] eq(test.t1.a, ScalarQueryCol#94(127))",
          "    └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#94",
          "└─MaxOneRow root ",
          "  └─Limit root offset:0, count:1",
          "    └─TableReader root data:Limit",
          "      └─Limit cop[tikv] offset:0, count:1",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#128",
          "└─MaxOneRow root ",
          "  └─Limit root offset:0, count:1",
          "    └─TableReader root data:Limit",
          "      └─Limit cop[tikv] offset:0, count:1",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' select a, (select max(b) from t2 where t2.a ) as max_b, (select count(*) from t3 where t3.a) as count_t3 from t1",
        "Plan": [
          "Projection root test.t1.a, ScalarQueryCol#127(32767)->Column#128, ScalarQueryCol#164(1)->Column#165",
          "└─TableReader root data:TableFullScan",
          "  └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#127",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:max(test.t2.b)->Column#126",
          "    └─TopN root test.t2.b:desc, offset:0, count:1",
          "      └─TableReader root data:TopN",
          "        └─TopN cop[tikv] test.t2.b:desc, offset:0, count:1",
          "          └─Selection cop[tikv] not(isnull(test.t2.b)), test.t2.a",
          "            └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#164",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:count(Column#163)->Column#161",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(1)->Column#163",
          "        └─Selection cop[tikv] test.t3.a",
          "          └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a = (select a from t2 where b = (select b from t3 where c = (select c from t4 where a = 1)))",
        "Plan": [
          "TableDual root rows:0",
          "ScalarSubQuery root Output: ScalarQueryCol#131",
          "└─MaxOneRow root ",
          "  └─TableReader root data:Projection",
          "    └─Projection cop[tikv] test.t4.c",
          "      └─Selection cop[tikv] eq(test.t4.a, 1)",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#132",
          "└─MaxOneRow root ",
          "  └─TableDual root rows:0",
          "ScalarSubQuery root Output: ScalarQueryCol#133",
          "└─MaxOneRow root ",
          "  └─TableDual root rows:0"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' with cte1 as (select a, b from t1 where c > (select avg(c) from t2)), cte2 as (select a, b from t2 where a in (select a from t3 where b > 20)) select cte1.*, cte2.* from cte1 join cte2 on cte1.a = cte2.a",
        "Plan": [
          "HashJoin root inner join, equal:[eq(Column#267, test.t3.a)]",
          "├─HashAgg(Build) root group by:test.t3.a, funcs:firstrow(test.t3.a)->test.t3.a",
          "│ └─TableReader root data:HashAgg",
          "│   └─HashAgg cop[tikv] group by:test.t3.a, ",
          "│     └─Selection cop[tikv] gt(test.t3.b, 20)",
          "│       └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "└─HashJoin(Probe) root inner join, equal:[eq(test.t1.a, test.t2.a)]",
          "  ├─TableReader(Build) root data:Selection",
          "  │ └─Selection cop[tikv] gt(test.t1.c, ScalarQueryCol#199(8388607.0000)), not(isnull(test.t1.a))",
          "  │   └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "  └─Projection(Probe) root test.t2.a, test.t2.b, cast(test.t2.a, double BINARY)->Column#267",
          "    └─TableReader root data:Selection",
          "      └─Selection cop[tikv] not(isnull(test.t2.a))",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#66",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:avg(Column#64, Column#65)->Column#61",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(test.t2.c)->Column#64, funcs:sum(test.t2.c)->Column#65",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#199",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:avg(Column#197, Column#198)->Column#194",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(test.t2.c)->Column#197, funcs:sum(test.t2.c)->Column#198",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a > (select count(*) from t2) and b < (select max(b) from t3) and c = (select avg(c) from t4)",
        "Plan": [
          "TableReader root data:Selection",
          "└─Selection cop[tikv] eq(cast(test.t1.c, double BINARY), ScalarQueryCol#142(456.78900146484375)), gt(test.t1.a, ScalarQueryCol#64(1)), lt(test.t1.b, ScalarQueryCol#98(790))",
          "  └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#64",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:count(Column#63)->Column#61",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(1)->Column#63",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#98",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:max(test.t3.b)->Column#97",
          "    └─TopN root test.t3.b:desc, offset:0, count:1",
          "      └─TableReader root data:TopN",
          "        └─TopN cop[tikv] test.t3.b:desc, offset:0, count:1",
          "          └─Selection cop[tikv] not(isnull(test.t3.b))",
          "            └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#142",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:avg(Column#140, Column#141)->Column#137",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(test.t4.c)->Column#140, funcs:sum(test.t4.c)->Column#141",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a + (select max(a) from t2) > (select avg(b) from t3)",
        "Plan": [
          "TableReader root data:Selection",
          "└─Selection cop[tikv] gt(plus(test.t1.a, ScalarQueryCol#62(127)), ScalarQueryCol#100(789))",
          "  └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#62",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:max(test.t2.a)->Column#61",
          "    └─TopN root test.t2.a:desc, offset:0, count:1",
          "      └─TableReader root data:TopN",
          "        └─TopN cop[tikv] test.t2.a:desc, offset:0, count:1",
          "          └─Selection cop[tikv] not(isnull(test.t2.a))",
          "            └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#100",
          "└─MaxOneRow root ",
          "  └─StreamAgg root funcs:avg(Column#98, Column#99)->Column#95",
          "    └─TableReader root data:StreamAgg",
          "      └─StreamAgg cop[tikv] funcs:count(test.t3.b)->Column#98, funcs:sum(test.t3.b)->Column#99",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      },
      {
        "SQL": "explain analyze format = 'brief' select * from t1 where a > (select a from t2 where b = (select b from t3 where c = (select c from t4 where aa = 255))) and b < (select bb from t2 where cc = (select dd from t3 where ee = (select ff from t4 where gg = 32767)))",
        "Plan": [
          "TableDual root rows:0",
          "ScalarSubQuery root Output: ScalarQueryCol#131",
          "└─MaxOneRow root ",
          "  └─TableReader root data:Projection",
          "    └─Projection cop[tikv] test.t4.c",
          "      └─Selection cop[tikv] eq(test.t4.aa, 255)",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#132",
          "└─MaxOneRow root ",
          "  └─TableReader root data:Projection",
          "    └─Projection cop[tikv] test.t3.b",
          "      └─Selection cop[tikv] eq(cast(test.t3.c, double BINARY), ScalarQueryCol#131(456.789))",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo",
          "ScalarSubQuery root Output: ScalarQueryCol#133",
          "└─MaxOneRow root ",
          "  └─TableDual root rows:0",
          "ScalarSubQuery root Output: ScalarQueryCol#237",
          "└─MaxOneRow root ",
          "  └─TableReader root data:Projection",
          "    └─Projection cop[tikv] test.t4.ff",
          "      └─Selection cop[tikv] eq(test.t4.gg, 32767)",
          "        └─TableFullScan cop[tikv] keep order:false, stats:pseudo"
        ]
      }
    ]
  }
]
