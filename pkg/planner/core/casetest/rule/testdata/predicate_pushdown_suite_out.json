[
  {
    "Name": "TestConstantPropagateWithCollation",
    "Cases": [
      {
        "SQL": "",
        "Plan": null,
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select * from t where name='a' and length(name)=1; -- without constant propagated",
        "Plan": [
          "TableReader 8.00 root  data:Selection",
          "└─Selection 8.00 cop[tikv]  eq(length(test.t.name), 1), eq(test.t.name, \"a\")",
          "  └─TableFullScan 10000.00 cop[tikv] table:t keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "",
        "Plan": null,
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select * from t where name='a' and length(name)=1; -- without constant propagated",
        "Plan": [
          "TableReader 8.00 root  data:Selection",
          "└─Selection 8.00 cop[tikv]  eq(length(test.t.name), 1), eq(test.t.name, \"a\")",
          "  └─TableFullScan 10000.00 cop[tikv] table:t keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select * from (select 'test' as b from t) n where length(b) > 2; -- can be substituted",
        "Plan": [
          "Projection 10000.00 root  test->Column#4",
          "└─TableReader 10000.00 root  data:TableFullScan",
          "  └─TableFullScan 10000.00 cop[tikv] table:t keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select foo.a, foo.b, bar.c from foo join bar on foo.a=bar.a where (foo.a,foo.b) in ((1,2),(3,4));",
        "Plan": [
          "IndexJoin 2.50 root  inner join, inner:TableReader, outer key:test.foo.a, inner key:test.bar.a, equal cond:eq(test.foo.a, test.bar.a)",
          "├─Selection(Build) 2.00 root  or(and(eq(test.foo.a, 1), eq(test.foo.b, 2)), and(eq(test.foo.a, 3), eq(test.foo.b, 4)))",
          "│ └─Batch_Point_Get 2.00 root table:foo handle:[1 3], keep order:false, desc:false",
          "└─TableReader(Probe) 2.00 root  data:TableRangeScan",
          "  └─TableRangeScan 2.00 cop[tikv] table:bar range: decided by [test.foo.a], keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select foo.a, foo.b, bar.c from foo left join bar on foo.a=bar.a where (foo.a,foo.b) in ((1,2),(3,4));",
        "Plan": [
          "IndexJoin 2.50 root  left outer join, inner:TableReader, left side:Selection, outer key:test.foo.a, inner key:test.bar.a, equal cond:eq(test.foo.a, test.bar.a)",
          "├─Selection(Build) 2.00 root  or(and(eq(test.foo.a, 1), eq(test.foo.b, 2)), and(eq(test.foo.a, 3), eq(test.foo.b, 4)))",
          "│ └─Batch_Point_Get 2.00 root table:foo handle:[1 3], keep order:false, desc:false",
          "└─TableReader(Probe) 2.00 root  data:TableRangeScan",
          "  └─TableRangeScan 2.00 cop[tikv] table:bar range: decided by [test.foo.a], keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select foo.a, foo.b, bar.c from foo left join bar on foo.a=bar.a where (foo.a,foo.b) in ((1,2),(3,4));",
        "Plan": [
          "IndexJoin 2.50 root  left outer join, inner:TableReader, left side:Selection, outer key:test.foo.a, inner key:test.bar.a, equal cond:eq(test.foo.a, test.bar.a)",
          "├─Selection(Build) 2.00 root  or(and(eq(test.foo.a, 1), eq(test.foo.b, 2)), and(eq(test.foo.a, 3), eq(test.foo.b, 4)))",
          "│ └─Batch_Point_Get 2.00 root table:foo handle:[1 3], keep order:false, desc:false",
          "└─TableReader(Probe) 2.00 root  data:TableRangeScan",
          "  └─TableRangeScan 2.00 cop[tikv] table:bar range: decided by [test.foo.a], keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select * from foo join bar on foo.a=bar.a where rand() > 0.5;",
        "Plan": [
          "MergeJoin 12500.00 root  inner join, left key:test.foo.a, right key:test.bar.a, other cond:gt(rand(), 0.5)",
          "├─TableReader(Build) 10000.00 root  data:TableFullScan",
          "│ └─TableFullScan 10000.00 cop[tikv] table:bar keep order:true, stats:pseudo",
          "└─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "  └─TableFullScan 10000.00 cop[tikv] table:foo keep order:true, stats:pseudo"
        ],
        "Result": null,
        "Warning": [
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now."
        ]
      },
      {
        "SQL": "select * from foo join bar on foo.a=bar.a where foo.a = rand();",
        "Plan": [
          "MergeJoin 10000.00 root  inner join, left key:test.foo.a, right key:test.bar.a",
          "├─TableReader(Build) 10000.00 root  data:TableFullScan",
          "│ └─TableFullScan 10000.00 cop[tikv] table:bar keep order:true, stats:pseudo",
          "└─Selection(Probe) 8000.00 root  eq(cast(test.foo.a, double BINARY), rand())",
          "  └─TableReader 10000.00 root  data:TableFullScan",
          "    └─TableFullScan 10000.00 cop[tikv] table:foo keep order:true, stats:pseudo"
        ],
        "Result": null,
        "Warning": [
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to storage layer now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now.",
          "Warning 1105 Scalar function 'rand'(signature: Rand, return type: double) is not supported to push down to tiflash now."
        ]
      },
      {
        "SQL": "select 85.11 as c0, t0.p1 as c1, '2024-01-02 12:28:00' as c2 from t0 right join t1 on (t0.k0 = t1.k0) join t3 on (t0.k0 = t3.k0) left join t2 on not not (t0.k0 = t2.k0) left join t4 on (t0.k0 = t4.k0) where (t0.k0 <=> t3.k0) order by (t3.d0 - t2.k1) desc, t1.d0 desc limit 13",
        "Plan": [
          "Projection 13.00 root  85.11->Column#22, test.t0.p1, 2024-01-02 12:28:00->Column#24",
          "└─Projection 13.00 root  test.t0.p1",
          "  └─TopN 13.00 root  Column#26:desc, test.t1.d0:desc, offset:0, count:13",
          "    └─Projection 16.25 root  test.t0.p1, test.t1.d0, test.t3.d0, test.t2.k1, minus(test.t3.d0, cast(test.t2.k1, decimal(10,0) BINARY))->Column#26",
          "      └─HashJoin 16.25 root  left outer join, left side:Projection, equal:[eq(test.t0.k0, test.t4.k0)]",
          "        ├─Projection(Build) 13.00 root  test.t0.k0, test.t0.p1, test.t1.d0, test.t3.d0, test.t2.k1",
          "        │ └─TopN 13.00 root  Column#25:desc, test.t1.d0:desc, offset:0, count:13",
          "        │   └─Projection 15609.38 root  test.t0.k0, test.t0.p1, test.t1.d0, test.t3.d0, test.t2.k1, minus(test.t3.d0, cast(test.t2.k1, decimal(10,0) BINARY))->Column#25",
          "        │     └─HashJoin 15609.38 root  left outer join, left side:HashJoin, equal:[eq(test.t0.k0, test.t2.k0)]",
          "        │       ├─TableReader(Build) 9990.00 root  data:Selection",
          "        │       │ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2.k0))",
          "        │       │   └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo",
          "        │       └─HashJoin(Probe) 12487.50 root  inner join, equal:[eq(test.t0.k0, test.t3.k0) nulleq(test.t0.k0, test.t3.k0)]",
          "        │         ├─TableReader(Build) 7992.00 root  data:Selection",
          "        │         │ └─Selection 7992.00 cop[tikv]  not(isnull(test.t3.k0)), nulleq(test.t3.k0, test.t3.k0)",
          "        │         │   └─TableFullScan 10000.00 cop[tikv] table:t3 keep order:false, stats:pseudo",
          "        │         └─HashJoin(Probe) 9990.00 root  inner join, equal:[eq(test.t0.k0, test.t1.k0)]",
          "        │           ├─TableReader(Build) 7992.00 root  data:Selection",
          "        │           │ └─Selection 7992.00 cop[tikv]  not(isnull(test.t0.k0)), nulleq(test.t0.k0, test.t0.k0)",
          "        │           │   └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo",
          "        │           └─TableReader(Probe) 7992.00 root  data:Selection",
          "        │             └─Selection 7992.00 cop[tikv]  not(isnull(test.t1.k0)), nulleq(test.t1.k0, test.t1.k0)",
          "        │               └─TableFullScan 10000.00 cop[tikv] table:t1 keep order:false, stats:pseudo",
          "        └─TableReader(Probe) 9990.00 root  data:Selection",
          "          └─Selection 9990.00 cop[tikv]  not(isnull(test.t4.k0))",
          "            └─TableFullScan 10000.00 cop[tikv] table:t4 keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      },
      {
        "SQL": "select /* double_not_left_join */ t0.k0 from t0 left join t2 on not not (t0.k0 = t2.k0)",
        "Plan": [
          "HashJoin 12487.50 root  left outer join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "├─TableReader(Build) 9990.00 root  data:Selection",
          "│ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2.k0))",
          "│   └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo",
          "└─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "  └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1",
          "3",
          "2"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* double_not_right_join */ t0.k0 from t0 right join t2 on not not (t0.k0 = t2.k0)",
        "Plan": [
          "HashJoin 12487.50 root  right outer join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "├─TableReader(Build) 9990.00 root  data:Selection",
          "│ └─Selection 9990.00 cop[tikv]  not(isnull(test.t0.k0))",
          "│   └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo",
          "└─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "  └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1",
          "3",
          "<nil>"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* double_not_semi_join */ t0.k0 from t0 where exists (select 1 from t2 where not not (t0.k0 = t2.k0))",
        "Plan": [
          "HashJoin 7992.00 root  semi join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "├─TableReader(Build) 9990.00 root  data:Selection",
          "│ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2.k0))",
          "│   └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo",
          "└─TableReader(Probe) 9990.00 root  data:Selection",
          "  └─Selection 9990.00 cop[tikv]  not(isnull(test.t0.k0))",
          "    └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1",
          "3"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* double_not_left_join_exec */ t0.k0, t2.k0 from t0 left join t2 on not not (t0.k0 = t2.k0) order by t0.k0, t2.k0",
        "Plan": [
          "Sort 12487.50 root  test.t0.k0, test.t2.k0",
          "└─HashJoin 12487.50 root  left outer join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "  ├─TableReader(Build) 9990.00 root  data:Selection",
          "  │ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2.k0))",
          "  │   └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo",
          "  └─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "    └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1 1",
          "2 <nil>",
          "3 3"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* double_not_right_join_exec */ t0.k0, t2.k0 from t0 right join t2 on not not (t0.k0 = t2.k0) order by t2.k0, t0.k0",
        "Plan": [
          "Sort 12487.50 root  test.t2.k0, test.t0.k0",
          "└─HashJoin 12487.50 root  right outer join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "  ├─TableReader(Build) 9990.00 root  data:Selection",
          "  │ └─Selection 9990.00 cop[tikv]  not(isnull(test.t0.k0))",
          "  │   └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo",
          "  └─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "    └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1 1",
          "3 3",
          "<nil> 4"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* double_not_semi_join_exec */ t0.k0 from t0 where exists (select 1 from t2 where not not (t0.k0 = t2.k0)) order by t0.k0",
        "Plan": [
          "Sort 7992.00 root  test.t0.k0",
          "└─HashJoin 7992.00 root  semi join, left side:TableReader, equal:[eq(test.t0.k0, test.t2.k0)]",
          "  ├─TableReader(Build) 9990.00 root  data:Selection",
          "  │ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2.k0))",
          "  │   └─TableFullScan 10000.00 cop[tikv] table:t2 keep order:false, stats:pseudo",
          "  └─TableReader(Probe) 9990.00 root  data:Selection",
          "    └─Selection 9990.00 cop[tikv]  not(isnull(test.t0.k0))",
          "      └─TableFullScan 10000.00 cop[tikv] table:t0 keep order:false, stats:pseudo"
        ],
        "Result": [
          "1",
          "3"
        ],
        "Warning": null
      },
      {
        "SQL": "select /* issue:65994 */ * from t1_65994 left join t2_65994 on (t1_65994.a = t2_65994.a or 0)",
        "Plan": [
          "HashJoin 12487.50 root  left outer join, left side:TableReader, equal:[eq(test.t1_65994.a, test.t2_65994.a)]",
          "├─TableReader(Build) 9990.00 root  data:Selection",
          "│ └─Selection 9990.00 cop[tikv]  not(isnull(test.t2_65994.a))",
          "│   └─TableFullScan 10000.00 cop[tikv] table:t2_65994 keep order:false, stats:pseudo",
          "└─TableReader(Probe) 10000.00 root  data:TableFullScan",
          "  └─TableFullScan 10000.00 cop[tikv] table:t1_65994 keep order:false, stats:pseudo"
        ],
        "Result": null,
        "Warning": null
      }
    ]
  }
]
