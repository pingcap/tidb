# Proposal: Chunk RPC

- Author(s): [wshwsh12](https://github.com/wshwsh12)
- Last updated:  Feb. 25, 2020

## Abstract

Here I propose to directly use Chunk to transmit record batches from TiKV to TiDB, which could help us saving the data decoding overhead in TiDB, improve the end-to-end query performance. But no pain no gain, since we actually replace the variable-length encoding method to the fixed-length encoding method, the data to be transmitted is larger than before, and the network bandwidth is sacrificed.

## Background

The data decoding process, `readRowsData`, takes too much CPU time and the cache utilization is not efficient. This process greatly slows down the query execution time. I'll provide some query cases and CPU flame graphs later to show the decode overhead.

## Proposal

The new format is defined as follows:

- 8-byte length
- 8-byte nullCount
- nullBitMap array
- offset array
- data array

In TiKV, we can append values into Chunk, and use a mainly-copy method to encode the result Chunk into a []byte.
In TiDB, we can use another mainly-copy method to decode the []byte inside the response of a coprocessor task, and directly use this Chunk for the upper execution components.

## Rationale

Provide later.

## Compatibility

We need to change the protocol buffer message to contain the []byte encoded by TiKV, and we may need to main two kinds of data formats during the development.

## Implementation

@wshwsh12: Add a flag EncodeType for response. pingcap/tidb#12536 tikv/tikv#5584
@wshwsh12: Coprocessor: return Chunk encoded data: tikv/tikv#5461
@wshwsh12: Encode the returned data using the Chunk format in mocktikv: #12023
@zz-jason: Implement the mainly-copy encode and decode methods for Chunk: #7006
@zz-jason: Extend the SelectResponse the protocol buffer message: pingcap/tipb#96
@zz-jason: Read and decode data according the Version value of the SelectResponse protocol buffer message. For now, we use 0 to represent the old method, 1 to represent the Chunk way. 
@zz-jason: Return Chunk encoded data in mocktikv.
@AndreMouche: Port the Encode method to TiKV side.
@AndreMouche: Return Chunk encoded data in TiKV.

## Open issues (if applicable)

- https://github.com/pingcap/tidb/issues/7073
