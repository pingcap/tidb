# Proposal: Sync Load V2

- Author(s): [hawkingrei](https://github.com/hawkingrei)
- Tracking Issue: https://github.com/pingcap/tidb/issues/52831

##  Background 
Sync load first appeared starting from v5.4. But when we deal with Some customers' oncall, we find the metrics has too many 
timeouts on the sync load. It is odd. So we research through the implementation of sync load, identified many issues, and proposed an improvement plan.

## What is sync load

Sync load is to load stats that users use to query.  The trigger point for sync load is within logical optimization.
So that it can improve the completeness of statistics for SQL optimization. 

## Problem
1. sync load cannot set the upper limit to retry.
https://github.com/pingcap/tidb/issues/52657
https://github.com/pingcap/tidb/pull/52658

```SubLoadWorker``` will get the load task from the channel. Then start to load stats. But if HandleOneTaskreturn an error,
it will retry. But it has no limit on the retry. 

2. wrong implementation for singleflight 
In the old sync load , we don't use the Golang official singleflight and implement it by ourselves. It has a problem. 
In general, identical requests will be merged into a single request, and sent to the backend to avoid an excess of requests, 
and at the same time, all requests will be blocked to await the response. But in the old implementation, the same requests 
cannot wait and continue to optimize tasks. It will get pseudo statistics to make the unstable plan.

3. The architecture of singleflight has problems

before

All items the query needs will be put into the global task channel( the default capacity is 1000). And workers will merge the same task with the singleflight. So performance depends on the number of tasks that can be concurrently executed. 
Under poor performance conditions, he will not be able to handle a sufficient number of tasks, resulting in slow processing. But there are still many same tasks in the channel. So they still need to check whether to sync load. And They will fill up this channel. Query can not insert the sync load task into it and load necessary stats.

after

So we need to refactor this code. We need first to let the query pass through singleflight to merge identical tasks. Then insert the task into the channel to make the worker syncload it.

So why is it that during the startup of Wetech, the queries are very unstable and there are severe timeouts with sync load? The problem lies right here.

4. Cannot batch load stats
A query containing a wide table will load more statistics from tikv,  But we can only load these statistical pieces of information one by one. 

For better performance, we need to make workers batch load. Workers can collect enough tasks within a certain time frame, and then make them into a SQL to load data .

5. The number of workers cannot be adaptive
The number of stats load workers is constant when tidb starts to work. But the better the machine is, the higher the QPS is, and the more init stats are.  For the large clusters, the number of workers can  be higher to meet the needs.
So a simple way is to adjust the number of workers based on the CPU count of the machine.  For example, it looks like this. And users can set it by hand.

