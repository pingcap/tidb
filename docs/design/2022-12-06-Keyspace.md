# Proposal: Keyspace
* Authors: [ystaticy](https://github.com/ystaticy), [iosmanthus](https://github.com/iosmanthus), [AmoebaProtozoa](https://github.com/AmoebaProtozoa)


## Motivation
We hope to store data of multiple applications in a TiKV cluster.
For example in multi-tenant scenario.A common solution is to add a prefix in front of the key to distinguish the data of multiple applications.
So we introduce a new concept 'Keyspace' to describe the logical of the isolation with different business scenarios in a TiKV cluster.


## Keyspace key prefix
Keyspace can only be used when TiKV enabled api v2.
### Key encoding:
We use different key prefix to distinguish different Keyspace.
[Keyspace key encoding](https://github.com/tikv/rfcs/blob/master/text/0069-api-v2.md#key-encoding)

'x', 'r' are key mode prefixes that indicates which mode the key is belonging to.
After mode prefix is 3 bytes for keyspace.
1. `x`: It represent TxnKV key.
2. `r`: It represent RawKV key.

So when TiDB enabled Keyspace, there are 4 bytes in key more than the scenario which does not use Keyspace.
It will start with 'x' + keyspace Id (3 bytes) ,because TiDB uses TxnKV client.

### Keyspace ID
Behind key mode, it take 3 bytes to store `keyspaceID`, the default keyspaceID is `[0, 0, 0]`.
The max keyspace id is 16777216; Keyspace ID is allocated by PD createKeyspace interface.

## Architecture
![group and expression](./imgs/keyspace-arch.png)
### PD
PD is responsible for Keyspace Meta managment.
It provide http interface and RPC interface to create, load, change state or configuration Keyspace Meta.
Keyspace Meta store in etcd data in PD.

### Client-go
Compare with API V1. API V2 add 1 byte Keymode and 3 bytes keyspace Id in front of userkey.

### TiDB
A tenant can have multiple TiDB nodes. But a TiDB node can only serve one tenant.
It can enabled by tidb configuration by `keyspace-name`.

### TiKV
TiKV should enable API V2, and different keyspace will distinguish by different key prefix.

## Implementation

### PD
To be supplemented in another PR

### TiDB
#### Using API V2 and etcd namespace to distinguish TiKV data and etcd path by Keyspace.
1. Configure Keyspace name by setting `keyspace-name` in the configuration file.
   * When TiDB server start, it will open a TiKV driver. The driver have a TxnKV client object `tikv.KVStore`. If `keyspace-name` has been set, it will start to use `tikv.KVStore` by API V2 to access TiKV.
2. The etcd path should has different prefix by etcd namespace.
   * There is a etcd client be created when domain init. If `keyspace-name` has been set, it will add a etcd namespace when create etcd client.
   * The format of etcd namespace is `/keyspaces/tidb/$keyspaceId`.

#### TiDB BR support Keyspace
To be supplemented in another PR

### TiKV
#### client-go
To be supplemented in another PR
#### Coprocessor
To be supplemented in another PR



