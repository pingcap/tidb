# Proposal: support `pinyin` order for `utf8mb4/utf8` charset

- Author(s):     [xiongjiwei](https://github.com/xiongjiwei)
- Last updated:  2020-09-12
- Discussion at: https://github.com/pingcap/tidb/issues/19747

## Abstract
This proposal proposes a new feature that supports `pinyin` order for chinese character.

## Background
It's unable now to order by a column based on it's pinyin order. For example:

```sql
create table t(
	a varchar(100)
)
charset = 'utf8mb4' collate = 'utf8mb4_zh_0900_as_cs';

# insert some data:
insert into t values ("中文"), ("啊中文");

# a query requires to order by column a in its pinyin order:
select * from t order by a;
+-----------+
| a         |
+-----------+
| 啊中文    |
| 中文      |
+-----------+
2 rows in set (0.00 sec)
```

## Proposal

Term `tidb_utf8_general_zh_cs` is `pinyin` order for `utf8` charset.

Term `tidb_utf8mb4_general_zh_cs` is `pinyin` order for `utf8mb4` charset.

### Discuss: should we support pinyin order for `tidb_utf8_general_zh_cs` charset. 

#### Advantages

`utf8` charset can use `pinyin` order.

#### Disadvantages

`utf8` charset is not the standard `Unicode` encode, `utf8_xxx` are collations of the deprecated character set UTF8MB3, MySQL do not have any `0900` `UCA` collation. We can do better than MySQL.

**This proposal assume that we support `tidb_utf8_general_zh_cs`.**

`pinyin` order for Chinese character supported by this proposal will add two new collation named `tidb_utf8_general_zh_cs` and `tidb_utf8mb4_general_zh_cs` which are exactly same with `gbk_bin`.

choose collation ID `2048` for `tidb_utf8_general_zh_cs`, collation ID `2049` for `tidb_utf8mb4_general_zh_cs`.

> MySQL supports two-byte collation IDs. The range of IDs from 1024 to 2047 is reserved for user-defined collations. [see also](https://dev.mysql.com/doc/refman/8.0/en/adding-collation-choosing-id.html)

Following SQL statements are exactly same.
```sql
select * from t order by a collate tidb_utf8mb4_general_zh_cs;
select * from t order by convert(a using gbk) collate gbk_bin;
```

## Rationale

### Compare

convert `utf8mb4/utf8` encode to `gbk` encode and sort them as `gbk` code point order.

### Key

The `key` of `tidb_utf8(mb4)_general_zh_cs` is same as collation `gbk_bin`.

### Alternative
MySQL has a lot of language specific collation, for `pinyin` order, MySQL use collation `utf8mb4_zh_0900_as_cs`. It's a lot of work if implements `utf8mb4_zh_0900_as_cs`.


## Compatibility and Mirgration Plan

### Compatibility issues with MySQL

There is no `tidb_utf8_general_zh_cs` or `tidb_utf8mb4_general_zh_cs` collation in MySQL.

## Open issues (if applicable)

https://github.com/pingcap/tidb/issues/19747

https://github.com/pingcap/tidb/issues/10192
