--echo // materialized view: FAST refresh on TiKV (selection + update/delete + min/max)
drop database if exists mv_refresh_fast_tikv;
create database mv_refresh_fast_tikv;
use mv_refresh_fast_tikv;

set @@tidb_enable_materialized_view = 1;
set @@tidb_isolation_read_engines="tikv";
set @@tidb_allow_mpp=0;
set @@tidb_enforce_mpp=0;

create table t (id int primary key, a int, b int);
create materialized view log on t(a,b);

insert into t values (1,1,10),(2,1,20),(3,null,5),(4,2,0);
create materialized view mv as
  select a, count(*) as cnt, sum(b) as sb, min(b) as mn, max(b) as mx
    from t
   where b > 0
   group by a
   refresh fast every 60;

insert into t values (5,1,30);
update t set b = 0 where id = 2;
delete from t where id = 1;
insert into t values (6,null,7);
update t set a = 2, b = 9 where id = 4;

admin refresh materialized view mv fast;

set @mv_id := (select tidb_table_id from information_schema.tables where table_schema='mv_refresh_fast_tikv' and table_name='mv');
set @last_tso := (select last_refresh_tso from mysql.mv_refresh_info where mv_id = @mv_id);

set @@tidb_snapshot = @last_tso;
select a, count(*) as cnt, sum(b) as sb, min(b) as mn, max(b) as mx
  from t
 where b > 0
 group by a
 order by a;
set @@tidb_snapshot = '';

select * from mv order by a;

drop database if exists mv_refresh_fast_tikv;

set @@tidb_isolation_read_engines="tidb,tikv,tiflash";
set @@tidb_allow_mpp=0;
set @@tidb_enforce_mpp=0;

