drop table if exists t_varchar, t_char, t_text, t_multi_col, t_no_prefix;
create table t_varchar (
id int primary key auto_increment,
name varchar(255),
data varchar(100),
index idx_name_prefix (name(10))
);
create table t_char (
id int primary key auto_increment,
code char(50),
value int,
index idx_code_prefix (code(8))
);
create table t_text (
id int primary key auto_increment,
content text,
score int,
index idx_content_prefix (content(20))
);
create table t_multi_col (
id int primary key auto_increment,
a int,
b varchar(100),
c varchar(100),
index idx_a_b_prefix (a, b(15)),
index idx_a_b_c_prefix (a, b, c(10))
);
create table t_no_prefix (
id int primary key auto_increment,
name varchar(255),
data varchar(100),
index idx_name (name)
);
insert into t_varchar (name, data) values
('apple', 'fruit'),
('apricot', 'fruit'),
('application', 'software'),
('banana', 'fruit'),
('blueberry', 'fruit'),
('cherry', 'fruit'),
('date', 'fruit'),
('elderberry', 'fruit'),
('fig', 'fruit'),
('grape', 'fruit');
insert into t_char (code, value) values
('ABC12345', 100),
('ABC12346', 200),
('ABC12347', 300),
('DEF12345', 400),
('DEF12346', 500),
('GHI12345', 600),
('GHI12346', 700),
('JKL12345', 800),
('JKL12346', 900),
('MNO12345', 1000);
insert into t_text (content, score) values
('This is a long text content for testing', 10),
('Another long text content here', 20),
('Some more text data for testing purposes', 30),
('Text content with different prefix', 40),
('Testing partial order optimization', 50),
('More test data with various lengths', 60),
('Short text', 70),
('Medium length text content', 80),
('Very long text content that exceeds the prefix length significantly', 90),
('Final test text content', 100);
insert into t_multi_col (a, b, c) values
(1, 'alpha', 'first'),
(1, 'beta', 'second'),
(1, 'gamma', 'third'),
(2, 'alpha', 'fourth'),
(2, 'beta', 'fifth'),
(2, 'gamma', 'sixth'),
(3, 'alpha', 'seventh'),
(3, 'beta', 'eighth'),
(3, 'gamma', 'ninth'),
(3, 'delta', 'tenth');
insert into t_no_prefix (name, data) values
('apple', 'fruit'),
('apricot', 'fruit'),
('application', 'software'),
('banana', 'fruit'),
('blueberry', 'fruit');
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
DISABLE
set @@tidb_opt_partial_ordered_index_for_topn = 'DISABLE';
explain format='brief' select * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─TableReader	5.00	root		data:TopN
  └─TopN	5.00	cop[tikv]		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
    └─TableFullScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select * from t_varchar where data = 'fruit' order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─TableReader	5.00	root		data:TopN
  └─TopN	5.00	cop[tikv]		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
    └─Selection	10.00	cop[tikv]		eq(planner__core__partial_order_topn.t_varchar.data, "fruit")
      └─TableFullScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select * from t_multi_col where a = 1 order by b limit 5;
id	estRows	task	access object	operator info
IndexLookUp	5.00	root		limit embedded(offset:0, count:5)
├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5
│ └─IndexRangeScan	5.00	cop[tikv]	table:t_multi_col, index:idx_a_b_c_prefix(a, b, c)	range:[1,1], keep order:true, stats:pseudo
└─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
set @@tidb_opt_partial_ordered_index_for_topn = 'COST';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
COST
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_char, idx_code_prefix) */ * from t_char order by code limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_char.code, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_char, index:idx_code_prefix(code)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_char	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_text, idx_content_prefix) */ * from t_text order by content limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_text.content, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_text.content, prefix_len:20
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_text.content, prefix_len:20
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_text, index:idx_content_prefix(content)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_text	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */ * from t_varchar where name like 'ap%' order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	250.00	root		
  ├─IndexRangeScan(Build)	250.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	range:["ap","aq"), keep order:true, stats:pseudo
  └─Selection(Probe)	250.00	cop[tikv]		like(planner__core__partial_order_topn.t_varchar.name, "ap%", 92)
    └─TableRowIDScan	250.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */ * from t_varchar where data = 'fruit' order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	10.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─Selection(Probe)	10.00	cop[tikv]		eq(planner__core__partial_order_topn.t_varchar.data, "fruit")
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_char, idx_code_prefix) */ * from t_char where value > 300 order by code limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_char.code, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
└─IndexLookUp	3333.33	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_char, index:idx_code_prefix(code)	keep order:true, stats:pseudo
  └─Selection(Probe)	3333.33	cop[tikv]		gt(planner__core__partial_order_topn.t_char.value, 300)
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_char	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_text, idx_content_prefix) */ * from t_text where score < 80 order by content limit 3;
id	estRows	task	access object	operator info
TopN	3.00	root		planner__core__partial_order_topn.t_text.content, offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_text.content, prefix_len:20
└─IndexLookUp	3323.33	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_text, index:idx_content_prefix(content)	keep order:true, stats:pseudo
  └─Selection(Probe)	3323.33	cop[tikv]		lt(planner__core__partial_order_topn.t_text.score, 80)
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_text	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */ id, inner_name from (select id, name as inner_name from t_varchar) tmp order by inner_name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_char, idx_code_prefix) */ id, code as c from t_char order by code limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_char.code, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_char, index:idx_code_prefix(code)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_char	keep order:false, stats:pseudo
explain format='brief' select  /*+ use_index(t_varchar, idx_name_prefix) */ id, name from t_varchar where data = 'fruit' order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	10.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─Selection(Probe)	10.00	cop[tikv]		eq(planner__core__partial_order_topn.t_varchar.data, "fruit")
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select  /*+ use_index(t_char, idx_code_prefix) */ id, code as c from t_char where value > 200 order by code limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_char.code, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
└─IndexLookUp	3333.33	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_char, index:idx_code_prefix(code)	keep order:true, stats:pseudo
  └─Selection(Probe)	3333.33	cop[tikv]		gt(planner__core__partial_order_topn.t_char.value, 200)
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_char	keep order:false, stats:pseudo
explain format='brief' select  /*+ use_index(t_varchar, idx_name_prefix) */ id, name from t_varchar where data = 'fruit' order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	10.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─Selection(Probe)	10.00	cop[tikv]		eq(planner__core__partial_order_topn.t_varchar.data, "fruit")
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_multi_col, idx_a_b_prefix) */ * from t_multi_col where a = 1 order by b limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_multi_col.b, offset:0, count:5
└─IndexLookUp	5.00	root		
  ├─IndexRangeScan(Build)	10.00	cop[tikv]	table:t_multi_col, index:idx_a_b_prefix(a, b)	range:[1,1], keep order:false, stats:pseudo
  └─TopN(Probe)	5.00	cop[tikv]		planner__core__partial_order_topn.t_multi_col.b, offset:0, count:5
    └─TableRowIDScan	10.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_multi_col, idx_a_b_prefix) */  * from t_multi_col order by a, b limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.b, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_multi_col.b, prefix_len:15
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_multi_col.b, prefix_len:15
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_multi_col, index:idx_a_b_prefix(a, b)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_multi_col, idx_a_b_c_prefix) */  * from t_multi_col order by a, b, c limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.b, planner__core__partial_order_topn.t_multi_col.c, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_multi_col.c, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_multi_col.c, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_multi_col, index:idx_a_b_c_prefix(a, b, c)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */  * from t_varchar order by name limit 5 offset 3;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:3, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	8.00	root		
  ├─Limit(Build)	8.00	cop[tikv]		offset:0, count:8, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	8.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */  * from t_varchar order by name limit 10 offset 5;
id	estRows	task	access object	operator info
TopN	10.00	root		planner__core__partial_order_topn.t_varchar.name, offset:5, count:10, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	15.00	root		
  ├─Limit(Build)	15.00	cop[tikv]		offset:0, count:15, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	15.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select  /*+ use_index(t_varchar, idx_name_prefix) */  * from t_varchar order by name desc limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name:desc, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, desc, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select   /*+ use_index(t_char, idx_code_prefix) */ * from t_char order by code desc limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_char.code:desc, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_char.code, prefix_len:8
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_char, index:idx_code_prefix(code)	keep order:true, desc, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_char	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_no_prefix, idx_name) */ * from t_no_prefix order by name limit 5;
id	estRows	task	access object	operator info
IndexLookUp	5.00	root		limit embedded(offset:0, count:5)
├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5
│ └─IndexFullScan	5.00	cop[tikv]	table:t_no_prefix, index:idx_name(name)	keep order:true, stats:pseudo
└─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_no_prefix	keep order:false, stats:pseudo
explain format='brief' select /*+ use_index(t_multi_col, idx_a_b_prefix) */ * from t_multi_col order by a, c limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.c, offset:0, count:5
└─IndexLookUp	5.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_multi_col, index:idx_a_b_prefix(a, b)	keep order:false, stats:pseudo
  └─TopN(Probe)	5.00	cop[tikv]		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.c, offset:0, count:5
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select  /*+ use_index(t_multi_col, idx_a_b_prefix) */ * from t_multi_col order by a asc, b desc limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.b:desc, offset:0, count:5
└─IndexLookUp	5.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_multi_col, index:idx_a_b_prefix(a, b)	keep order:false, stats:pseudo
  └─TopN(Probe)	5.00	cop[tikv]		planner__core__partial_order_topn.t_multi_col.a, planner__core__partial_order_topn.t_multi_col.b:desc, offset:0, count:5
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by upper(name) limit 5;
id	estRows	task	access object	operator info
Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data
└─TopN	5.00	root		Column#5, offset:0, count:5
  └─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data, upper(planner__core__partial_order_topn.t_varchar.name)->Column#5
    └─IndexLookUp	5.00	root		
      ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
      └─TopN(Probe)	5.00	cop[tikv]		upper(planner__core__partial_order_topn.t_varchar.name), offset:0, count:5
        └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by concat(name, data) limit 5;
id	estRows	task	access object	operator info
Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data
└─TopN	5.00	root		Column#5, offset:0, count:5
  └─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data, concat(planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data)->Column#5
    └─IndexLookUp	5.00	root		
      ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
      └─TopN(Probe)	5.00	cop[tikv]		concat(planner__core__partial_order_topn.t_varchar.name, planner__core__partial_order_topn.t_varchar.data), offset:0, count:5
        └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_multi_col, idx_a_b_prefix) */ * from t_multi_col order by a limit 5;
id	estRows	task	access object	operator info
IndexLookUp	5.00	root		limit embedded(offset:0, count:5)
├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5
│ └─IndexFullScan	5.00	cop[tikv]	table:t_multi_col, index:idx_a_b_prefix(a, b)	keep order:true, stats:pseudo
└─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_multi_col	keep order:false, stats:pseudo
explain format='brief' select  /*+ force_index(t_no_prefix, idx_name) */ * from t_no_prefix order by name limit 5;
id	estRows	task	access object	operator info
IndexLookUp	5.00	root		limit embedded(offset:0, count:5)
├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5
│ └─IndexFullScan	5.00	cop[tikv]	table:t_no_prefix, index:idx_name(name)	keep order:true, stats:pseudo
└─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_no_prefix	keep order:false, stats:pseudo
drop table if exists t_join1, t_join2;
create table t_join1 (id int primary key, name varchar(100), index idx_name(name(10)));
create table t_join2 (id int primary key, ref_id int);
insert into t_join1 values (1, 'alpha'), (2, 'beta'), (3, 'gamma');
insert into t_join2 values (1, 1), (2, 2), (3, 3);
explain format='brief' select t_join1.* from t_join1 join t_join2 on t_join1.id = t_join2.ref_id order by t_join1.name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_join1.name, offset:0, count:5
└─HashJoin	12487.50	root		inner join, equal:[eq(planner__core__partial_order_topn.t_join2.ref_id, planner__core__partial_order_topn.t_join1.id)]
  ├─TableReader(Build)	9990.00	root		data:Selection
  │ └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__partial_order_topn.t_join2.ref_id))
  │   └─TableFullScan	10000.00	cop[tikv]	table:t_join2	keep order:false, stats:pseudo
  └─TableReader(Probe)	10000.00	root		data:TableFullScan
    └─TableFullScan	10000.00	cop[tikv]	table:t_join1	keep order:false, stats:pseudo
explain format='brief' select name, count(*) from t_varchar group by name order by name limit 5;
id	estRows	task	access object	operator info
Projection	5.00	root		planner__core__partial_order_topn.t_varchar.name, Column#5
└─TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
  └─HashAgg	8000.00	root		group by:planner__core__partial_order_topn.t_varchar.name, funcs:count(Column#6)->Column#5, funcs:firstrow(planner__core__partial_order_topn.t_varchar.name)->planner__core__partial_order_topn.t_varchar.name
    └─TableReader	8000.00	root		data:HashAgg
      └─HashAgg	8000.00	cop[tikv]		group by:planner__core__partial_order_topn.t_varchar.name, funcs:count(1)->Column#6
        └─TableFullScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' (select name from t_varchar order by name limit 3) union all (select name from t_no_prefix order by name limit 3) order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		Column#9, offset:0, count:5
└─Union	6.00	root		
  ├─Limit	3.00	root		offset:0, count:5
  │ └─TopN	3.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │   └─Projection	3.00	root		planner__core__partial_order_topn.t_varchar.name
  │     └─IndexLookUp	3.00	root		
  │       ├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │       │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  │       └─TableRowIDScan(Probe)	3.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
  └─Limit	3.00	root		offset:0, count:5
    └─Limit	3.00	root		offset:0, count:3
      └─IndexReader	3.00	root		index:Limit
        └─Limit	3.00	cop[tikv]		offset:0, count:3
          └─IndexFullScan	3.00	cop[tikv]	table:t_no_prefix, index:idx_name(name)	keep order:true, stats:pseudo
explain format='brief' select  /*+ force_index(t_varchar, idx_name_prefix) */ id, upper(name) as upper_name from t_varchar order by upper_name limit 5;
id	estRows	task	access object	operator info
Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, upper(planner__core__partial_order_topn.t_varchar.name)->Column#5
└─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name
  └─TopN	5.00	root		Column#6, offset:0, count:5
    └─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, upper(planner__core__partial_order_topn.t_varchar.name)->Column#6
      └─IndexLookUp	5.00	root		
        ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
        └─TopN(Probe)	5.00	cop[tikv]		upper(planner__core__partial_order_topn.t_varchar.name), offset:0, count:5
          └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ id, length(name) as name_len from t_varchar order by name_len limit 5;
id	estRows	task	access object	operator info
Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, length(planner__core__partial_order_topn.t_varchar.name)->Column#5
└─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name
  └─TopN	5.00	root		Column#6, offset:0, count:5
    └─Projection	5.00	root		planner__core__partial_order_topn.t_varchar.id, planner__core__partial_order_topn.t_varchar.name, length(planner__core__partial_order_topn.t_varchar.name)->Column#6
      └─IndexLookUp	5.00	root		
        ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
        └─TopN(Probe)	5.00	cop[tikv]		length(planner__core__partial_order_topn.t_varchar.name), offset:0, count:5
          └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
begin;
insert into t_varchar (name, data) values ('zebra', 'animal');
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─UnionScan	10000.00	root		
  └─IndexLookUp	10000.00	root		
    ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
    └─TableRowIDScan(Probe)	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
rollback;
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
begin;
update t_varchar set data = 'modified' where id = 1;
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─UnionScan	10000.00	root		
  └─IndexLookUp	10000.00	root		
    ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
    └─TableRowIDScan(Probe)	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
rollback;
begin;
delete from t_varchar where id = 1;
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─UnionScan	10000.00	root		
  └─IndexLookUp	10000.00	root		
    ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
    └─TableRowIDScan(Probe)	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
rollback;
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 1;
id	estRows	task	access object	operator info
TopN	1.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:1, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	1.00	root		
  ├─Limit(Build)	1.00	cop[tikv]		offset:0, count:1, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	1.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 100;
id	estRows	task	access object	operator info
TopN	100.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:100, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	100.00	root		
  ├─Limit(Build)	100.00	cop[tikv]		offset:0, count:100, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	100.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */ * from t_varchar order by name limit 1000;
id	estRows	task	access object	operator info
TopN	1000.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:1000, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	1000.00	root		
  ├─Limit(Build)	1000.00	cop[tikv]		offset:0, count:1000, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	1000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
drop table if exists t_empty;
create table t_empty (id int primary key, name varchar(100), index idx_name(name(10)));
explain format='brief' select /*+ force_index(t_empty, idx_name) */ * from t_empty order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_empty.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_empty.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_empty.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_empty, index:idx_name(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_empty	keep order:false, stats:pseudo
drop table if exists t_prefix_len;
create table t_prefix_len (
id int primary key auto_increment,
short_prefix varchar(100),
long_prefix varchar(100),
index idx_short (short_prefix(5)),
index idx_long (long_prefix(50))
);
insert into t_prefix_len (short_prefix, long_prefix) values
('abcdefghij', 'abcdefghijklmnopqrstuvwxyz'),
('abcdefghik', 'abcdefghijklmnopqrstuvwxya'),
('abcdefghil', 'abcdefghijklmnopqrstuvwxyb'),
('xyzdefghij', 'xyzdefghijklmnopqrstuvwxyz'),
('xyzdefghik', 'xyzdefghijklmnopqrstuvwxya');
explain format='brief' select  /*+ force_index(t_prefix_len, idx_short) */  * from t_prefix_len order by short_prefix limit 3;
id	estRows	task	access object	operator info
TopN	3.00	root		planner__core__partial_order_topn.t_prefix_len.short_prefix, offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_prefix_len.short_prefix, prefix_len:5
└─IndexLookUp	3.00	root		
  ├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_prefix_len.short_prefix, prefix_len:5
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_prefix_len, index:idx_short(short_prefix)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	3.00	cop[tikv]	table:t_prefix_len	keep order:false, stats:pseudo
explain format='brief' select  /*+ force_index(t_prefix_len, long_prefix) */  * from t_prefix_len order by long_prefix limit 3;
id	estRows	task	access object	operator info
TopN	3.00	root		planner__core__partial_order_topn.t_prefix_len.long_prefix, offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_prefix_len.long_prefix, prefix_len:50
└─IndexLookUp	3.00	root		
  ├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3, prefix_col:planner__core__partial_order_topn.t_prefix_len.long_prefix, prefix_len:50
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_prefix_len, index:idx_long(long_prefix)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	3.00	cop[tikv]	table:t_prefix_len	keep order:false, stats:pseudo
set @@tidb_opt_partial_ordered_index_for_topn = 'DISABLE';
explain format='brief' select /*+ force_index(t_varchar, idx_name_prefix) */  * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
└─IndexLookUp	5.00	root		
  ├─IndexFullScan(Build)	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:false, stats:pseudo
  └─TopN(Probe)	5.00	cop[tikv]		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5
    └─TableRowIDScan	10000.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
set @@tidb_opt_partial_ordered_index_for_topn = 'COST';
explain format='brief' select  /*+ force_index(t_varchar, idx_name_prefix) */   * from t_varchar order by name limit 5;
id	estRows	task	access object	operator info
TopN	5.00	root		planner__core__partial_order_topn.t_varchar.name, offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
└─IndexLookUp	5.00	root		
  ├─Limit(Build)	5.00	cop[tikv]		offset:0, count:5, prefix_col:planner__core__partial_order_topn.t_varchar.name, prefix_len:10
  │ └─IndexFullScan	10000.00	cop[tikv]	table:t_varchar, index:idx_name_prefix(name)	keep order:true, stats:pseudo
  └─TableRowIDScan(Probe)	5.00	cop[tikv]	table:t_varchar	keep order:false, stats:pseudo
set @@tidb_opt_partial_ordered_index_for_topn = DEFAULT;
set @@tidb_opt_partial_ordered_index_for_topn = 'cost';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
COST
set @@tidb_opt_partial_ordered_index_for_topn = 'Cost';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
COST
set @@tidb_opt_partial_ordered_index_for_topn = 'COST';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
COST
set @@tidb_opt_partial_ordered_index_for_topn = 'disable';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
DISABLE
set @@tidb_opt_partial_ordered_index_for_topn = 'Disable';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
DISABLE
set @@tidb_opt_partial_ordered_index_for_topn = 'DISABLE';
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
DISABLE
set @@tidb_opt_partial_ordered_index_for_topn = 'ON';
Error 1231 (42000): Variable 'tidb_opt_partial_ordered_index_for_topn' can't be set to the value of 'ON'
set @@tidb_opt_partial_ordered_index_for_topn = 'OFF';
Error 1231 (42000): Variable 'tidb_opt_partial_ordered_index_for_topn' can't be set to the value of 'OFF'
set @@tidb_opt_partial_ordered_index_for_topn = 1;
Error 1231 (42000): Variable 'tidb_opt_partial_ordered_index_for_topn' can't be set to the value of '1'
set @@tidb_opt_partial_ordered_index_for_topn = 0;
Error 1231 (42000): Variable 'tidb_opt_partial_ordered_index_for_topn' can't be set to the value of '0'
set @@tidb_opt_partial_ordered_index_for_topn = DEFAULT;
select @@tidb_opt_partial_ordered_index_for_topn;
@@tidb_opt_partial_ordered_index_for_topn
DISABLE
drop table if exists t_varchar, t_char, t_text, t_multi_col, t_no_prefix;
drop table if exists t_join1, t_join2, t_empty, t_prefix_len, t_null;
