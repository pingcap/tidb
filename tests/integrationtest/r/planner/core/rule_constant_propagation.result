drop table if exists t, s;
create table t (id int, name varchar(10));
create table s (id int, name varchar(10));
explain format='brief' select * from t, (select * from s where s.id>1) tmp where t.id=tmp.id; -- inner join;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select * from s where s.id>1) tmp where t.name=tmp.name; -- can't, without id equal predicate;
id	estRows	task	access object	operator info
Projection	4162.50	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, planner__core__rule_constant_propagation.s.id, planner__core__rule_constant_propagation.s.name
└─HashJoin	4162.50	root		inner join, equal:[eq(planner__core__rule_constant_propagation.s.name, planner__core__rule_constant_propagation.t.name)]
  ├─TableReader(Build)	3330.00	root		data:Selection
  │ └─Selection	3330.00	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.name))
  │   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  └─TableReader(Probe)	9990.00	root		data:Selection
    └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__rule_constant_propagation.t.name))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select name from s where s.id>1) tmp where t.name=tmp.name; -- can't, projection without id column;
id	estRows	task	access object	operator info
Projection	4162.50	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, planner__core__rule_constant_propagation.s.name
└─HashJoin	4162.50	root		inner join, equal:[eq(planner__core__rule_constant_propagation.s.name, planner__core__rule_constant_propagation.t.name)]
  ├─TableReader(Build)	3330.00	root		data:Selection
  │ └─Selection	3330.00	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.name))
  │   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  └─TableReader(Probe)	9990.00	root		data:Selection
    └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__rule_constant_propagation.t.name))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select id as id1, name as name1 from s where s.id>1) tmp where t.id=tmp.id1; -- projection above of s.id>1;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select id +1 as id1 from s where s.id>1) tmp where t.id=tmp.id1; -- can't optimize, projection has column function;
id	estRows	task	access object	operator info
Projection	3333.33	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, Column#7
└─HashJoin	3333.33	root		inner join, equal:[eq(Column#7, planner__core__rule_constant_propagation.t.id)]
  ├─Projection(Build)	2666.67	root		plus(planner__core__rule_constant_propagation.s.id, 1)->Column#7
  │ └─TableReader	2666.67	root		data:Selection
  │   └─Selection	2666.67	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(plus(planner__core__rule_constant_propagation.s.id, 1)))
  │     └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  └─TableReader(Probe)	9990.00	root		data:Selection
    └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__rule_constant_propagation.t.id))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
drop table if exists t, s;
create table t (id int, name varchar(10));
create table s (id int, name varchar(10));
explain format='brief' select * from (select * from t where t.id >1) tmp1, (select * from s where s.id <4) tmp2 where tmp1.id=tmp2.id; -- inner join, both children can be optimized;
id	estRows	task	access object	operator info
HashJoin	312.50	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	250.00	root		data:Selection
│ └─Selection	250.00	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), lt(planner__core__rule_constant_propagation.s.id, 4), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	250.00	root		data:Selection
  └─Selection	250.00	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), lt(planner__core__rule_constant_propagation.t.id, 4), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from (select * from t where t.id>1) tmp, s where tmp.id=s.id; -- inner join, child 0;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from (select * from t where t.id>1) tmp left join s on tmp.id=s.id; -- left join, only left child can be optimized;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		left outer join, left side:TableReader, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1)
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t left join (select * from s where s.id>1) tmp on t.id=tmp.id; -- can't, left join;
id	estRows	task	access object	operator info
HashJoin	10000.00	root		left outer join, left side:TableReader, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t right join (select * from s where s.id>1) tmp on t.id=tmp.id; -- right join, only right child can be optimized;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		right outer join, left side:TableReader, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1)
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from (select * from t where t.id>1) tmp  right join s on tmp.id=s.id; -- can't, right join;
id	estRows	task	access object	operator info
HashJoin	10000.00	root		right outer join, left side:TableReader, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
drop table if exists t, s;
create table t (id int, name varchar(10));
create table s (id int, name varchar(10));
explain format='brief' select * from t, (select id as id1 from s where s.id>1) tmp where t.id=tmp.id1; -- constant propagation can through the projection node;
id	estRows	task	access object	operator info
HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
├─TableReader(Build)	3333.33	root		data:Selection
│ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
└─TableReader(Probe)	3333.33	root		data:Selection
  └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select id, count(name) from s where s.id>1 group by id) tmp where t.id=tmp.id; -- can't, constant propagation can't through the aggregation node;
id	estRows	task	access object	operator info
Projection	3333.33	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, planner__core__rule_constant_propagation.s.id, Column#7
└─Projection	3333.33	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, Column#7, planner__core__rule_constant_propagation.s.id
  └─HashJoin	3333.33	root		inner join, equal:[eq(planner__core__rule_constant_propagation.s.id, planner__core__rule_constant_propagation.t.id)]
    ├─HashAgg(Build)	2666.67	root		group by:planner__core__rule_constant_propagation.s.id, funcs:count(Column#8)->Column#7, funcs:firstrow(planner__core__rule_constant_propagation.s.id)->planner__core__rule_constant_propagation.s.id
    │ └─TableReader	2666.67	root		data:HashAgg
    │   └─HashAgg	2666.67	cop[tikv]		group by:planner__core__rule_constant_propagation.s.id, funcs:count(planner__core__rule_constant_propagation.s.name)->Column#8
    │     └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
    │       └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
    └─TableReader(Probe)	9990.00	root		data:Selection
      └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__rule_constant_propagation.t.id))
        └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
explain format='brief' select * from t, (select id from s where s.id>1 order by id limit 2) tmp where t.id=tmp.id; -- can't, constant propagation can't through the sort node;
id	estRows	task	access object	operator info
Projection	2.00	root		planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.t.name, planner__core__rule_constant_propagation.s.id
└─HashJoin	2.00	root		inner join, equal:[eq(planner__core__rule_constant_propagation.s.id, planner__core__rule_constant_propagation.t.id)]
  ├─Selection(Build)	1.60	root		not(isnull(planner__core__rule_constant_propagation.s.id))
  │ └─TopN	2.00	root		planner__core__rule_constant_propagation.s.id, offset:0, count:2
  │   └─TableReader	2.00	root		data:TopN
  │     └─TopN	2.00	cop[tikv]		planner__core__rule_constant_propagation.s.id, offset:0, count:2
  │       └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1)
  │         └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  └─TableReader(Probe)	9990.00	root		data:Selection
    └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__rule_constant_propagation.t.id))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
drop table if exists t, s;
create table t (id int, name varchar(10));
create table s (id int, name varchar(10));
explain format='brief' Update t, (select * from s where s.id>1) tmp set t.name=tmp.name where t.id=tmp.id;
id	estRows	task	access object	operator info
Update	N/A	root		N/A
└─HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
  ├─TableReader(Build)	3333.33	root		data:Selection
  │ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
  │   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  └─TableReader(Probe)	3333.33	root		data:Selection
    └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
drop table if exists t, s;
create table t (id int, name varchar(10));
create table s (id int, name varchar(10));
explain format='brief' select * from (select * from (select t.id+1 as id1, t.name from t, (select * from s where s.id>1) s1 where t.id=s1.id ) tmp order by id1) a union (select tmp.* from (select * from t where t.id <3) tmp left join s on tmp.id=s.id); -- match twice;
id	estRows	task	access object	operator info
HashAgg	5325.33	root		group by:Column#14, Column#15, funcs:firstrow(Column#14)->Column#14, funcs:firstrow(Column#15)->Column#15
└─Union	8320.83	root		
  ├─Projection	4166.67	root		plus(planner__core__rule_constant_propagation.t.id, 1)->Column#14, planner__core__rule_constant_propagation.t.name->Column#15
  │ └─HashJoin	4166.67	root		inner join, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
  │   ├─TableReader(Build)	3333.33	root		data:Selection
  │   │ └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.s.id, 1), not(isnull(planner__core__rule_constant_propagation.s.id))
  │   │   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
  │   └─TableReader(Probe)	3333.33	root		data:Selection
  │     └─Selection	3333.33	cop[tikv]		gt(planner__core__rule_constant_propagation.t.id, 1), not(isnull(planner__core__rule_constant_propagation.t.id))
  │       └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
  └─Projection	4154.17	root		cast(planner__core__rule_constant_propagation.t.id, bigint BINARY)->Column#14, planner__core__rule_constant_propagation.t.name->Column#15
    └─HashJoin	4154.17	root		left outer join, left side:TableReader, equal:[eq(planner__core__rule_constant_propagation.t.id, planner__core__rule_constant_propagation.s.id)]
      ├─TableReader(Build)	3323.33	root		data:Selection
      │ └─Selection	3323.33	cop[tikv]		lt(planner__core__rule_constant_propagation.s.id, 3), not(isnull(planner__core__rule_constant_propagation.s.id))
      │   └─TableFullScan	10000.00	cop[tikv]	table:s	keep order:false, stats:pseudo
      └─TableReader(Probe)	3323.33	root		data:Selection
        └─Selection	3323.33	cop[tikv]		lt(planner__core__rule_constant_propagation.t.id, 3)
          └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
