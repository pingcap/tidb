set tidb_cost_model_version=2;
set @@session.tidb_executor_concurrency = 4;
set @@session.tidb_hash_join_concurrency = 5;
set @@session.tidb_distsql_scan_concurrency = 15;
drop table if exists tbl;
create table tbl(a int, b int, c int, key idx_b_c(b,c));
insert into tbl values(1,1,1),(2,2,2),(3,3,3),(4,4,4),(5,5,5);
analyze table tbl;
explain format = 'brief' select * from tbl use index(idx_b_c) where b > 1 limit 2,1;
id	estRows	task	access object	operator info
IndexLookUp	1.00	root		limit embedded(offset:2, count:1)
├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3
│ └─IndexRangeScan	3.00	cop[tikv]	table:tbl, index:idx_b_c(b, c)	range:(1,+inf], keep order:false
└─TableRowIDScan(Probe)	1.00	cop[tikv]	table:tbl	keep order:false
explain format = 'brief' select * from tbl use index(idx_b_c) where b > 1 order by b desc limit 2,1;
id	estRows	task	access object	operator info
Projection	1.00	root		planner__core__casetest__pushdown__push_down.tbl.a, planner__core__casetest__pushdown__push_down.tbl.b, planner__core__casetest__pushdown__push_down.tbl.c
└─IndexLookUp	1.00	root		limit embedded(offset:2, count:1)
  ├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3
  │ └─IndexRangeScan	3.00	cop[tikv]	table:tbl, index:idx_b_c(b, c)	range:(1,+inf], keep order:true, desc
  └─TableRowIDScan(Probe)	1.00	cop[tikv]	table:tbl	keep order:false
explain format = 'brief' select * from tbl use index(idx_b_c) where b > 1 and c > 1 limit 2,1;
id	estRows	task	access object	operator info
IndexLookUp	1.00	root		limit embedded(offset:2, count:1)
├─Limit(Build)	3.00	cop[tikv]		offset:0, count:3
│ └─Selection	3.00	cop[tikv]		gt(planner__core__casetest__pushdown__push_down.tbl.c, 1)
│   └─IndexRangeScan	3.75	cop[tikv]	table:tbl, index:idx_b_c(b, c)	range:(1,+inf], keep order:false
└─TableRowIDScan(Probe)	1.00	cop[tikv]	table:tbl	keep order:false
explain format = 'brief' select * from tbl use index(idx_b_c) where b > 1 and a > 1 limit 2,1;
id	estRows	task	access object	operator info
Limit	1.00	root		offset:2, count:1
└─IndexLookUp	3.00	root		
  ├─IndexRangeScan(Build)	3.75	cop[tikv]	table:tbl, index:idx_b_c(b, c)	range:(1,+inf], keep order:false
  └─Limit(Probe)	3.00	cop[tikv]		offset:0, count:3
    └─Selection	3.00	cop[tikv]		gt(planner__core__casetest__pushdown__push_down.tbl.a, 1)
      └─TableRowIDScan	3.75	cop[tikv]	table:tbl	keep order:false
set tidb_cost_model_version=2;
drop table if exists t;
create table t (a int, b real, i int, id int, value decimal(6,3), name char(128), d decimal(6,3), s char(128), t datetime, c bigint as ((a+1)) virtual, e real as ((b+a)));
analyze table t;
set session tidb_opt_projection_push_down=1;
desc format = 'brief' select i * 2 from t;
id	estRows	task	access object	operator info
TableReader	10000.00	root		data:Projection
└─Projection	10000.00	cop[tikv]		mul(planner__core__casetest__pushdown__push_down.t.i, 2)->Column#13
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select DATE_FORMAT(t, '%Y-%m-%d %H') as date from t;
id	estRows	task	access object	operator info
TableReader	10000.00	root		data:Projection
└─Projection	10000.00	cop[tikv]		date_format(planner__core__casetest__pushdown__push_down.t.t, %Y-%m-%d %H)->Column#13
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select md5(s) from t;
id	estRows	task	access object	operator info
TableReader	10000.00	root		data:Projection
└─Projection	10000.00	cop[tikv]		md5(planner__core__casetest__pushdown__push_down.t.s)->Column#13
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select c from t where a+1=3;
id	estRows	task	access object	operator info
Projection	8000.00	root		planner__core__casetest__pushdown__push_down.t.c
└─TableReader	8000.00	root		data:Selection
  └─Selection	8000.00	cop[tikv]		eq(plus(planner__core__casetest__pushdown__push_down.t.a, 1), 3)
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ hash_agg()*/ count(b) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
HashAgg	1.00	root		funcs:count(Column#16)->Column#14
└─TableReader	1.00	root		data:HashAgg
  └─HashAgg	1.00	cop[tikv]		funcs:count(plus(planner__core__casetest__pushdown__push_down.t.id, 1))->Column#16
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ hash_agg()*/ count(*) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
HashAgg	1.00	root		funcs:count(Column#15)->Column#14
└─TableReader	1.00	root		data:HashAgg
  └─HashAgg	1.00	cop[tikv]		funcs:count(1)->Column#15
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ hash_agg()*/ sum(b) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
HashAgg	1.00	root		funcs:sum(Column#16)->Column#14
└─TableReader	1.00	root		data:HashAgg
  └─HashAgg	1.00	cop[tikv]		funcs:sum(plus(planner__core__casetest__pushdown__push_down.t.id, 1))->Column#16
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ stream_agg()*/ count(b) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
StreamAgg	1.00	root		funcs:count(Column#16)->Column#14
└─TableReader	1.00	root		data:StreamAgg
  └─StreamAgg	1.00	cop[tikv]		funcs:count(plus(planner__core__casetest__pushdown__push_down.t.id, 1))->Column#16
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ stream_agg()*/ count(*) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
StreamAgg	1.00	root		funcs:count(Column#15)->Column#14
└─TableReader	1.00	root		data:StreamAgg
  └─StreamAgg	1.00	cop[tikv]		funcs:count(1)->Column#15
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select /*+ stream_agg()*/ sum(b) from  (select id + 1 as b from t)A;
id	estRows	task	access object	operator info
StreamAgg	1.00	root		funcs:sum(Column#16)->Column#14
└─TableReader	1.00	root		data:StreamAgg
  └─StreamAgg	1.00	cop[tikv]		funcs:sum(plus(planner__core__casetest__pushdown__push_down.t.id, 1))->Column#16
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select * from (select id-2 as b from t) B join (select id-2 as b from t) A on A.b=B.b;
id	estRows	task	access object	operator info
HashJoin	10000.00	root		inner join, equal:[eq(Column#13, Column#26)]
├─TableReader(Build)	8000.00	root		data:Projection
│ └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#26
│   └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
│     └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	8000.00	root		data:Projection
  └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#13
    └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
      └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select * from t join (select id-2 as b from t) A on A.b=t.id;
id	estRows	task	access object	operator info
HashJoin	10000.00	root		inner join, equal:[eq(planner__core__casetest__pushdown__push_down.t.id, Column#25)]
├─TableReader(Build)	8000.00	root		data:Projection
│ └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#25
│   └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
│     └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	9990.00	root		data:Selection
  └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__casetest__pushdown__push_down.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select * from t left join (select id-2 as b from t) A on A.b=t.id;
id	estRows	task	access object	operator info
HashJoin	10000.00	root		left outer join, equal:[eq(planner__core__casetest__pushdown__push_down.t.id, Column#25)]
├─TableReader(Build)	8000.00	root		data:Projection
│ └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#25
│   └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
│     └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select * from t right join (select id-2 as b from t) A on A.b=t.id;
id	estRows	task	access object	operator info
HashJoin	12487.50	root		right outer join, equal:[eq(planner__core__casetest__pushdown__push_down.t.id, Column#25)]
├─TableReader(Build)	10000.00	root		data:Projection
│ └─Projection	10000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#25
│   └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	9990.00	root		data:Selection
  └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__casetest__pushdown__push_down.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select A.b, B.b from (select id-2 as b from t) B join (select id-2 as b from t) A on A.b=B.b;
id	estRows	task	access object	operator info
Projection	10000.00	root		Column#26, Column#13
└─HashJoin	10000.00	root		inner join, equal:[eq(Column#13, Column#26)]
  ├─TableReader(Build)	8000.00	root		data:Projection
  │ └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#26
  │   └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
  │     └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
  └─TableReader(Probe)	8000.00	root		data:Projection
    └─Projection	8000.00	cop[tikv]		minus(planner__core__casetest__pushdown__push_down.t.id, 2)->Column#13
      └─Selection	8000.00	cop[tikv]		not(isnull(minus(planner__core__casetest__pushdown__push_down.t.id, 2)))
        └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
desc format = 'brief' select A.id from t as A where exists (select 1 from t where t.id=A.id);
id	estRows	task	access object	operator info
HashJoin	7992.00	root		semi join, equal:[eq(planner__core__casetest__pushdown__push_down.t.id, planner__core__casetest__pushdown__push_down.t.id)]
├─TableReader(Build)	9990.00	root		data:Selection
│ └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__casetest__pushdown__push_down.t.id))
│   └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	9990.00	root		data:Selection
  └─Selection	9990.00	cop[tikv]		not(isnull(planner__core__casetest__pushdown__push_down.t.id))
    └─TableFullScan	10000.00	cop[tikv]	table:A	keep order:false, stats:pseudo
desc format = 'brief' select A.id from t as A where not exists  (select 1 from t where t.id=A.id);
id	estRows	task	access object	operator info
HashJoin	8000.00	root		anti semi join, equal:[eq(planner__core__casetest__pushdown__push_down.t.id, planner__core__casetest__pushdown__push_down.t.id)]
├─TableReader(Build)	10000.00	root		data:TableFullScan
│ └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
└─TableReader(Probe)	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:A	keep order:false, stats:pseudo
desc format = 'brief' SELECT FROM_UNIXTIME(name,'%Y-%m-%d')  FROM t;
id	estRows	task	access object	operator info
Projection	10000.00	root		from_unixtime(cast(planner__core__casetest__pushdown__push_down.t.name, decimal(65,6) BINARY), %Y-%m-%d)->Column#13
└─TableReader	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
