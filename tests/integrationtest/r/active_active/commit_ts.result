drop table if exists t;
create table t (id int primary key, v int);
insert into t values (1, 1), (2, 2), (3, 3);
insert into t values (4, 4);
explain format = 'brief' select _tidb_commit_ts, id from t where id = 1;
id	estRows	task	access object	operator info
Projection	1.00	root		active_active__commit_ts.t._tidb_commit_ts, active_active__commit_ts.t.id
└─Point_Get	1.00	root	table:t	handle:1
select _tidb_commit_ts, id from t where id = 1;
_tidb_commit_ts	id
TSO	1
explain format = 'brief' select _tidb_commit_ts, id from t where id in (1, 2, 3);
id	estRows	task	access object	operator info
Projection	3.00	root		active_active__commit_ts.t._tidb_commit_ts, active_active__commit_ts.t.id
└─Batch_Point_Get	3.00	root	table:t	handle:[1 2 3], keep order:false, desc:false
select _tidb_commit_ts, id from t where id in (1, 2, 3);
_tidb_commit_ts	id
TSO	1
TSO	2
TSO	3
select _tidb_commit_ts, id from t where id in (3, 4) order by _tidb_commit_ts desc;
_tidb_commit_ts	id
TSO	4
TSO	3
begin;
select _tidb_commit_ts, id from t where id = 1;
_tidb_commit_ts	id
TSO	1
select _tidb_commit_ts, id from t where id in (1, 2, 3);
_tidb_commit_ts	id
TSO	1
TSO	2
TSO	3
insert into t values (5, 5);
insert into t values (6, 6);
select _tidb_commit_ts, id from t where id = 1;
_tidb_commit_ts	id
TSO	1
select _tidb_commit_ts, id from t where id = 5;
_tidb_commit_ts	id
NULL	5
select _tidb_commit_ts, id from t where id in (1, 2, 3);
_tidb_commit_ts	id
TSO	1
TSO	2
TSO	3
select _tidb_commit_ts, id from t where id in (1, 2, 3, 5, 6);
_tidb_commit_ts	id
TSO	1
TSO	2
TSO	3
NULL	5
NULL	6
rollback;
create temporary table tmp (id int primary key, v int);
insert into tmp values (1, 1), (2, 2), (3, 3), (4, 4);
select _tidb_commit_ts, id from t where id = 1;
_tidb_commit_ts	id
TSO	1
select _tidb_commit_ts, id from t where id in (1, 2, 3);
_tidb_commit_ts	id
TSO	1
TSO	2
TSO	3
# TODO
# coprocessor is not supported yet
drop table if exists t;
create table t (a bigint primary key, b int, c int) softdelete retention 7 day active_active = 'on';
insert into t value (1,1,1) on duplicate key update a = _tidb_commit_ts;
insert into t value (1,1,1) on duplicate key update a = _tidb_commit_ts;
select * from t;
a	b	c
TSO	1	1
delete from t;
insert into t (a,b,c,_tidb_softdelete_time) values (2,2,2, now()) on duplicate key update a = _tidb_commit_ts;
explain format = 'brief' select * from t;
id	estRows	task	access object	operator info
TableReader	10.00	root		data:Projection
└─Projection	10.00	cop[tikv]		active_active__commit_ts.t.a, active_active__commit_ts.t.b, active_active__commit_ts.t.c
  └─Selection	10.00	cop[tikv]		isnull(active_active__commit_ts.t._tidb_softdelete_time)
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
select * from t;
a	b	c
explain format = 'brief' update t set b = 3;
id	estRows	task	access object	operator info
Update	N/A	root		N/A
└─TableReader	10.00	root		data:Selection
  └─Selection	10.00	cop[tikv]		isnull(active_active__commit_ts.t._tidb_softdelete_time)
    └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
update t set b = 3;
set @@tidb_translate_softdelete_sql = false;
explain format = 'brief' select * from t;
id	estRows	task	access object	operator info
TableReader	10000.00	root		data:TableFullScan
└─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
select * from t;
a	b	c
2	2	2
select * from t where a = 2;
a	b	c
2	2	2
explain format = 'brief' update t set b = 3;
id	estRows	task	access object	operator info
Update	N/A	root		N/A
└─TableReader	10000.00	root		data:TableFullScan
  └─TableFullScan	10000.00	cop[tikv]	table:t	keep order:false, stats:pseudo
update t set b = 3;
select * from t;
a	b	c
2	3	2
delete from t where a > 1;
select * from t;
a	b	c
