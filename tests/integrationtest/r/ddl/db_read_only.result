create database if not exists test;
drop database if exists db_read_only;
create database db_read_only;
drop database if exists db_read_only_1;
create database db_read_only_1;
use db_read_only;
create table s(a int primary key);
create table t(id int primary key auto_increment, a int, b int, c varchar(1), index b(b), foreign key fk_a(b) references s(a));
create table db_read_only_1.s(a int primary key);
alter table t add foreign key fk_a3(b) references db_read_only_1.s(a);
create view v1 as select * from t;
create table members (
id int,
fname varchar(255),
lname varchar(255),
dob date,
data json
)
partition by range (year(dob)) (
partition pBefore1950 values less than (1950),
partition p1950 values less than (1960),
partition p1960 values less than (1970),
partition p1970 values less than (1980),
partition p1980 values less than (1990),
partition p1990 values less than (2000));
create temporary table temp (a int);
create global temporary table temp_global(a int) on commit delete rows;
desc information_schema.schemata_extensions;
Field	Type	Null	Key	Default	Extra
CATALOG_NAME	varchar(64)	YES		NULL	
SCHEMA_NAME	varchar(64)	YES		NULL	
OPTIONS	varchar(256)	YES		NULL	
select * from information_schema.schemata_extensions;
CATALOG_NAME	SCHEMA_NAME	OPTIONS
def	db_read_only	
def	db_read_only_1	
def	ddl__db_read_only	
def	INFORMATION_SCHEMA	
def	METRICS_SCHEMA	
def	mysql	
def	PERFORMANCE_SCHEMA	
def	sys	
def	test	
alter schema test read only 1;
select * from information_schema.schemata_extensions;
CATALOG_NAME	SCHEMA_NAME	OPTIONS
def	db_read_only	
def	db_read_only_1	
def	ddl__db_read_only	
def	INFORMATION_SCHEMA	
def	METRICS_SCHEMA	
def	mysql	
def	PERFORMANCE_SCHEMA	
def	sys	
def	test	READ ONLY=1
alter schema test read only 0;
select * from information_schema.schemata_extensions;
CATALOG_NAME	SCHEMA_NAME	OPTIONS
def	db_read_only	
def	db_read_only_1	
def	ddl__db_read_only	
def	INFORMATION_SCHEMA	
def	METRICS_SCHEMA	
def	mysql	
def	PERFORMANCE_SCHEMA	
def	sys	
def	test	
alter schema db_read_only read only 1;
alter database db_read_only charset gbk;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter database db_read_only collate utf8mb4_roman_ci;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create placement policy p1 followers=4;
alter database db_read_only placement policy p1;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter database db_read_only set tiflash replica 1;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop database db_read_only;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create table t1(c1 int);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create table t2 like t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create table pt (a int, b int) partition by hash(a) partitions 4;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create temporary table t1(a int);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create global temporary table t1(a int) on commit delete rows;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t add column cc int not null;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t add index (a);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create index c1 on t(a);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t alter index b invisible;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t change column c c varchar(10);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t drop column c;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t drop index b;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop index b on t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t modify column c varchar(10);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t rename index b to b_1;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t drop foreign key fk_a;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t add foreign key fk_a1(b) references s(a);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t add foreign key fk_a2(b) references db_read_only_1.s(a);
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t partition by hash(a) partitions 4;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table members drop partition p1990;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table members truncate partition p1980;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table members add partition (partition `p1990to2010` values less than (2010));
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table members reorganize partition `p1990to2010` into
(partition p1990 values less than (2000),
partition p2000 values less than (2010),
partition p2010 values less than (2020),
partition p2020 values less than (2030),
partition pMax values less than (maxvalue));
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
rename table t to t_old;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
rename table db_read_only.t to db_read_only_1.t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter schema db_read_only read only 0;
alter schema db_read_only_1 read only 1;
rename table db_read_only.t to db_read_only_1.t;
Error 3809 (HY000): Schema 'db_read_only_1' is in read only mode.
alter schema db_read_only read only 1;
truncate table t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
truncate table temp;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop table t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop table temp;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop table temp_global;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
drop view v1;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
load data local infile '' into table t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
import into t from '';
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create view v as select * from t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
create or replace view v as select * from t;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t auto_increment = 10000;
Error 3809 (HY000): Schema 'db_read_only' is in read only mode.
alter table t compact tiflash replica;
alter schema db_read_only read only 0;
alter schema db_read_only_1 read only 0;
drop database if exists db1;
create database db1;
use db1;
create table t1(id int primary key, a int);
create table t2(id int, a int);
create table t3(a int);
create temporary table temp(a int);
drop database if exists db2;
create database db2;
use db2;
create table t1(id int primary key, a int);
create table t2(id int, a int);
create table t3(a int);
create table parent_0(id int, key(id));
create table parent_1(id int, key(id));
create table parent_2(id int, key(id));
create table parent_3(id int, key(id));
insert into parent_0 values (0);
insert into parent_1 values (1);
insert into parent_2 values (2);
insert into parent_3 values (3);
create table db1.child_0(pid int, key(pid), foreign key (pid) references db2.parent_0(id) on delete cascade);
create table db1.child_1(pid int, key(pid), foreign key (pid) references db2.parent_1(id) on update cascade);
create table db1.child_2(pid int, key(pid), foreign key (pid) references db2.parent_2(id) on delete set null);
create table db1.child_3(pid int, key(pid), foreign key (pid) references db2.parent_3(id) on update set null);
insert into db1.child_0 values (0);
insert into db1.child_1 values (1);
insert into db1.child_2 values (2);
insert into db1.child_3 values (3);
alter schema db1 read only 1;
use db1;
insert into t1 values(1, 1);
Error 3809 (HY000): Schema 'db1' is in read only mode.
insert into t1 select * from t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
insert into db2.t1 select * from t1; # pass
insert into t1 table t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
insert into t1 set a=1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
insert into temp values (1);
Error 3809 (HY000): Schema 'db1' is in read only mode.
replace into t1 values (1, 2);
Error 3809 (HY000): Schema 'db1' is in read only mode.
replace into t1 table t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
replace t1 set a = default;
Error 3809 (HY000): Schema 'db1' is in read only mode.
replace into temp values (1);
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from t1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from temp where a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete t1, t2 from t1, t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete db1.t1, db2.t2 from db1.t1, db2.t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete t1,t2,t3 from t1, t2, t3 where t3.a < 5 and t1.a = 3;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete t2 from t1, t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete db2.t2 from db1.t1, db2.t2;
delete db1.t1 from db1.t1, db2.t2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete t1 from t1, t1 as t2 where t1.b = t2.b and t1.a > t2.a;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from t1,t2,t3 using t1,t2,t3 where t3.a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from t1,db2.t2,db2.t3 using t1,db2.t2,db2.t3 where db2.t3.a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from t2,t3 using t1,t2,t3 where t1.a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from t2,db2.t3 using t1,t2,db2.t3 where t1.a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
with cte as (select * from t1) delete from t2 where t2.a in (select a from cte);
Error 3809 (HY000): Schema 'db1' is in read only mode.
update t1 set a = a + 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
update temp set a = 1;
Error 3809 (HY000): Schema 'db1' is in read only mode.
update t1, t2 set t1.a = 1, t2.a = 1 where t1.a = t2.a;
Error 3809 (HY000): Schema 'db1' is in read only mode.
update t1 join db2.t2 set t1.a=1 where t1.b=db2.t2.b;
Error 3809 (HY000): Schema 'db1' is in read only mode.
analyze table t1; #pass
with cte as (select * from t1) update t2 set a = 1 where t2.a in (select a from cte);
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on delete restrict;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on update restrict;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on delete cascade;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on update cascade;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on delete set null;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter table t1 add constraint fk_1 foreign key (id) references t2(id) on update set null;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 for update;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 for update of t1 nowait;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 for update of t1 wait 5;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 join t2 on t1.a= t2.a for update;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select t1.a from t1 join t2 on t1.a= t2.a for update;
Error 3809 (HY000): Schema 'db1' is in read only mode.
table t1 for update;
Error 3809 (HY000): Schema 'db1' is in read only mode.
set @@session.tidb_enable_shared_lock_promotion = 1;
select * from t1 for share;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 for share nowait;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1 join t2 on t1.a= t2.a for share;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select t1.a from t1 join t2 on t1.a= t2.a for share;
Error 3809 (HY000): Schema 'db1' is in read only mode.
table t1 for share;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from temp for update;
Error 3809 (HY000): Schema 'db1' is in read only mode.
select * from t1;
id	a
select * from t1 join t2 on t1.a= t2.a;
id	a	id	a
table t1;
id	a
delete from db2.parent_0;
Error 3809 (HY000): Schema 'db1' is in read only mode.
update db2.parent_1 set id_0 = 10;
Error 3809 (HY000): Schema 'db1' is in read only mode.
delete from db2.parent_2;
Error 3809 (HY000): Schema 'db1' is in read only mode.
update db2.parent_3 set id_3 = 10;
Error 3809 (HY000): Schema 'db1' is in read only mode.
alter schema db1 read only 0;
drop database if exists read_only;
create database read_only;
use read_only;
create table t1(a int, b int, index idx_b(b));
prepare stmt_insert from 'insert into t1 values(?, ?)';
prepare stmt_update from 'update t1 set b = ? where a = ?';
prepare stmt_delete from 'delete from t1 where a = ?';
prepare stmt_select_for_update from 'select * from t1 where a = ? for update';
prepare stmt_select from 'select * from t1 where a = ?';
prepare stmt_truncate from 'truncate table t1';
prepare stmt_drop_database from 'drop database read_only';
prepare stmt_alter_database from 'alter database read_only charset gbk';
prepare stmt_create_table from 'create table t2(a int)';
prepare stmt_drop_table from 'drop table t2';
prepare stmt_alter_table from 'alter table t1 add column c int';
set @a = 1;
set @b = 2;
alter schema read_only read only 1;
prepare stmt from 'insert into t1 values(?, ?)';  # different from mysql, mysql allows prepare in read only mode
Error 3809 (HY000): Schema 'read_only' is in read only mode.
execute stmt_insert using @a, @b; # error 3809 is wrapped by prepare/execute as 8113
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_update using @b, @a;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_delete using @a;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_select_for_update using @a;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_select using @a;
a	b
execute stmt_truncate;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_drop_database;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_alter_database;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_create_table;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_drop_table;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
execute stmt_alter_table;
Error 8113 (HY000): Schema change caused error: [schema:3809]Schema 'read_only' is in read only mode.
alter schema read_only read only 0;
set @a = 1;
execute stmt_select using @a;
a	b
execute stmt_select using @a;
a	b
select @@last_plan_from_cache; # should be 1
@@last_plan_from_cache
1
alter schema read_only read only 1;
execute stmt_select using @a;
a	b
select @@last_plan_from_cache; # should be 0
@@last_plan_from_cache
0
alter schema read_only read only 0;
execute stmt_select using @a;
a	b
select @@last_plan_from_cache; # should be 0
@@last_plan_from_cache
0
SET tidb_enable_non_prepared_plan_cache = ON;
select * from read_only.t1 where a = 1;
a	b
select * from read_only.t1 where a = 1;
a	b
SELECT @@last_plan_from_cache; # should be 1
@@last_plan_from_cache
1
alter schema read_only read only 1;
select * from read_only.t1 where a = 1;
a	b
SELECT @@last_plan_from_cache; # should be 0
@@last_plan_from_cache
0
alter schema read_only read only 0;
select * from read_only.t1 where a = 1;
a	b
SELECT @@last_plan_from_cache; # should be 0
SET tidb_enable_non_prepared_plan_cache = OFF;
@@last_plan_from_cache
0
alter schema read_only read only 1;
create binding for select * from t1 where b = 1 using select /*+ use_index(t1, idx_b) */ * from t1 where b = 1;
create binding for update t1 set b = 2 where a = 1 using update /*+ use_index(t1, idx_b) */ t1 set b = 2 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
create binding for delete from t1 where a = 1 using delete /*+ use_index(t1, idx_b) */ from t1 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain select * from t1 where b = 1 for update;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain insert into t1 values(1, 2);
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain update t1 set b = 2 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain delete from t1 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain analyze select * from t1 where b = 1 for update;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain analyze insert into t1 values(1, 2);
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain analyze update t1 set b = 2 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
explain analyze delete from t1 where a = 1;
Error 3809 (HY000): Schema 'read_only' is in read only mode.
alter schema read_only read only 0;
