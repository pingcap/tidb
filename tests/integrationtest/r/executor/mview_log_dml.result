use test;
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int, extra int);
create materialized view log on t (id, uk, v);
insert into t values (1,10,100,1000);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	I	1
delete from `$mlog$t`;
update t set v=101 where id=1;
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	10	101	U	1
delete from `$mlog$t`;
update t set extra=2000 where id=1;
select count(*) from `$mlog$t`;
count(*)
0
delete from `$mlog$t`;
delete from t where id=1;
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	101	D	-1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1,10,100), (2,20,200);
create materialized view log on t (id, uk, v);
replace into t values (1,20,999);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	20	999	U	1
2	20	200	U	-1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1,10,100);
create materialized view log on t (id, uk, v);
load data local infile './t/executor/mview_log_dml.csv' ignore into table t fields terminated by ',' lines terminated by '\n' (id, uk, v);
select id, uk, v from t order by id;
id	uk	v
1	10	100
3	30	333
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
3	30	333	I	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, v int);
insert into t values (1, 100);
create materialized view log on t (id, v);
update t set id = 2 where id = 1;
select id, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	100	U	-1
2	100	U	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1, 10, 100);
create materialized view log on t (id, uk, v);
insert into t values (1, 10, 101) on duplicate key update v=values(v);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	10	101	U	1
delete from `$mlog$t`;
insert into t values (1, 10, 200) on duplicate key update id = 3, v = values(v);
select id, uk, v from t order by id;
id	uk	v
3	10	200
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	101	U	-1
3	10	200	U	1
