use test;
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int, extra int);
create materialized view log on t (id, uk, v);
insert into t values (1,10,100,1000);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	I	1
drop materialized view log on t;
create materialized view log on t (id, uk, v);
update t set v=101 where id=1;
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	10	101	U	1
drop materialized view log on t;
create materialized view log on t (id, uk, v);
update t set extra=2000 where id=1;
select count(*) from `$mlog$t`;
count(*)
0
drop materialized view log on t;
create materialized view log on t (id, uk, v);
delete from t where id=1;
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	101	D	-1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1,10,100), (2,20,200);
create materialized view log on t (id, uk, v);
replace into t values (1,20,999);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	20	999	U	1
2	20	200	U	-1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1,10,100);
create materialized view log on t (id, uk, v);
load data local infile './t/executor/mview_log_dml.csv' ignore into table t fields terminated by ',' lines terminated by '\n' (id, uk, v);
select id, uk, v from t order by id;
id	uk	v
1	10	100
3	30	333
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
3	30	333	I	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, v int);
insert into t values (1, 100);
create materialized view log on t (id, v);
update t set id = 2 where id = 1;
select id, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	100	U	-1
2	100	U	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, uk int unique, v int);
insert into t values (1, 10, 100);
create materialized view log on t (id, uk, v);
insert into t values (1, 10, 101) on duplicate key update v=values(v);
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	100	U	-1
1	10	101	U	1
drop materialized view log on t;
create materialized view log on t (id, uk, v);
insert into t values (1, 10, 200) on duplicate key update id = 3, v = values(v);
select id, uk, v from t order by id;
id	uk	v
3	10	200
select id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, uk, v, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	uk	v	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	101	U	-1
3	10	200	U	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, tracked int, untracked int);
create materialized view log on t (id, tracked);
insert into t values (1, 10, 100);
drop materialized view log on t;
create materialized view log on t (id, tracked);
alter table t add column c_new int default 0;
update t set untracked = 101 where id = 1;
select count(*) from `$mlog$t`;
count(*)
0
insert into t (id, tracked, untracked) values (2, 20, 200);
select id, tracked, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, tracked, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	tracked	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
2	20	I	1
alter table t drop column untracked;
update t set tracked = 11 where id = 1;
select id, tracked, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t` order by id, tracked, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW`;
id	tracked	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	10	U	-1
1	11	U	1
2	20	I	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (id int primary key, tracked int, untracked int);
create materialized view log on t (id, tracked);
alter table t drop column tracked;
insert into t values (1, 100);
Error 1105 (HY000): wrap table with mlog: base column tracked not found
update t set untracked = 101 where id = 1;
Error 1105 (HY000): wrap table with mlog: base column tracked not found
delete from t where id = 1;
Error 1105 (HY000): wrap table with mlog: base column tracked not found
drop table if exists t, `$mlog$t`;
create table t(a int);
create materialized view log on t (a);
insert into t values (1);
select _tidb_rowid, a from t;
_tidb_rowid	a
1	1
select _tidb_rowid, a, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t`;
_tidb_rowid	a	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	1	I	1
update t set a = a+1 where a = 1;
insert into t values (2), (3);
select _tidb_rowid, a from t;
_tidb_rowid	a
1	2
2	2
3	3
select _tidb_rowid, a, `_MLOG$_DML_TYPE`, `_MLOG$_OLD_NEW` from `$mlog$t`;
_tidb_rowid	a	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
1	1	I	1
2	1	U	-1
3	2	U	1
4	2	I	1
5	3	I	1
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int);
create materialized view log on t (a, b);
insert into `$mlog$t` values (1, 2, 'I', 1);
Error 1288 (HY000): The target table $mlog$t of the INSERT is not updatable
replace into `$mlog$t` values (1, 2, 'I', 1);
Error 1288 (HY000): The target table $mlog$t of the REPLACE is not updatable
update `$mlog$t` set a=1;
Error 1288 (HY000): The target table $mlog$t of the UPDATE is not updatable
delete from `$mlog$t`;
Error 1288 (HY000): The target table $mlog$t of the DELETE is not updatable
select * from `$mlog$t`;
a	b	_MLOG$_DML_TYPE	_MLOG$_OLD_NEW
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int not null);
create materialized view log on t (a, b);
create materialized view v (a, s, cnt) as select a, sum(b), count(1) from t group by a;
insert into v values (1, 10, 1);
Error 1288 (HY000): The target table v of the INSERT is not updatable
replace into v values (1, 10, 1);
Error 1288 (HY000): The target table v of the REPLACE is not updatable
update v set s=1;
Error 1288 (HY000): The target table v of the UPDATE is not updatable
delete from v;
Error 1288 (HY000): The target table v of the DELETE is not updatable
drop materialized view v;
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int);
create materialized view log on t (a, b);
prepare stmt_ins from 'insert into `$mlog$t` values (?, ?, ?, ?)';
Error 1288 (HY000): The target table $mlog$t of the INSERT is not updatable
prepare stmt_upd from 'update `$mlog$t` set a=?';
Error 1288 (HY000): The target table $mlog$t of the UPDATE is not updatable
prepare stmt_del from 'delete from `$mlog$t` where a=?';
Error 1288 (HY000): The target table $mlog$t of the DELETE is not updatable
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int not null);
create materialized view log on t (a, b);
create materialized view v (a, s, cnt) as select a, sum(b), count(1) from t group by a;
prepare stmt_ins from 'insert into v values (?, ?, ?)';
Error 1288 (HY000): The target table v of the INSERT is not updatable
prepare stmt_upd from 'update v set s=? where a=?';
Error 1288 (HY000): The target table v of the UPDATE is not updatable
prepare stmt_del from 'delete from v where a=?';
Error 1288 (HY000): The target table v of the DELETE is not updatable
drop materialized view v;
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int);
create materialized view log on t (a, b);
load data local infile '/nonexistent.csv' into table `$mlog$t` fields terminated by ',';
Error 1288 (HY000): The target table $mlog$t of the LOAD is not updatable
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int not null);
create materialized view log on t (a, b);
create materialized view v (a, s, cnt) as select a, sum(b), count(1) from t group by a;
load data local infile '/nonexistent.csv' into table v fields terminated by ',';
Error 1288 (HY000): The target table v of the LOAD is not updatable
drop materialized view v;
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int);
create materialized view log on t (a, b);
import into `$mlog$t` from '/nonexistent.csv';
Error 1288 (HY000): The target table $mlog$t of the IMPORT is not updatable
drop table if exists t;
drop table if exists `$mlog$t`;
create table t (a int primary key, b int not null);
create materialized view log on t (a, b);
create materialized view v (a, s, cnt) as select a, sum(b), count(1) from t group by a;
import into v from '/nonexistent.csv';
Error 1288 (HY000): The target table v of the IMPORT is not updatable
drop materialized view v;
drop table if exists t, `$mlog$t`;
