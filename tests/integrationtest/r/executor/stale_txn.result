select * from information_schema.ddl_jobs as of timestamp now();
drop table if exists t1;
create table t1 (id int primary key, v int);
insert into t1 values(1, 10);
select sleep(0.1);
sleep(0.1)
0
set @a=now(6);
select sleep(0.1);
sleep(0.1)
0
update t1 set v=100 where id=1;
select * from t1 as of timestamp @a where v=(select v from t1 as of timestamp @a where id=1);
id	v
1	10
select (select v from t1 as of timestamp @a where id=1) as v;
v
10
set tidb_txn_mode='pessimistic';
set tx_isolation = 'READ-COMMITTED';
drop table if exists t1;
create table t1 (id int primary key, v int);
insert into t1 values(1, 10);
select sleep(0.1);
sleep(0.1)
0
set @a=now(6);
select sleep(0.1);
sleep(0.1)
0
update t1 set v=100 where id=1;
set autocommit=0;
select * from t1 as of timestamp @a;
id	v
1	10
set tidb_txn_mode = default;
set tx_isolation = default;
set autocommit = default;
drop table if exists t1;
create table t1 (id int primary key, v int);
select * from t1 as of timestamp NULL;
Error 8135 (HY000): invalid as of timestamp: as of timestamp cannot be NULL
start transaction read only as of timestamp NULL;
Error 8135 (HY000): invalid as of timestamp: as of timestamp cannot be NULL
drop table if exists t1;
create table t1 (value int);
insert into t1 values (1);
insert into t1 values (2);
set @last_commit_ts = json_extract(@@tidb_last_txn_info, '$.commit_ts');
set @prev_commit_ts = cast(cast(@last_commit_ts as unsigned) - 1 as char);
select count(*) as prev_count from t1 as of timestamp @prev_commit_ts;
prev_count
1
select count(*) as exact_count from t1 as of timestamp @last_commit_ts;
exact_count
2
select count(*) from t1 as of timestamp 'invalid-date';
Error 1292 (22007): Incorrect datetime value: 'invalid-date'
start transaction read only as of timestamp @last_commit_ts;
select @@tidb_current_ts = CAST(@last_commit_ts AS UNSIGNED) AS ts_matches;
ts_matches
1
select count(*) as count_from_txn from t1;
count_from_txn
2
commit;
