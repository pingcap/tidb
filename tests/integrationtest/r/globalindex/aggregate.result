drop table if exists p;
create table p (id int, c int, unique index idx(id) global) partition by range (c) (
partition p0 values less than (4),
partition p1 values less than (7),
partition p2 values less than (10));
insert into p values (1,3), (2,3), (3,4), (4,4), (5,6), (7,9), (8,9);
explain format='plan_tree' select count(*), max(id), min(id) from p use index(idx);
id	task	access object	operator info
HashAgg	root		funcs:count(Column#9)->Column#4, funcs:max(Column#10)->Column#5, funcs:min(Column#11)->Column#6
└─IndexReader	root	partition:all	index:HashAgg
  └─HashAgg	cop[tikv]		funcs:count(1)->Column#9, funcs:max(globalindex__aggregate.p.id)->Column#10, funcs:min(globalindex__aggregate.p.id)->Column#11
    └─IndexFullScan	cop[tikv]	table:p, index:idx(id)	keep order:false, stats:pseudo
select count(*), max(id), min(id) from p use index(idx);
count(*)	max(id)	min(id)
7	8	1
explain format='plan_tree' select count(*), max(id), min(id) from p partition(p0) use index(idx);
id	task	access object	operator info
HashAgg	root	NULL	funcs:count(Column#9)->Column#4, funcs:max(Column#10)->Column#5, funcs:min(Column#11)->Column#6
└─IndexReader	root	partition:p0	index:HashAgg
  └─HashAgg	cop[tikv]	NULL	funcs:count(1)->Column#9, funcs:max(globalindex__aggregate.p.id)->Column#10, funcs:min(globalindex__aggregate.p.id)->Column#11
    └─Selection	cop[tikv]	NULL	in(_tidb_tid, tid0)
      └─IndexFullScan	cop[tikv]	table:p, index:idx(id)	keep order:false, stats:pseudo
select count(*), max(id), min(id) from p partition(p0) use index(idx);
count(*)	max(id)	min(id)
2	2	1
explain format='plan_tree' select avg(id), max(id), min(id) from p use index(idx) group by c;
id	task	access object	operator info
HashAgg	root		group by:globalindex__aggregate.p.c, funcs:avg(Column#9, Column#10)->Column#4, funcs:max(Column#11)->Column#5, funcs:min(Column#12)->Column#6
└─IndexLookUp	root	partition:all	
  ├─IndexFullScan(Build)	cop[tikv]	table:p, index:idx(id)	keep order:false, stats:pseudo
  └─HashAgg(Probe)	cop[tikv]		group by:globalindex__aggregate.p.c, funcs:count(globalindex__aggregate.p.id)->Column#9, funcs:sum(globalindex__aggregate.p.id)->Column#10, funcs:max(globalindex__aggregate.p.id)->Column#11, funcs:min(globalindex__aggregate.p.id)->Column#12
    └─TableRowIDScan	cop[tikv]	table:p	keep order:false, stats:pseudo
select avg(id), max(id), min(id) from p use index(idx) group by c;
avg(id)	max(id)	min(id)
1.5000	2	1
3.5000	4	3
5.0000	5	5
7.5000	8	7
explain format='plan_tree' select avg(id), max(id), min(id) from p partition(p0) use index(idx) group by c;
id	task	access object	operator info
HashAgg	root	NULL	group by:globalindex__aggregate.p.c, funcs:avg(Column#9, Column#10)->Column#4, funcs:max(Column#11)->Column#5, funcs:min(Column#12)->Column#6
└─IndexLookUp	root	partition:p0	NULL
  ├─Selection(Build)	cop[tikv]	NULL	in(_tidb_tid, tid0)
  │ └─IndexFullScan	cop[tikv]	table:p, index:idx(id)	keep order:false, stats:pseudo
  └─HashAgg(Probe)	cop[tikv]	NULL	group by:globalindex__aggregate.p.c, funcs:count(globalindex__aggregate.p.id)->Column#9, funcs:sum(globalindex__aggregate.p.id)->Column#10, funcs:max(globalindex__aggregate.p.id)->Column#11, funcs:min(globalindex__aggregate.p.id)->Column#12
    └─TableRowIDScan	cop[tikv]	table:p	keep order:false, stats:pseudo
select avg(id), max(id), min(id) from p partition(p0) use index(idx) group by c;
avg(id)	max(id)	min(id)
1.5000	2	1
alter table p add unique index idx1(c, id) global;
explain format='plan_tree' select count(*), max(id), min(id) from p use index(idx1);
id	task	access object	operator info
HashAgg	root		funcs:count(Column#10)->Column#4, funcs:max(Column#11)->Column#5, funcs:min(Column#12)->Column#6
└─IndexReader	root	partition:all	index:HashAgg
  └─HashAgg	cop[tikv]		funcs:count(1)->Column#10, funcs:max(globalindex__aggregate.p.id)->Column#11, funcs:min(globalindex__aggregate.p.id)->Column#12
    └─IndexFullScan	cop[tikv]	table:p, index:idx1(c, id)	keep order:false, stats:pseudo
select count(*), max(id), min(id) from p use index(idx1);
count(*)	max(id)	min(id)
7	8	1
explain format='plan_tree' select avg(id), max(id), min(id) from p use index(idx1) group by c;
id	task	access object	operator info
HashAgg	root		group by:Column#26, funcs:avg(Column#23)->Column#4, funcs:max(Column#24)->Column#5, funcs:min(Column#25)->Column#6
└─Projection	root		cast(globalindex__aggregate.p.id, decimal(10,0) BINARY)->Column#23, globalindex__aggregate.p.id->Column#24, globalindex__aggregate.p.id->Column#25, globalindex__aggregate.p.c->Column#26
  └─IndexReader	root	partition:all	index:IndexFullScan
    └─IndexFullScan	cop[tikv]	table:p, index:idx1(c, id)	keep order:false, stats:pseudo
select avg(id), max(id), min(id) from p use index(idx1) group by c;
avg(id)	max(id)	min(id)
1.5000	2	1
3.5000	4	3
5.0000	5	5
7.5000	8	7
