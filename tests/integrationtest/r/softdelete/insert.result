create table t (id int primary key clustered) softdelete retention 7 day;
insert into t(id) values (1), (2);
update t set _tidb_softdelete_time = now() where id = 1;
insert into t(id) values (1), (2), (3);
Error 1062 (23000): Duplicate entry '2' for key 't.PRIMARY'
select id from t where _tidb_softdelete_time is null;
id
2
select id from t;
id
2
select * from t;
id
2
insert into t(id) values (1), (3);
select id from t where _tidb_softdelete_time is null;
id
1
2
3
drop table t;
## test again with nonclustered pk
create table t (id int primary key nonclustered) softdelete retention 7 day;
insert into t(id) values (1), (2);
update t set _tidb_softdelete_time = now() where id = 1;
insert into t(id) values (1), (2), (3);
Error 1062 (23000): Duplicate entry '2' for key 't.PRIMARY'
select id from t where _tidb_softdelete_time is null;
id
2
select id from t;
id
2
insert into t(id) values (1), (3);
select id from t where _tidb_softdelete_time is null;
id
2
1
3
