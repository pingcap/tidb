drop table if exists t1;
create table t1 (id int primary key, name varchar(50)) softdelete retention 7 day;
insert into t1 values (1, 'aaa'), (2, 'bbb'), (3, 'ccc'), (4, 'ddd'), (5, 'eee');
set global tidb_stats_cache_mem_quota = 1;
analyze table t1 all columns;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	0
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't1' and partition_name = 'p1';
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't1' and partition_name is null;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	0
delete from t1 where id <= 2;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	0
delete from t1 where id = 3;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	0
analyze table t1 all columns;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	3
set global tidb_stats_cache_mem_quota = default;
analyze table t1 all columns;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	3
drop table if exists t2;
create table t2 (id int primary key, name varchar(50));
insert into t2 values (1, 'a'), (2, 'b');
analyze table t2 all columns;
select count(*) from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't2';
count(*)
0
drop table if exists t3;
create table t3 (id int primary key, val int) softdelete retention 7 day
partition by range(id) (
partition p0 values less than (10),
partition p1 values less than (20),
partition p2 values less than (maxvalue)
);
insert into t3 values (1, 1), (5, 5), (11, 11), (15, 15), (21, 21), (25, 25);
delete from t3 where id in (1, 11, 21);
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't3';
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t3	p0	NULL	NULL
softdelete__stats_table	t3	p1	NULL	NULL
softdelete__stats_table	t3	p2	NULL	NULL
set global tidb_stats_cache_mem_quota = 1;
analyze table t3 all columns;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't3';
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t3	p0	2	1
softdelete__stats_table	t3	p1	2	1
softdelete__stats_table	t3	p2	2	1
select db_name, table_name, partition_name, estimated_total_row_count, estimated_softdeleted_row_count from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't3' and partition_name = 'p0';
db_name	table_name	partition_name	estimated_total_row_count	estimated_softdeleted_row_count
softdelete__stats_table	t3	p0	2	1
set global tidb_stats_cache_mem_quota = default;
analyze table t3 all columns;
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS where db_name = 'softdelete__stats_table' and table_name = 't3';
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t3	p0	2	1
softdelete__stats_table	t3	p1	2	1
softdelete__stats_table	t3	p2	2	1
CREATE USER 'only_t1'@'localhost';
CREATE USER 'only_t2'@'localhost';
CREATE USER 'only_t3'@'localhost';
GRANT SELECT ON softdelete__stats_table.t1 TO 'only_t1'@'localhost';
GRANT SELECT ON softdelete__stats_table.t2 TO 'only_t2'@'localhost';
GRANT SELECT ON softdelete__stats_table.t3 TO 'only_t3'@'localhost';
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t1	NULL	5	3
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
select * from information_schema.TIDB_SOFTDELETE_TABLE_STATS;
DB_NAME	TABLE_NAME	PARTITION_NAME	ESTIMATED_TOTAL_ROW_COUNT	ESTIMATED_SOFTDELETED_ROW_COUNT
softdelete__stats_table	t3	p0	2	1
softdelete__stats_table	t3	p1	2	1
softdelete__stats_table	t3	p2	2	1
drop table t1, t2, t3;
