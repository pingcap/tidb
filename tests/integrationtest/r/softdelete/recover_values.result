create table t1 (id int primary key, name varchar(50)) softdelete retention 7 day;
insert into t1 values (1, 'a'), (2, 'b'), (3, 'c');
set tidb_translate_softdelete_sql = true;
delete from t1 where id = 1;
delete from t1 where id = 2;
select id, name from t1 order by id;
id	name
3	c
select count(*) from t1;
count(*)
1
recover values from t1 where id = 1;
select id, name from t1 order by id;
id	name
1	a
3	c
drop table t1;
create table t2 (id int primary key, val int) softdelete retention 7 day;
insert into t2 values (1, 10), (2, 20), (3, 30);
delete from t2;
select count(*) from t2;
count(*)
0
recover values from t2;
select id, val from t2 order by id;
id	val
1	10
2	20
3	30
drop table t2;
create table t3 (id int primary key, name varchar(50));
insert into t3 values (1, 'a');
recover values from t3 where id = 1;
Error 1235 (42000): This version of TiDB doesn't yet support 'RECOVER VALUES on table without soft delete enabled'
drop table t3;
create table t4 (id int primary key, category varchar(20), val int) softdelete retention 7 day;
insert into t4 values (1, 'A', 100), (2, 'A', 200), (3, 'B', 150), (4, 'B', 250);
delete from t4 where category = 'A';
delete from t4 where val > 200;
select id, category, val from t4 order by id;
id	category	val
3	B	150
recover values from t4 where category = 'A';
select id, category, val from t4 order by id;
id	category	val
1	A	100
2	A	200
3	B	150
drop table t4;
create table t5 (id int primary key, a int) softdelete retention 7 day;
insert into t5 values (2, 20), (3, 30);
delete from t5 where a < 25;
select * from t5;
id	a
3	30
create table t6 (id int primary key, b int) softdelete retention 7 day;
insert into t6 values (11, 20), (22, 30);
delete from t6;
select * from t6;
id	b
select min(a) from t5;
min(a)
30
recover values from t6 where b = (select min(a) from t5);
select * from t6;
id	b
22	30
delete from t6;
set tidb_translate_softdelete_sql = false;
select min(a) from t5;
min(a)
20
recover values from t6 where b = (select min(a) from t5);
set tidb_translate_softdelete_sql = true;
select * from t6;
id	b
11	20
drop table t5;
drop table t6;
create table t7 (id int primary key, name varchar(50)) softdelete retention 7 day;
insert into t7 values (1, 'a'), (2, 'b'), (3, 'c');
delete from t7;
select id, name from t7 order by id;
id	name
CREATE USER 'recover_no_priv'@'localhost';
CREATE USER 'recover_select_only'@'localhost';
CREATE USER 'recover_update_priv'@'localhost';
CREATE USER 'recover_update_select'@'localhost';
GRANT SELECT ON softdelete__recover_values.t7 TO 'recover_select_only'@'localhost';
GRANT UPDATE ON softdelete__recover_values.t7 TO 'recover_update_priv'@'localhost';
GRANT SELECT, UPDATE ON softdelete__recover_values.t7 TO 'recover_update_select'@'localhost';
recover values from softdelete__recover_values.t7 where id = 1;
Error 1142 (42000): SELECT command denied to user 'recover_no_priv'@'localhost' for table 't7'
recover values from softdelete__recover_values.t7 where id = 1;
Error 8121 (HY000): privilege check for 'Update' fail
recover values from softdelete__recover_values.t7;
Error 8121 (HY000): privilege check for 'Update' fail
recover values from softdelete__recover_values.t7 where id = 1;
Error 1142 (42000): SELECT command denied to user 'recover_update_priv'@'localhost' for table 't7'
recover values from softdelete__recover_values.t7;
Error 1142 (42000): SELECT command denied to user 'recover_update_priv'@'localhost' for table 't7'
recover values from softdelete__recover_values.t7 where id = 1;
select id, name from softdelete__recover_values.t7 order by id;
id	name
1	a
recover values from softdelete__recover_values.t7;
select id, name from t7 order by id;
id	name
1	a
2	b
3	c
drop table t7;
DROP USER 'recover_no_priv'@'localhost';
DROP USER 'recover_select_only'@'localhost';
DROP USER 'recover_update_priv'@'localhost';
