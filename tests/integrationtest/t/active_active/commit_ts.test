drop table if exists t;
create table t (id int primary key, v int);
insert into t values (1, 1), (2, 2), (3, 3);
insert into t values (4, 4);

# basic point get
explain format = 'brief' select _tidb_commit_ts, id from t where id = 1;
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id = 1;

# basic batch point get
explain format = 'brief' select _tidb_commit_ts, id from t where id in (1, 2, 3);
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (1, 2, 3);

--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (3, 4) order by _tidb_commit_ts desc;

# point get inside txn
begin;
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id = 1;
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (1, 2, 3);

insert into t values (5, 5);
insert into t values (6, 6);

--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id = 1;
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id = 5;

--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (1, 2, 3);
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (1, 2, 3, 5, 6);
rollback;

# on temporary table, cached table
create temporary table tmp (id int primary key, v int);
insert into tmp values (1, 1), (2, 2), (3, 3), (4, 4);
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id = 1;
--replace_regex /^[1-9][0-9]+/TSO/
select _tidb_commit_ts, id from t where id in (1, 2, 3);

# The test is not quite stable depends on cache is cached or not.
# alter table t cache;
# explain format = 'brief' select _tidb_commit_ts, id from t where id = 1;
# --replace_regex /^[1-9][0-9]+/TSO/
# select _tidb_commit_ts, id from t where id = 1;
# sleep(1);
# --replace_regex /^[1-9][0-9]+/TSO/
# select _tidb_commit_ts, id from t where id = 1;

# basic batch point get
# explain format = 'brief' select _tidb_commit_ts, id from t where id in (1, 2, 3);
# --replace_regex /^[1-9][0-9]+/TSO/
# select _tidb_commit_ts, id from t where id in (1, 2, 3);

--echo # TODO
--echo # coprocessor is not supported yet
# explain format = 'brief' select _tidb_commit_ts, id from t;
# select _tidb_commit_ts, id from t;
# select _tidb_commit_ts, id from t where id < 5;

drop table if exists t;
create table t (a bigint primary key, b int, c int) softdelete retention 7 day active_active = 'on';
insert into t value (1,1,1) on duplicate key update a = _tidb_commit_ts;
insert into t value (1,1,1) on duplicate key update a = _tidb_commit_ts;
--replace_regex /^[1-9][0-9]+/TSO/
select * from t;
delete from t;
insert into t (a,b,c,_tidb_softdelete_time) values (2,2,2, now()) on duplicate key update a = _tidb_commit_ts;
explain format = 'brief' select * from t;
select * from t;
explain format = 'brief' update t set b = 3;
update t set b = 3;
set @@tidb_translate_softdelete_sql = false;
explain format = 'brief' select * from t;
select * from t;
select * from t where a = 2;
explain format = 'brief' update t set b = 3;
update t set b = 3;
select * from t;
delete from t where a > 1;
select * from t;
