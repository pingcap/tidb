# Test basic single table DELETE
create table t1 (id int primary key, name varchar(50)) softdelete retention 7 day;
insert into t1 values (1, 'a'), (2, 'b'), (3, 'c');
set tidb_translate_softdelete_sql = true;
delete from t1 where id = 1;
set tidb_translate_softdelete_sql = false;
select id, name from t1 where _tidb_softdelete_time is null order by id;
select id, name from t1 order by id;

# Test DELETE with ORDER BY and LIMIT
set tidb_translate_softdelete_sql = true;
delete from t1 where id > 0 order by id limit 1;
set tidb_translate_softdelete_sql = false;
select id, name from t1 where _tidb_softdelete_time is null;

# Test DELETE all rows
set tidb_translate_softdelete_sql = true;
delete from t1;
set tidb_translate_softdelete_sql = false;
select id, name from t1 where _tidb_softdelete_time is null;
select count(*) from t1;
delete from t1;
select * from t1;
drop table t1;

# Test DELETE with nonclustered primary key
create table t2 (id int primary key nonclustered, val int) softdelete retention 7 day;
insert into t2 values (1, 10), (2, 20), (3, 30);
set tidb_translate_softdelete_sql = true;
delete from t2 where val > 15;
select * from t2 order by id;
set tidb_translate_softdelete_sql = false;
select id, val, _tidb_softdelete_time is not null as is_deleted from t2 order by id;
drop table t2;

# Test multi-table DELETE with soft delete tables
create table t3 (id int primary key, a int) softdelete retention 7 day;
create table t4 (id int primary key, b int) softdelete retention 7 day;
insert into t3 values (1, 1), (2, 2), (3, 3);
insert into t4 values (1, 10), (2, 20), (3, 30);
set tidb_translate_softdelete_sql = true;
delete t3, t4 from t3, t4 where t3.id = t4.id and t3.a = 1;
select id, a from t3 order by id;
select id, b from t4 order by id;
set tidb_translate_softdelete_sql = false;
select id, a from t3 order by id;
select id, b from t4 order by id;
drop table t3, t4;

# Test multi-table DELETE with alias
# create table t5 (id int primary key, val int) softdelete retention 7 day;
# create table t6 (id int primary key, ref_id int) softdelete retention 7 day;
# insert into t5 values (1, 100), (2, 200);
# insert into t6 values (1, 1), (2, 2);
# set tidb_translate_softdelete_sql = true;
# delete a from t5 a join t6 b on a.id = b.ref_id where b.id = 1;
# select id, val from t5 order by id;
# select id, ref_id from t6 order by id;
# set tidb_translate_softdelete_sql = false;
# select id, val from t5;
# select id, ref_id from t6;
# drop table t5, t6;

# Test DELETE with WHERE clause using various conditions
create table t7 (id int primary key, status int, name varchar(50)) softdelete retention 7 day;
insert into t7 values (1, 1, 'active'), (2, 0, 'inactive'), (3, 1, 'active'), (4, 0, 'inactive');
set tidb_translate_softdelete_sql = true;
delete from t7 where status = 0;
select id, status, name from t7 order by id;
set tidb_translate_softdelete_sql = false;
select id, status, name from t7 order by id;
drop table t7;

# Test that tidb_translate_softdelete_sql = false does not rewrite DELETE
create table t8 (id int primary key) softdelete retention 7 day;
insert into t8 values (1), (2), (3);
set tidb_translate_softdelete_sql = false;
delete from t8 where id = 1;
select id from t8 order by id;
set tidb_translate_softdelete_sql = true;
drop table t8;

# Test error when mixing soft delete and non-soft delete tables
create table t_soft (id int primary key) softdelete retention 7 day;
create table t_normal (id int primary key);
insert into t_soft values (1), (2);
insert into t_normal values (1), (2);
-- error 1105
delete t_soft, t_normal from t_soft, t_normal where t_soft.id = t_normal.id;
drop table t_soft, t_normal;

# Test DELETE with subquery in WHERE
create table t9 (id int primary key, category int) softdelete retention 7 day;
create table t10 (category int primary key, active int);
insert into t9 values (1, 1), (2, 1), (3, 2), (4, 2);
insert into t10 values (1, 1), (2, 0);
set tidb_translate_softdelete_sql = true;
delete from t9 where category in (select category from t10 where active = 0);
select * from t9 order by id;
set tidb_translate_softdelete_sql = false;
select id, category from t9 order by id;
drop table t9, t10;

# Test DELETE with index
create table t11 (id int primary key, val int, key idx_val(val)) softdelete retention 7 day;
insert into t11 values (1, 10), (2, 20), (3, 10), (4, 30);
set tidb_translate_softdelete_sql = true;
delete from t11 where val = 10;
select * from t11 order by id;
set tidb_translate_softdelete_sql = false;
select id, val from t11 order by id;
drop table t11;

# Test DELETE with composite primary key
create table t12 (a int, b int, c int, primary key(a, b)) softdelete retention 7 day;
insert into t12 values (1, 1, 100), (1, 2, 200), (2, 1, 300);
set tidb_translate_softdelete_sql = true;
delete from t12 where a = 1 and b = 1;
select * from t12 order by a, b;
set tidb_translate_softdelete_sql = false;
select a, b, c from t12 order by a, b;
drop table t12;

