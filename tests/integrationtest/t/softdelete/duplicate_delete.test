# Test duplicate delete: _tidb_softdelete_time should not change on second delete
create table message (id int primary key, text varchar(10)) softdelete retention 7 day;
set @@tidb_translate_softdelete_sql = true;

insert into message values (1, '24h'), (2, '24h');

# First delete
delete from message where id = 1;
set @@tidb_translate_softdelete_sql = false;
set @ts1 = (select _tidb_softdelete_time from message where id = 1);
select id, _tidb_softdelete_time is not null as is_deleted from message where id = 1;
set @@tidb_translate_softdelete_sql = true;

# Second delete on the same row - should be a no-op since the row is already soft-deleted
delete from message where id = 1;
set @@tidb_translate_softdelete_sql = false;
set @ts2 = (select _tidb_softdelete_time from message where id = 1);
select id, _tidb_softdelete_time is not null as is_deleted from message where id = 1;
# Verify the timestamp did not change
select @ts1 = @ts2 as timestamp_unchanged;
set @@tidb_translate_softdelete_sql = true;

drop table message;

# Test again with nonclustered primary key
create table message (id int primary key nonclustered, text varchar(10)) softdelete retention 7 day;

insert into message values (1, '24h'), (2, '24h');

delete from message where id = 1;
set @@tidb_translate_softdelete_sql = false;
set @ts1 = (select _tidb_softdelete_time from message where id = 1);
select id, _tidb_softdelete_time is not null as is_deleted from message where id = 1;
set @@tidb_translate_softdelete_sql = true;

delete from message where id = 1;
set @@tidb_translate_softdelete_sql = false;
set @ts2 = (select _tidb_softdelete_time from message where id = 1);
select id, _tidb_softdelete_time is not null as is_deleted from message where id = 1;
select @ts1 = @ts2 as timestamp_unchanged;
set @@tidb_translate_softdelete_sql = true;

drop table message;
