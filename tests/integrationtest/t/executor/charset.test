# TestCharsetFeature
set names gbk;
select @@character_set_connection;
select @@collation_connection;
set @@character_set_client=gbk;
select @@character_set_client;
set names utf8mb4;
set @@character_set_connection=gbk;
select @@character_set_connection;
select @@collation_connection;
-- error 1115
select _gbk 'a';
create table t1(a char(10) charset gbk);
create table t2(a char(10) charset gbk collate gbk_bin);
create table t3(a char(10)) charset gbk;
alter table t3 add column b char(10) charset gbk;
show create table t3;
create table t4(a char(10));
alter table t4 add column b char(10) charset gbk;
show create table t4;
create table t5(a char(20), b char(20) charset utf8, c binary) charset gbk collate gbk_bin;
create database test_gbk charset gbk;
use test_gbk;
create table t1(a char(10));
show create table t1;
drop database test_gbk;
use executor__charset;
set names DEFAULT;

# TestCharsetFeatureCollation
drop table if exists t;
create table t(ascii_char char(10) character set ascii,gbk_char char(10) character set gbk collate gbk_bin,latin_char char(10) character set latin1,utf8mb4_char char(10) character set utf8mb4);
insert into t values ('a', 'a', 'a', 'a'), ('a', '啊', '€', 'ㅂ');
select collation(concat(ascii_char, gbk_char)) from t;
select collation(concat(gbk_char, ascii_char)) from t;
select collation(concat(utf8mb4_char, gbk_char)) from t;
select collation(concat(gbk_char, utf8mb4_char)) from t;
select collation(concat('啊', convert('啊' using gbk) collate gbk_bin));
select collation(concat(_latin1 'a', convert('啊' using gbk) collate gbk_bin));
-- error 1267
select collation(concat(latin_char, gbk_char)) from t;
-- error 1267
select collation(concat(convert('€' using latin1), convert('啊' using gbk) collate gbk_bin));
-- error 1267
select collation(concat(utf8mb4_char, gbk_char collate gbk_bin)) from t;
-- error 1267
select collation(concat('ㅂ', convert('啊' using gbk) collate gbk_bin));
-- error 1267
select collation(concat(ascii_char collate ascii_bin, gbk_char)) from t;

# TestCharsetWithPrefixIndex
drop table if exists t;
create table t(a char(20) charset gbk, b char(20) charset gbk, primary key (a(2)));
insert into t values ('a', '中文'), ('中文', '中文'), ('一二三', '一二三'), ('b', '一二三');
--sorted_result
select * from t;
drop table t;
create table t(a char(20) charset gbk, b char(20) charset gbk, unique index idx_a(a(2)));
insert into t values ('a', '中文'), ('中文', '中文'), ('一二三', '一二三'), ('b', '一二三');
--sorted_result
select * from t;

# TestForbidUnsupportedCollations
-- error 1273
select 'a' collate utf8_roman_ci;
-- error 1273
select cast('a' as char) collate utf8_roman_ci;
-- error 1273
set names utf8 collate utf8_roman_ci;
-- error 1273
set session collation_server = 'utf8_roman_ci';
-- error 1273
set session collation_database = 'utf8_roman_ci';
-- error 1273
set session collation_connection = 'utf8_roman_ci';
-- error 1273
set global collation_server = 'utf8_roman_ci';
-- error 1273
set global collation_database = 'utf8_roman_ci';
-- error 1273
set global collation_connection = 'utf8_roman_ci';

# TestCreateTableInvalidCharColl
# Test invalid charsets, invalid collations and invalid combinations in CREATE TABLE
-- error 1115
CREATE TABLE t100 (id INT PRIMARY KEY) CHARACTER SET utf7;
-- error 1273
CREATE TABLE t100 (id INT PRIMARY KEY) COLLATE utf7_modified_ci;
-- error 1253
CREATE TABLE t100 (id INT PRIMARY KEY) CHARACTER SET utf8mb4 COLLATE utf8_general_ci;

# TestTableCollation
# Table collation and charset should follow the schema collation and charset
# https://github.com/pingcap/tidb/issues/58446
CREATE SCHEMA s1 DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
USE s1;
CREATE TABLE t11 (id INT PRIMARY KEY);
CREATE TABLE t12 (id INT PRIMARY KEY) CHARACTER SET utf8;
CREATE TABLE t13 (id INT PRIMARY KEY) CHARACTER SET utf8 COLLATE utf8_general_ci;
CREATE TABLE t14 (id INT PRIMARY KEY) COLLATE utf8_general_ci;
SELECT TABLE_NAME, TABLE_COLLATION FROM information_schema.tables WHERE TABLE_SCHEMA='s1';
DROP SCHEMA s1;

# TestSchemaCharsetAndCollation
CREATE SCHEMA s2;
SHOW CREATE SCHEMA s2;
DROP SCHEMA s2;

CREATE SCHEMA s3 DEFAULT CHARACTER SET ascii;
SHOW CREATE SCHEMA s3;
DROP SCHEMA s3;

CREATE SCHEMA s4 DEFAULT COLLATE ascii_bin;
SHOW CREATE SCHEMA s4;
DROP SCHEMA s4;

CREATE SCHEMA s5 DEFAULT COLLATE utf8mb4_general_ci;
SHOW CREATE SCHEMA s5;
DROP SCHEMA s5;

# TestDefaultUTF8MB4Coll
CREATE SCHEMA s6 COLLATE utf8_unicode_ci;
USE s6;
SET SESSION default_collation_for_utf8mb4='utf8mb4_general_ci';
CREATE TABLE s6t1 (id INT PRIMARY KEY) DEFAULT CHARSET utf8mb4;
CREATE TABLE s6t2 (id INT PRIMARY KEY);
SELECT TABLE_NAME, TABLE_COLLATION FROM information_schema.tables WHERE TABLE_SCHEMA='s6';
DROP SCHEMA s6;
